# Story 10.11: ADK Agent Deployment

## Status

**Draft**

---

## Story

**As a** developer,
**I want** the ADK agent deployed to production alongside the Next.js app,
**so that** chat works reliably in the deployed environment.

---

## Acceptance Criteria

1. Agent Dockerfile for containerized deployment
2. Deployment options evaluated: Vercel Functions (if supported), Railway, Render, or Cloud Run
3. Production environment variables configured securely
4. Health check endpoint monitored by Vercel/deployment platform
5. Agent auto-restarts on failure
6. Logging configured for debugging (structured JSON logs)
7. CORS configured for production Next.js domain
8. Response times <2s in production (NFR2)
9. Documentation: deployment guide in README

---

## Tasks / Subtasks

- [ ] **Task 1: Evaluate Deployment Options** (AC: 2)
  - [ ] Test Google Cloud Run (recommended for ADK)
  - [ ] Evaluate Railway (Python support, easy setup)
  - [ ] Evaluate Render (free tier available)
  - [ ] Compare pricing, latency, and ease of deployment
  - [ ] Document recommendation with reasoning

- [ ] **Task 2: Create Dockerfile** (AC: 1)
  - [ ] Create multi-stage Dockerfile
  - [ ] Use slim Python base image
  - [ ] Install dependencies efficiently
  - [ ] Set up non-root user for security
  - [ ] Configure health check in Dockerfile

- [ ] **Task 3: Configure Cloud Run Deployment** (AC: 2, 4, 5)
  - [ ] Create cloudbuild.yaml for automated builds
  - [ ] Configure Cloud Run service settings
  - [ ] Set min/max instances (0-10 for cost efficiency)
  - [ ] Configure CPU/memory allocation
  - [ ] Enable auto-restart on failure

- [ ] **Task 4: Set Up Environment Variables** (AC: 3)
  - [ ] List all required production env vars
  - [ ] Configure in Cloud Run secrets
  - [ ] Document env var setup process
  - [ ] Set up .env.production.example

- [ ] **Task 5: Configure Logging** (AC: 6)
  - [ ] Add structured JSON logging
  - [ ] Configure log levels (INFO for prod)
  - [ ] Add request ID tracking
  - [ ] Set up log aggregation (Cloud Logging)

- [ ] **Task 6: Configure CORS** (AC: 7)
  - [ ] Add production domain to CORS allowed origins
  - [ ] Support Vercel preview URLs (*.vercel.app)
  - [ ] Test CORS from production frontend

- [ ] **Task 7: Performance Testing** (AC: 8)
  - [ ] Test cold start time (<5s target)
  - [ ] Test warm response time (<2s target)
  - [ ] Load test with concurrent requests
  - [ ] Document performance characteristics

- [ ] **Task 8: Write Deployment Documentation** (AC: 9)
  - [ ] Create deployment section in README
  - [ ] Document step-by-step deployment process
  - [ ] Include troubleshooting guide
  - [ ] Add CI/CD setup instructions

---

## Technical Implementation Notes

### Dockerfile
```dockerfile
# agents/tribe_agent/Dockerfile
# Build stage
FROM python:3.11-slim as builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Production stage
FROM python:3.11-slim

WORKDIR /app

# Create non-root user
RUN useradd --create-home --shell /bin/bash appuser

# Copy installed packages from builder
COPY --from=builder /root/.local /home/appuser/.local

# Copy application code
COPY --chown=appuser:appuser . .

# Switch to non-root user
USER appuser

# Add local packages to PATH
ENV PATH=/home/appuser/.local/bin:$PATH

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8000/health', timeout=5).raise_for_status()"

# Run the application
CMD ["uvicorn", "server:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Cloud Build Configuration
```yaml
# agents/tribe_agent/cloudbuild.yaml
steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/tribe-agent:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/tribe-agent:latest'
      - '.'
    dir: 'agents/tribe_agent'

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/tribe-agent:$COMMIT_SHA']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/tribe-agent:latest']

  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'tribe-agent'
      - '--image=gcr.io/$PROJECT_ID/tribe-agent:$COMMIT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--timeout=60s'
      - '--concurrency=80'
      - '--set-env-vars=ENVIRONMENT=production'
      - '--set-secrets=GEMINI_API_KEY=gemini-api-key:latest,CONVEX_SITE_URL=convex-site-url:latest'

images:
  - 'gcr.io/$PROJECT_ID/tribe-agent:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/tribe-agent:latest'

options:
  logging: CLOUD_LOGGING_ONLY
```

### Structured Logging
```python
# agents/tribe_agent/logging_config.py
import logging
import json
import sys
from datetime import datetime
from typing import Any

class JSONFormatter(logging.Formatter):
    """JSON formatter for structured logging."""

    def format(self, record: logging.LogRecord) -> str:
        log_record = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "message": record.getMessage(),
            "logger": record.name,
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
        }

        # Add extra fields
        if hasattr(record, "request_id"):
            log_record["request_id"] = record.request_id
        if hasattr(record, "user_id"):
            log_record["user_id"] = record.user_id
        if hasattr(record, "duration_ms"):
            log_record["duration_ms"] = record.duration_ms

        # Add exception info
        if record.exc_info:
            log_record["exception"] = self.formatException(record.exc_info)

        return json.dumps(log_record)

def setup_logging(level: str = "INFO"):
    """Configure structured JSON logging."""
    handler = logging.StreamHandler(sys.stdout)
    handler.setFormatter(JSONFormatter())

    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, level.upper()))
    root_logger.handlers = [handler]

    return root_logger
```

### Server with Logging and CORS
```python
# agents/tribe_agent/server.py
import os
import time
import uuid
from contextlib import asynccontextmanager
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from google.adk.runners import FastAPIRunner
from agent import tribe_agent
from logging_config import setup_logging

# Setup logging
logger = setup_logging(os.environ.get("LOG_LEVEL", "INFO"))

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info("Starting TRIBE ADK Agent")
    yield
    logger.info("Shutting down TRIBE ADK Agent")

app = FastAPI(
    title="TRIBE ADK Agent",
    version="1.0.0",
    lifespan=lifespan
)

# CORS configuration
ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "https://tribe-ai.vercel.app",
    "https://*.vercel.app",  # Vercel preview deployments
]

if os.environ.get("ADDITIONAL_CORS_ORIGINS"):
    ALLOWED_ORIGINS.extend(os.environ["ADDITIONAL_CORS_ORIGINS"].split(","))

app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Request logging middleware
@app.middleware("http")
async def log_requests(request: Request, call_next):
    request_id = str(uuid.uuid4())[:8]
    start_time = time.time()

    logger.info(
        f"Request started",
        extra={"request_id": request_id, "path": request.url.path, "method": request.method}
    )

    response = await call_next(request)

    duration_ms = (time.time() - start_time) * 1000
    logger.info(
        f"Request completed",
        extra={"request_id": request_id, "status": response.status_code, "duration_ms": round(duration_ms, 2)}
    )

    response.headers["X-Request-ID"] = request_id
    return response

# Mount AG-UI endpoint
runner = FastAPIRunner(agent=tribe_agent)
app.include_router(runner.router, prefix="/agui")

@app.get("/health")
async def health():
    return {
        "status": "ok",
        "agent": "tribe_agent",
        "model": "gemini-2.5-flash",
        "environment": os.environ.get("ENVIRONMENT", "development"),
    }

@app.get("/")
async def root():
    return {"message": "TRIBE ADK Agent", "docs": "/docs"}
```

### Environment Variables
```bash
# agents/tribe_agent/.env.production.example
# Required
GEMINI_API_KEY=your_gemini_api_key
CONVEX_SITE_URL=https://your-deployment.convex.site

# Optional
ENVIRONMENT=production
LOG_LEVEL=INFO
ADDITIONAL_CORS_ORIGINS=https://custom-domain.com
```

### README Deployment Section
```markdown
## Deployment

### Prerequisites
- Google Cloud account with billing enabled
- `gcloud` CLI installed and configured
- Cloud Run API enabled

### Steps

1. **Create secrets in Google Secret Manager:**
   ```bash
   gcloud secrets create gemini-api-key --data-file=- <<< "YOUR_API_KEY"
   gcloud secrets create convex-site-url --data-file=- <<< "YOUR_CONVEX_URL"
   ```

2. **Deploy using Cloud Build:**
   ```bash
   gcloud builds submit --config=cloudbuild.yaml
   ```

3. **Get the deployed URL:**
   ```bash
   gcloud run services describe tribe-agent --region=us-central1 --format='value(status.url)'
   ```

4. **Update Vercel environment:**
   Add `ADK_AGENT_URL` to Vercel project settings with the Cloud Run URL.

### Manual Deployment
```bash
# Build locally
docker build -t tribe-agent .

# Test locally
docker run -p 8000:8000 --env-file .env tribe-agent

# Push to GCR
docker tag tribe-agent gcr.io/YOUR_PROJECT/tribe-agent
docker push gcr.io/YOUR_PROJECT/tribe-agent

# Deploy to Cloud Run
gcloud run deploy tribe-agent \
  --image gcr.io/YOUR_PROJECT/tribe-agent \
  --region us-central1 \
  --allow-unauthenticated
```
```

---

## Dependencies

- **Upstream**: Story 10.1 (ADK Agent Backend)
- **Infrastructure**: Google Cloud Run, Container Registry, Secret Manager
- **CI/CD**: Cloud Build or GitHub Actions

---

## Testing Strategy

### Test Cases

1. **Docker Build**:
   - Image builds successfully
   - Image size is reasonable (<500MB)
   - Health check works in container

2. **Cloud Run Deployment**:
   - Deploy completes without errors
   - Service starts successfully
   - Health endpoint returns 200

3. **Environment Variables**:
   - Secrets loaded correctly
   - Application starts with all required vars
   - Missing vars fail gracefully

4. **CORS**:
   - Production domain allowed
   - Vercel preview URLs allowed
   - Invalid origins rejected

5. **Performance**:
   - Cold start <5s
   - Warm response <2s
   - Concurrent requests handled

6. **Logging**:
   - JSON logs in Cloud Logging
   - Request IDs tracked
   - Errors include stack traces
