# Story 10.7: Generative UI for Tool Rendering

## Status

**Draft**

---

## Story

**As a** user,
**I want** rich visual cards displayed when the AI searches for resources,
**so that** results are easy to scan and interact with.

---

## Acceptance Criteria

1. `useRenderToolCall` hook configured for all ADK tools: searchHousingResources, searchLiveData, searchVisaOptions
2. Each tool has custom React component: HousingCard, LiveSearchCard, VisaCard
3. Components use RetroUI neobrutalist styling matching app design
4. Loading states show descriptive progress: "Searching 50+ countries...", "Checking visa requirements..."
5. Error states render gracefully with retry button
6. `useDefaultTool` catches any unmapped tools with generic card
7. Cards include inline action buttons: "Save", "Share", "Learn More"
8. Tool renders tested across all supported tools

---

## Tasks / Subtasks

- [ ] **Task 1: Create Tool Renderer Registry** (AC: 1, 6)
  - [ ] Create `components/chat/ToolRenderers.tsx`
  - [ ] Register `useRenderToolCall` for each tool
  - [ ] Add `useDefaultTool` fallback for unknown tools
  - [ ] Export as single provider component

- [ ] **Task 2: Consolidate Card Components** (AC: 2, 3)
  - [ ] Move/create `HousingResourcesCard` (from 10.3)
  - [ ] Move/create `LiveSearchCard` (from 10.4)
  - [ ] Move/create `VisaPathwayCard` (from 10.5)
  - [ ] Create `GenericToolCard` for fallback
  - [ ] Ensure consistent RetroUI styling across all

- [ ] **Task 3: Create Loading States** (AC: 4)
  - [ ] Create `ToolLoadingState` component
  - [ ] Accept tool name and args for custom messages
  - [ ] Add animated progress indicator
  - [ ] Messages:
    - Housing: "Searching housing resources in {country}..."
    - Live: "Searching live data for {query}..."
    - Visa: "Checking visa requirements for {origin} → {destination}..."

- [ ] **Task 4: Create Error States** (AC: 5)
  - [ ] Create `ToolErrorCard` component
  - [ ] Display error message from tool result
  - [ ] Add "Retry" button that re-triggers query
  - [ ] Add "Try different search" suggestion
  - [ ] Style with warning colors (RetroUI orange/red)

- [ ] **Task 5: Add Action Buttons** (AC: 7)
  - [ ] Add "Save" button to cards → saves to vault
  - [ ] Add "Share" button → copies link or opens share modal
  - [ ] Add "Learn More" → expands details or navigates
  - [ ] Connect buttons to Convex mutations

- [ ] **Task 6: Integration Testing** (AC: 8)
  - [ ] Test housing search renders correctly
  - [ ] Test live search renders correctly
  - [ ] Test visa search renders correctly
  - [ ] Test unknown tool uses generic card
  - [ ] Test error states display properly
  - [ ] Test action buttons work

---

## Technical Implementation Notes

### Tool Renderer Registry
```typescript
// components/chat/ToolRenderers.tsx
"use client";

import {
  useRenderToolCall,
  useDefaultTool,
} from "@copilotkit/react-core";
import { HousingResourcesCard } from "./HousingResourcesCard";
import { LiveSearchCard, QuotaExceededCard } from "./LiveSearchCard";
import { VisaPathwayCard } from "./VisaPathwayCard";
import { ToolLoadingState } from "./ToolLoadingState";
import { ToolErrorCard } from "./ToolErrorCard";
import { GenericToolCard } from "./GenericToolCard";

export function ToolRenderers() {
  // Housing Search
  useRenderToolCall({
    name: "search_housing_resources",
    render: ({ status, args, result }) => {
      if (status === "inProgress") {
        return (
          <ToolLoadingState
            tool="housing"
            message={`Searching housing resources${args.country ? ` in ${args.country}` : ""}...`}
          />
        );
      }

      if (status === "complete") {
        if (result?.error) {
          return <ToolErrorCard error={result.message} tool="housing" />;
        }
        if (result?.suggestion) {
          return <LiveSearchPrompt suggestion={result.suggestion} />;
        }
        return (
          <HousingResourcesCard
            results={result.results}
            totalFound={result.total_found}
          />
        );
      }

      return null;
    },
  });

  // Live Data Search
  useRenderToolCall({
    name: "search_live_data",
    render: ({ status, args, result }) => {
      if (status === "inProgress") {
        return (
          <ToolLoadingState
            tool="live"
            message={`Searching live data: "${args.query?.slice(0, 50)}..."...`}
          />
        );
      }

      if (status === "complete") {
        if (result?.error) {
          if (result.quotaStatus) {
            return <QuotaExceededCard daysUntilReset={result.quotaStatus.daysUntilReset} />;
          }
          return <ToolErrorCard error={result.message} tool="live" />;
        }
        return <LiveSearchCard result={result} />;
      }

      return null;
    },
  });

  // Visa Options Search
  useRenderToolCall({
    name: "search_visa_options",
    render: ({ status, args, result }) => {
      if (status === "inProgress") {
        return (
          <ToolLoadingState
            tool="visa"
            message={`Checking visa requirements: ${args.origin} → ${args.destination}...`}
          />
        );
      }

      if (status === "complete") {
        if (result?.error) {
          return <ToolErrorCard error={result.message} tool="visa" />;
        }
        return <VisaPathwayCard result={result} />;
      }

      return null;
    },
  });

  // Default fallback for unknown tools
  useDefaultTool({
    render: ({ name, status, args, result }) => {
      if (status === "inProgress") {
        return <ToolLoadingState tool="generic" message={`Running ${name}...`} />;
      }

      if (status === "complete") {
        return <GenericToolCard name={name} result={result} />;
      }

      return null;
    },
  });

  return null; // This component just registers hooks
}
```

### Loading State Component
```typescript
// components/chat/ToolLoadingState.tsx
"use client";

import { Loader2, Home, Globe, Plane } from "lucide-react";

interface ToolLoadingStateProps {
  tool: "housing" | "live" | "visa" | "generic";
  message: string;
}

const toolIcons = {
  housing: Home,
  live: Globe,
  visa: Plane,
  generic: Loader2,
};

const toolColors = {
  housing: "bg-yellow-100",
  live: "bg-green-100",
  visa: "bg-purple-100",
  generic: "bg-gray-100",
};

export function ToolLoadingState({ tool, message }: ToolLoadingStateProps) {
  const Icon = toolIcons[tool];

  return (
    <div className={`border-2 border-black p-4 ${toolColors[tool]} flex items-center gap-3`}>
      <div className="relative">
        <Icon className="w-5 h-5" />
        <Loader2 className="w-3 h-3 absolute -bottom-1 -right-1 animate-spin" />
      </div>
      <span className="font-medium">{message}</span>
    </div>
  );
}
```

### Error State Component
```typescript
// components/chat/ToolErrorCard.tsx
"use client";

import { AlertCircle, RefreshCw } from "lucide-react";
import { useCopilotAction } from "@copilotkit/react-core";

interface ToolErrorCardProps {
  error: string;
  tool: string;
}

export function ToolErrorCard({ error, tool }: ToolErrorCardProps) {
  // Retry functionality would need to be implemented based on CopilotKit patterns

  return (
    <div className="border-4 border-black p-4 bg-red-100 shadow-[4px_4px_0_0_#000]">
      <div className="flex items-center gap-2 mb-2">
        <AlertCircle className="w-5 h-5 text-red-600" />
        <h3 className="font-bold">Search Error</h3>
      </div>
      <p className="text-sm mb-3">{error}</p>
      <button
        className="flex items-center gap-1 px-3 py-1 border-2 border-black bg-white hover:bg-gray-100 text-sm font-bold"
        onClick={() => {
          // Trigger retry - could use CopilotKit's action system
          console.log(`Retry ${tool} search`);
        }}
      >
        <RefreshCw className="w-3 h-3" />
        Try Again
      </button>
    </div>
  );
}
```

### Generic Tool Card
```typescript
// components/chat/GenericToolCard.tsx
"use client";

import { Wrench } from "lucide-react";

interface GenericToolCardProps {
  name: string;
  result: any;
}

export function GenericToolCard({ name, result }: GenericToolCardProps) {
  return (
    <div className="border-2 border-black p-4 bg-gray-100">
      <div className="flex items-center gap-2 mb-2">
        <Wrench className="w-4 h-4" />
        <span className="font-bold text-sm">{name}</span>
      </div>
      <pre className="text-xs bg-white p-2 border border-gray-300 overflow-auto max-h-40">
        {JSON.stringify(result, null, 2)}
      </pre>
    </div>
  );
}
```

### Action Buttons Component
```typescript
// components/chat/CardActions.tsx
"use client";

import { Save, Share2, ExternalLink } from "lucide-react";
import { useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { toast } from "sonner";

interface CardActionsProps {
  saveData?: {
    title: string;
    url?: string;
    content?: string;
    type: "housing" | "visa" | "resource";
  };
  shareUrl?: string;
  learnMoreUrl?: string;
}

export function CardActions({ saveData, shareUrl, learnMoreUrl }: CardActionsProps) {
  const saveDocument = useMutation(api.documents.saveDocument);

  const handleSave = async () => {
    if (!saveData) return;
    try {
      await saveDocument({
        title: saveData.title,
        url: saveData.url,
        content: saveData.content,
        type: saveData.type,
      });
      toast.success("Saved to your vault!");
    } catch (error) {
      toast.error("Failed to save");
    }
  };

  const handleShare = async () => {
    if (shareUrl) {
      await navigator.clipboard.writeText(shareUrl);
      toast.success("Link copied!");
    }
  };

  return (
    <div className="flex gap-2 mt-3 pt-3 border-t-2 border-black">
      {saveData && (
        <button
          onClick={handleSave}
          className="flex items-center gap-1 px-2 py-1 border-2 border-black bg-white hover:bg-gray-100 text-xs font-bold"
        >
          <Save className="w-3 h-3" />
          Save
        </button>
      )}
      {shareUrl && (
        <button
          onClick={handleShare}
          className="flex items-center gap-1 px-2 py-1 border-2 border-black bg-white hover:bg-gray-100 text-xs font-bold"
        >
          <Share2 className="w-3 h-3" />
          Share
        </button>
      )}
      {learnMoreUrl && (
        <a
          href={learnMoreUrl}
          target="_blank"
          rel="noopener noreferrer"
          className="flex items-center gap-1 px-2 py-1 border-2 border-black bg-white hover:bg-gray-100 text-xs font-bold"
        >
          <ExternalLink className="w-3 h-3" />
          Learn More
        </a>
      )}
    </div>
  );
}
```

---

## Dependencies

- **Upstream**: Stories 10.3, 10.4, 10.5 (tool implementations)
- **CopilotKit**: useRenderToolCall, useDefaultTool hooks
- **UI**: RetroUI components, Lucide icons

---

## Testing Strategy

### Test Cases

1. **Housing Search**:
   - Loading shows housing icon and message
   - Results render in HousingResourcesCard
   - Empty results show suggestion
   - Error shows ToolErrorCard

2. **Live Search**:
   - Loading shows globe icon
   - Results show answer and sources
   - Quota exceeded shows special card
   - Error handled gracefully

3. **Visa Search**:
   - Loading shows plane icon with countries
   - Results show visa details
   - Error with suggestions works

4. **Generic Fallback**:
   - Unknown tool uses GenericToolCard
   - JSON displayed correctly
   - No crashes on unexpected data

5. **Action Buttons**:
   - Save works and shows toast
   - Share copies link
   - Learn More opens in new tab

6. **Styling**:
   - All cards match RetroUI aesthetic
   - Consistent border and shadow styles
   - Responsive on mobile
