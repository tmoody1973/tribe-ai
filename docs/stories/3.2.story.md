# Story 3.2: Protocol Cards Display

## Status

**Complete**

---

## Story

**As a** user,
**I want** to see my arrival protocol as actionable cards,
**so that** I know exactly what to do and in what order.

---

## Acceptance Criteria

1. Protocol steps displayed as vertical sequence of cards
2. Each card shows: step number, title, description, time estimate
3. Cards show warnings highlighted in alert style
4. Cards show hacks/tips highlighted in success style
5. Cards are expandable for full details
6. Card order reflects dependency sequence
7. Current/next step visually emphasized

---

## Tasks / Subtasks

- [x] **Task 1: Create Protocol Card Component** (AC: 2, 5)
  - [x] Create `components/protocol/ProtocolCard.tsx`
  - [x] Display step number, title, description
  - [x] Add expand/collapse functionality
  - [x] Style with RetroUI card pattern
  - [x] Add category icon/color

- [x] **Task 2: Create Protocol List Component** (AC: 1, 6)
  - [x] Create `components/protocol/ProtocolList.tsx`
  - [x] Render cards in order (by `order` field)
  - [x] Add connecting line between cards (timeline style)
  - [x] Handle empty state

- [x] **Task 3: Add Warning Display** (AC: 3)
  - [x] Create warning section in ProtocolCard
  - [x] Style with red/orange alert colors
  - [x] Show warning icon (‚ö†Ô∏è)
  - [x] Expand to show all warnings

- [x] **Task 4: Add Hacks/Tips Display** (AC: 4)
  - [x] Create tips section in ProtocolCard
  - [x] Style with green success colors
  - [x] Show lightbulb icon (üí°)
  - [x] Expand to show all tips

- [x] **Task 5: Implement Current Step Emphasis** (AC: 7)
  - [x] Detect current step (first incomplete)
  - [x] Add visual emphasis (larger, glowing border)
  - [x] Show "Current Step" badge
  - [ ] Scroll to current step on load (deferred)

- [x] **Task 6: Add Category Styling** (AC: 2)
  - [x] Define colors per category (visa, finance, housing, etc.)
  - [x] Add category badge to each card
  - [x] Icon per category

- [x] **Task 7: Add Protocol Translations** (AC: 2)
  - [x] Add category names to locale files
  - [x] Add priority labels
  - [x] Add status labels

---

## Dev Notes

### Protocol Card Component
[Source: architecture.md#components]

```typescript
// components/protocol/ProtocolCard.tsx
"use client";

import { useState } from "react";
import { useTranslations } from "next-intl";
import { Doc } from "@/convex/_generated/dataModel";
import { ChevronDown, ChevronUp, AlertTriangle, Lightbulb } from "lucide-react";

interface ProtocolCardProps {
  protocol: Doc<"protocols">;
  isCurrent: boolean;
  onStatusChange?: (status: string) => void;
}

const categoryColors: Record<string, string> = {
  visa: "border-l-purple-500 bg-purple-50",
  finance: "border-l-green-500 bg-green-50",
  housing: "border-l-blue-500 bg-blue-50",
  employment: "border-l-orange-500 bg-orange-50",
  legal: "border-l-red-500 bg-red-50",
  health: "border-l-pink-500 bg-pink-50",
  social: "border-l-cyan-500 bg-cyan-50",
};

const categoryIcons: Record<string, string> = {
  visa: "üõÇ",
  finance: "üí∞",
  housing: "üè†",
  employment: "üíº",
  legal: "‚öñÔ∏è",
  health: "üè•",
  social: "üë•",
};

export function ProtocolCard({ protocol, isCurrent, onStatusChange }: ProtocolCardProps) {
  const [expanded, setExpanded] = useState(isCurrent);
  const t = useTranslations("protocols");

  const isCompleted = protocol.status === "completed";
  const hasWarnings = protocol.warnings && protocol.warnings.length > 0;
  const hasHacks = protocol.hacks && protocol.hacks.length > 0;

  return (
    <div
      className={`
        border-4 border-black border-l-8 shadow-[4px_4px_0_0_#000]
        transition-all duration-200
        ${categoryColors[protocol.category] ?? "bg-white"}
        ${isCurrent ? "ring-4 ring-yellow-400 ring-offset-2" : ""}
        ${isCompleted ? "opacity-60" : ""}
      `}
    >
      {/* Header */}
      <div
        className="p-4 cursor-pointer flex items-start gap-4"
        onClick={() => setExpanded(!expanded)}
      >
        {/* Step Number */}
        <div
          className={`
            w-10 h-10 flex items-center justify-center
            border-2 border-black font-bold text-lg
            ${isCompleted ? "bg-green-500 text-white" : "bg-white"}
          `}
        >
          {isCompleted ? "‚úì" : protocol.order}
        </div>

        {/* Content */}
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <span>{categoryIcons[protocol.category]}</span>
            <span className="text-xs font-bold uppercase text-gray-500">
              {t(`categories.${protocol.category}`)}
            </span>
            {isCurrent && (
              <span className="bg-yellow-400 text-black text-xs font-bold px-2 py-0.5">
                {t("currentStep")}
              </span>
            )}
          </div>
          <h3 className={`font-bold text-lg ${isCompleted ? "line-through" : ""}`}>
            {protocol.title}
          </h3>
          {!expanded && (
            <p className="text-gray-600 text-sm line-clamp-2">
              {protocol.description}
            </p>
          )}
        </div>

        {/* Expand Icon */}
        <button className="p-1">
          {expanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
      </div>

      {/* Expanded Content */}
      {expanded && (
        <div className="px-4 pb-4 border-t-2 border-black pt-4">
          {/* Full Description */}
          <p className="text-gray-700 mb-4">{protocol.description}</p>

          {/* Warnings */}
          {hasWarnings && (
            <div className="bg-red-100 border-2 border-red-500 p-3 mb-3">
              <div className="flex items-center gap-2 font-bold text-red-700 mb-2">
                <AlertTriangle size={18} />
                {t("warnings")}
              </div>
              <ul className="list-disc list-inside text-red-700 text-sm space-y-1">
                {protocol.warnings!.map((warning, i) => (
                  <li key={i}>{warning}</li>
                ))}
              </ul>
            </div>
          )}

          {/* Hacks/Tips */}
          {hasHacks && (
            <div className="bg-green-100 border-2 border-green-500 p-3 mb-3">
              <div className="flex items-center gap-2 font-bold text-green-700 mb-2">
                <Lightbulb size={18} />
                {t("tips")}
              </div>
              <ul className="list-disc list-inside text-green-700 text-sm space-y-1">
                {protocol.hacks!.map((hack, i) => (
                  <li key={i}>{hack}</li>
                ))}
              </ul>
            </div>
          )}

          {/* Priority Badge */}
          <div className="flex items-center justify-between mt-4">
            <PriorityBadge priority={protocol.priority} />
          </div>
        </div>
      )}
    </div>
  );
}

function PriorityBadge({ priority }: { priority: string }) {
  const colors: Record<string, string> = {
    critical: "bg-red-500 text-white",
    high: "bg-orange-500 text-white",
    medium: "bg-yellow-400 text-black",
    low: "bg-gray-300 text-black",
  };

  const t = useTranslations("protocols.priorities");

  return (
    <span className={`px-2 py-1 text-xs font-bold ${colors[priority] ?? colors.medium}`}>
      {t(priority)}
    </span>
  );
}
```

### Protocol List Component
```typescript
// components/protocol/ProtocolList.tsx
"use client";

import { Doc } from "@/convex/_generated/dataModel";
import { ProtocolCard } from "./ProtocolCard";
import { useTranslations } from "next-intl";

interface ProtocolListProps {
  protocols: Doc<"protocols">[];
  corridorId: string;
}

export function ProtocolList({ protocols, corridorId }: ProtocolListProps) {
  const t = useTranslations("protocols");

  // Sort by order
  const sorted = [...protocols].sort((a, b) => a.order - b.order);

  // Find current step (first non-completed)
  const currentIndex = sorted.findIndex((p) => p.status !== "completed");

  if (sorted.length === 0) {
    return (
      <div className="border-4 border-black bg-gray-50 p-8 text-center">
        <p className="text-gray-600">{t("noProtocols")}</p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-bold">{t("yourProtocol")}</h2>
        <span className="text-sm text-gray-600">
          {sorted.filter((p) => p.status === "completed").length} / {sorted.length} {t("completed")}
        </span>
      </div>

      {/* Protocol Cards */}
      <div className="relative">
        {/* Timeline Line */}
        <div className="absolute left-7 top-0 bottom-0 w-0.5 bg-black" />

        {/* Cards */}
        <div className="space-y-4 relative">
          {sorted.map((protocol, index) => (
            <ProtocolCard
              key={protocol._id}
              protocol={protocol}
              isCurrent={index === currentIndex}
            />
          ))}
        </div>
      </div>
    </div>
  );
}
```

### Translation Keys
```json
// messages/en.json - Add protocols section
{
  "protocols": {
    "yourProtocol": "Your Arrival Protocol",
    "completed": "completed",
    "noProtocols": "No protocols yet. Research in progress...",
    "currentStep": "Current Step",
    "warnings": "Warnings",
    "tips": "Pro Tips",
    "categories": {
      "visa": "Visa",
      "finance": "Finance",
      "housing": "Housing",
      "employment": "Employment",
      "legal": "Legal",
      "health": "Health",
      "social": "Social"
    },
    "priorities": {
      "critical": "Critical",
      "high": "High Priority",
      "medium": "Medium",
      "low": "Low Priority"
    }
  }
}
```

### File Structure
```
components/
‚îî‚îÄ‚îÄ protocol/
    ‚îú‚îÄ‚îÄ ProtocolCard.tsx
    ‚îú‚îÄ‚îÄ ProtocolList.tsx
    ‚îî‚îÄ‚îÄ PriorityBadge.tsx
```

### Dependencies from Previous Stories
- Story 2.1: Protocols table and types
- Story 3.1: Dashboard page integration

---

## Testing

### Test Scenarios

1. **Card Display**
   - [ ] Cards show step number, title, description
   - [ ] Category icon and color applied
   - [ ] Priority badge visible

2. **Expand/Collapse**
   - [ ] Click card to expand
   - [ ] Full description visible when expanded
   - [ ] Warnings and tips visible when expanded

3. **Current Step**
   - [ ] First incomplete step highlighted
   - [ ] "Current Step" badge visible
   - [ ] Yellow ring emphasis

4. **Completed Steps**
   - [ ] Checkmark instead of number
   - [ ] Strikethrough on title
   - [ ] Reduced opacity

5. **Timeline**
   - [ ] Vertical line connects cards
   - [ ] Cards in correct order

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List
- ProtocolCard component with expand/collapse, category colors, and priority badges
- Warnings displayed in red alert box with AlertTriangle icon
- Tips displayed in green success box with Lightbulb icon
- Current step emphasized with yellow ring and "Current Step" badge
- Timeline vertical line connecting protocol cards
- All 9 locales updated with protocol translations

### File List
- `components/protocol/ProtocolCard.tsx` - NEW: Expandable protocol card with all features
- `components/protocol/ProtocolList.tsx` - UPDATED: Timeline style with current step detection
- `messages/*.json` - All 9 locales updated with protocols section

---

## QA Results
*To be filled by QA Agent*
