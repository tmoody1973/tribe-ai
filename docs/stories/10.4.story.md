# Story 10.4: Migrate Live Data Search Tool to ADK

## Status

**Completed**

---

## Story

**As a** user,
**I want** live web searches for migration resources via ADK agent,
**so that** I get up-to-date information with proper quota management.

---

## Acceptance Criteria

1. Create `searchLiveData` tool in ADK agent with parameters: query, targetCountry
2. Tool checks Fireplexity quota via Convex query before executing
3. If quota exceeded, returns helpful message with days until reset
4. Executes Perplexity API search via Convex action
5. Returns structured response: answer, sources, scrapedData preview, quotaRemaining
6. Tool handles errors gracefully with fallback message
7. Frontend renders live search results with source attribution
8. Quota status displayed: "X of 50 monthly searches remaining"

---

## Tasks / Subtasks

- [x] **Task 1: Create Convex HTTP Endpoints** (AC: 2, 4)
  - [x] Create `convex/http.ts` endpoint for quota check: GET /api/fireplexity/quota
  - [x] Create `convex/http.ts` endpoint for search: POST /api/fireplexity/search
  - [x] Endpoints call existing Convex queries/actions
  - [x] Add CORS headers for cross-origin requests

- [x] **Task 2: Create Live Search Tool** (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `agents/tribe_agent/tools/live_search.py`
  - [x] Define `search_live_data` function with FunctionTool
  - [x] Parameters: query (str, required), target_country (str, optional)
  - [x] Check quota via HTTP call to Convex
  - [x] If quota exceeded, return error with reset info
  - [x] Execute Fireplexity search via Convex HTTP action
  - [x] Parse and return structured response
  - [x] Handle all error cases gracefully

- [x] **Task 3: Register Tool with Agent** (AC: 1)
  - [x] Import live search tool in agent.py
  - [x] Add to agent's tools list
  - [x] Add tool description emphasizing quota usage

- [x] **Task 4: Create Frontend Components** (AC: 7, 8)
  - [x] Create `components/chat/LiveSearchCard.tsx`
  - [x] Display AI-generated answer
  - [x] Show sources with clickable links
  - [x] Show scraped data previews (expandable)
  - [x] Display quota remaining badge
  - [x] Create `QuotaExceededCard` component
  - [x] Create `LiveSearchLoading` component
  - [x] Create `LiveSearchErrorCard` component

- [x] **Task 5: Register Tool Renderer** (AC: 7)
  - [x] Add `useCopilotAction` hook with `available: "remote"` for `search_live_data`
  - [x] Handle inProgress with animated search indicator
  - [x] Handle complete with LiveSearchCard
  - [x] Handle error with QuotaExceededCard or error message

- [x] **Task 6: Test End-to-End** (AC: all)
  - [x] Build passes with all new components
  - [x] Frontend renderers registered correctly

---

## Technical Implementation Notes

### Convex HTTP Endpoints
```typescript
// convex/http.ts - add to existing http router

// Quota check endpoint
http.route({
  path: "/api/fireplexity/quota",
  method: "GET",
  handler: httpAction(async (ctx) => {
    const quota = await ctx.runQuery(api.fireplexityQueries.checkFireplexityQuota);
    return new Response(JSON.stringify(quota), {
      headers: { "Content-Type": "application/json" }
    });
  }),
});

// Search endpoint
http.route({
  path: "/api/fireplexity/search",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    const { query, targetCountry } = await request.json();

    try {
      const result = await ctx.runAction(api.fireplexity.fireplexitySearch, {
        query,
        targetCountry,
      });
      return new Response(JSON.stringify(result), {
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      return new Response(JSON.stringify({ error: String(error) }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
  }),
});
```

### Live Search Tool (Python)
```python
# agents/tribe_agent/tools/live_search.py
import os
import httpx
from google.adk.tools import FunctionTool

CONVEX_SITE_URL = os.environ.get("CONVEX_SITE_URL", "")

@FunctionTool
async def search_live_data(
    query: str,
    target_country: str = None
) -> dict:
    """
    Search live web data for up-to-date migration resources, visa updates,
    housing programs, and policy changes.

    IMPORTANT: This uses limited monthly quota (50 searches/month).
    Only use when:
    - User explicitly requests current/latest information
    - Static data search returned no results
    - Information needs to be verified as current

    Args:
        query: Search query (e.g., 'housing programs in Berlin 2025')
        target_country: Optional country to focus the search

    Returns:
        dict with answer, sources, scraped data, and quota status
    """
    async with httpx.AsyncClient(timeout=30.0) as client:
        # Check quota first
        try:
            quota_response = await client.get(f"{CONVEX_SITE_URL}/api/fireplexity/quota")
            quota = quota_response.json()

            if not quota.get("available", False):
                return {
                    "error": True,
                    "message": f"Live search quota exceeded ({quota['used']}/{quota['limit']} used). Quota resets in {quota['daysUntilReset']} days.",
                    "quotaStatus": quota
                }
        except Exception as e:
            return {
                "error": True,
                "message": f"Could not check quota: {str(e)}. Please try again."
            }

        # Execute search
        try:
            search_response = await client.post(
                f"{CONVEX_SITE_URL}/api/fireplexity/search",
                json={"query": query, "targetCountry": target_country}
            )
            result = search_response.json()

            if result.get("error"):
                return result

            return {
                "success": True,
                "answer": result.get("answer", ""),
                "sources": result.get("sources", []),
                "scrapedData": [
                    {
                        "url": s.get("url"),
                        "title": s.get("title"),
                        "preview": s.get("markdown", "")[:500] + "..."
                    }
                    for s in result.get("scrapedData", [])
                ],
                "dataFreshness": result.get("dataFreshness"),
                "quotaRemaining": result.get("quotaStatus", {}).get("remaining", 0),
                "quotaUsed": result.get("quotaStatus", {}).get("used", 0),
                "quotaLimit": result.get("quotaStatus", {}).get("limit", 50)
            }
        except httpx.TimeoutException:
            return {
                "error": True,
                "message": "Search timed out. Please try a more specific query."
            }
        except Exception as e:
            return {
                "error": True,
                "message": f"Search failed: {str(e)}. Please try again."
            }
```

### Frontend Card Component
```typescript
// components/chat/LiveSearchCard.tsx
"use client";

import { Globe, ExternalLink, Clock, AlertCircle } from "lucide-react";

interface LiveSearchResult {
  success: boolean;
  answer: string;
  sources: Array<{ url: string; title?: string }>;
  scrapedData?: Array<{ url: string; title: string; preview: string }>;
  quotaRemaining: number;
  quotaLimit: number;
}

export function LiveSearchCard({ result }: { result: LiveSearchResult }) {
  return (
    <div className="border-4 border-black p-4 bg-green-100 shadow-[4px_4px_0_0_#000]">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Globe className="w-5 h-5" />
          <h3 className="font-bold text-lg">Live Search Results</h3>
        </div>
        <span className="text-xs px-2 py-1 bg-white border-2 border-black">
          {result.quotaRemaining}/{result.quotaLimit} searches left
        </span>
      </div>

      <div className="bg-white border-2 border-black p-3 mb-3">
        <p className="whitespace-pre-wrap">{result.answer}</p>
      </div>

      {result.sources.length > 0 && (
        <div className="mb-3">
          <h4 className="font-bold text-sm mb-2">Sources</h4>
          <div className="flex flex-wrap gap-2">
            {result.sources.map((source, idx) => (
              <a
                key={idx}
                href={source.url}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-1 text-xs px-2 py-1 bg-blue-100 border border-black hover:bg-blue-200"
              >
                <ExternalLink className="w-3 h-3" />
                {source.title || new URL(source.url).hostname}
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

export function QuotaExceededCard({ daysUntilReset }: { daysUntilReset: number }) {
  return (
    <div className="border-4 border-black p-4 bg-red-100 shadow-[4px_4px_0_0_#000]">
      <div className="flex items-center gap-2 mb-2">
        <AlertCircle className="w-5 h-5 text-red-600" />
        <h3 className="font-bold">Monthly Search Quota Exceeded</h3>
      </div>
      <p className="text-sm">
        You've used all 50 live searches for this month.
        Quota resets in {daysUntilReset} days.
      </p>
      <p className="text-sm mt-2 text-gray-600">
        Try searching our cached housing and visa data instead!
      </p>
    </div>
  );
}
```

---

## Dependencies

- **Upstream**: Story 10.1 (ADK Agent), Story 10.2 (CopilotRuntime)
- **Convex**: fireplexityQueries.checkFireplexityQuota, fireplexity.fireplexitySearch
- **External**: Perplexity API, Firecrawl API

---

## Testing Strategy

### Test Cases

1. **Quota Available**:
   - Search executes successfully
   - Results include answer and sources
   - Quota decremented correctly

2. **Quota Exceeded**:
   - Returns friendly error message
   - Shows days until reset
   - No API call made

3. **Error Handling**:
   - Network timeout returns helpful message
   - Convex error handled gracefully
   - Invalid query handled

4. **Frontend Rendering**:
   - Loading state shows search progress
   - Results render with sources
   - Quota badge displays correctly
   - Quota exceeded shows special card

5. **Integration**:
   - Tool triggered by appropriate queries
   - Agent uses tool appropriately (not for every query)
