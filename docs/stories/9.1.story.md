# Story 9.1: Budget Creation Wizard

## Status

**Complete**

---

## Story

**As a** new user setting up my migration finances,
**I want** a guided wizard to create my initial budget,
**so that** I can quickly set up expense tracking with realistic allocations.

---

## Acceptance Criteria

1. Wizard appears when user has corridor but no budget created
2. Single-step form with total budget amount and currency selection
3. Support for 5 major currencies: USD, CAD, GBP, EUR, AUD
4. Automatic detection of destination currency from corridor
5. Default budget allocations based on migration expense categories:
   - Visa & Immigration: 25%
   - Tests: 15%
   - Travel: 20%
   - Settlement: 25%
   - Financial: 10%
   - Miscellaneous: 5%
6. Display allocation preview before creation
7. Fetch real-time exchange rate from API for origin/destination conversion
8. Create budget with automatic exchange rate calculation
9. Success feedback and redirect to budget dashboard
10. Option to adjust allocations after creation (future enhancement)

---

## Tasks / Subtasks

- [x] **Task 1: Create Budget Wizard Component** (AC: 1, 2, 6)
  - [x] Create `components/finances/CreateBudgetWizard.tsx`
  - [x] Accept corridor prop with origin and destination
  - [x] Form with currency dropdown (USD, CAD, GBP, EUR, AUD)
  - [x] Total budget number input with validation (min 0, step 0.01)
  - [x] Display default allocation percentages as preview
  - [x] Submit button with loading state
  - [x] Neo-brutalism styling consistent with TRIBE design

- [x] **Task 2: Integrate into Finances Page** (AC: 1)
  - [x] Import CreateBudgetWizard component
  - [x] Show wizard when corridor exists but budget is null
  - [x] Hide wizard once budget is created
  - [x] Refresh page or update state after successful creation

- [x] **Task 3: Add Currency Detection** (AC: 4)
  - [x] Create `lib/utils/currency.ts` helper
  - [x] Map countries to default currencies:
    - Canada → CAD
    - United States → USD
    - United Kingdom → GBP
    - European countries → EUR
    - Australia → AUD
  - [x] Auto-select destination currency in wizard
  - [x] Allow manual override via dropdown

- [x] **Task 4: Integrate Exchange Rate API** (AC: 7, 8)
  - [x] Add exchange rate fetch to budget creation flow
  - [x] Call `api.financial.getExchangeRate` before creation
  - [x] Use dual provider system (exchangeratesapi.io primary, exchangerate-api.com fallback)
  - [x] Display current exchange rate to user (e.g., "1 CAD = 287.65 NGN")
  - [x] Calculate totalBudgetOrigin = totalBudgetDestination × exchangeRate
  - [x] Store createdExchangeRate in budget for reference

- [x] **Task 5: Add Budget Templates** (AC: 5)
  - [x] Research typical migration costs for common corridors
  - [x] Create corridor-specific budget templates:
    - Nigeria → Canada: Higher visa/immigration costs
    - India → USA: Higher test preparation costs
    - Philippines → UK: Higher travel costs
  - [x] Allow user to select template or use default
  - [x] Adjust allocations based on selected template

- [x] **Task 6: Add Allocation Customization** (AC: 10 - Future)
  - [x] Add "Customize Allocations" advanced option
  - [x] 6 slider inputs for each category (0-100%)
  - [x] Real-time validation: ensure total = 100%
  - [x] Visual feedback if total doesn't equal 100%
  - [x] Save custom allocations to budget

---

## Technical Implementation Notes

### Default Budget Allocations
```typescript
const defaultAllocations = {
  visaImmigration: 0.25, // 25% - Visa fees, document costs, appointments
  tests: 0.15,           // 15% - IELTS/TEF, medical exams, evaluations
  travel: 0.20,          // 20% - Flights, accommodation, transport
  settlement: 0.25,      // 25% - Rent, utilities, furniture, moving
  financial: 0.10,       // 10% - Bank fees, transfers, exchange costs
  miscellaneous: 0.05,   // 5% - Unexpected expenses
};
```

### Currency Detection Logic
```typescript
// lib/utils/currency.ts
const countryCurrencyMap: Record<string, string> = {
  "Canada": "CAD",
  "United States": "USD",
  "United Kingdom": "GBP",
  "Germany": "EUR",
  "France": "EUR",
  "Australia": "AUD",
  // ... more mappings
};

export function getDefaultCurrency(country: string): string {
  return countryCurrencyMap[country] || "USD";
}
```

### Budget Creation Flow
```typescript
const handleCreate = async () => {
  // 1. Get exchange rate
  const exchangeRate = await getExchangeRate({
    from: originCurrency,
    to: destinationCurrency
  });

  // 2. Calculate allocations
  const totalBudget = parseFloat(budgetAmount);
  const allocations = {
    visaImmigration: totalBudget * 0.25,
    tests: totalBudget * 0.15,
    travel: totalBudget * 0.20,
    settlement: totalBudget * 0.25,
    financial: totalBudget * 0.10,
    miscellaneous: totalBudget * 0.05,
  };

  // 3. Create budget
  await createBudget({
    corridorId: corridor._id,
    originCurrency,
    destinationCurrency,
    totalBudgetDestination: totalBudget,
    exchangeRate,
    allocations,
  });
};
```

### Corridor-Specific Templates
```typescript
interface BudgetTemplate {
  name: string;
  allocations: Record<string, number>;
  description: string;
}

const templates: Record<string, BudgetTemplate> = {
  "Nigeria-Canada": {
    name: "Nigeria → Canada",
    allocations: {
      visaImmigration: 0.30, // Higher due to express entry
      tests: 0.20,           // IELTS + WES evaluation
      travel: 0.15,
      settlement: 0.25,
      financial: 0.05,
      miscellaneous: 0.05,
    },
    description: "Optimized for Nigerian migrants moving to Canada via Express Entry"
  },
  // ... more templates
};
```

---

## Dependencies

- **Convex Mutations**: financial.createBudget, financial.getExchangeRate
- **Exchange Rate APIs**: exchangeratesapi.io (primary), exchangerate-api.com (fallback)
- **Related Stories**: 9.2 (Budget Tracking), 9.5 (CSV Import)

---

## User Experience Flow

1. **User arrives at finances page**:
   - Has completed onboarding and selected corridor
   - No budget exists yet

2. **Budget wizard displayed**:
   - Shows destination currency pre-selected
   - Friendly prompt: "Let's set up your migration budget!"

3. **User enters budget amount**:
   - Types total budget (e.g., $8,500 CAD)
   - Sees allocation preview update in real-time
   - Exchange rate displayed if different currencies

4. **User submits**:
   - Loading state: "Creating your budget..."
   - Success: Redirect to budget dashboard
   - Shows budget overview with 0% spent

5. **User can now**:
   - Add expenses manually
   - Import CSV bank statements
   - Track spending vs. allocations

---

## Testing Strategy

### Test Cases
1. **Happy Path**:
   - User with corridor, no budget
   - Enter valid budget amount
   - Submit successfully
   - Budget created in database
   - User sees budget dashboard

2. **Validation**:
   - Empty budget amount → Error
   - Negative budget amount → Error
   - Budget = 0 → Error
   - Non-numeric input → Error

3. **Currency Detection**:
   - Nigeria → Canada: Auto-selects CAD
   - India → USA: Auto-selects USD
   - Philippines → UK: Auto-selects GBP
   - Unknown country: Defaults to USD

4. **Exchange Rate**:
   - Different currencies: Fetches and displays rate
   - Same currency: Shows rate = 1.0
   - API failure: Shows error, allows retry
   - Fallback API: Works when primary fails

---

## Future Enhancements

1. **Multi-Step Wizard**:
   - Step 1: Budget amount and currency
   - Step 2: Customize allocations (optional)
   - Step 3: Review and confirm
   - Progress indicator

2. **Budget Recommendations**:
   - Query community data for similar corridors
   - Show average budget amounts
   - Highlight if user's budget is significantly higher/lower
   - Suggest adjustments based on destination cost of living

3. **Income Integration**:
   - Ask for monthly income
   - Calculate how long to save target budget
   - Show savings timeline projection
   - Set monthly savings goals

4. **Visual Allocation Builder**:
   - Interactive pie chart
   - Drag to adjust allocation sizes
   - Color-coded categories
   - Instant visual feedback
