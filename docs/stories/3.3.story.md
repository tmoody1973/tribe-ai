# Story 3.3: Source Attribution Display

## Status

**Draft**

---

## Story

**As a** user,
**I want** to see who provided each piece of advice,
**so that** I can trust the information and verify if needed.

---

## Acceptance Criteria

1. Each protocol card shows attribution: author name, date, source type
2. Attribution links to original source URL (opens in new tab)
3. Engagement indicator shows community validation (upvotes, confirmations)
4. Multiple attributions shown when step has multiple sources
5. "Community verified" badge for high-confidence steps
6. Attribution section collapsible to reduce visual noise

---

## Tasks / Subtasks

- [ ] **Task 1: Create Attribution Component** (AC: 1, 2)
  - [ ] Create `components/protocol/Attribution.tsx`
  - [ ] Display author name (or "Anonymous")
  - [ ] Show source date (relative: "3 months ago")
  - [ ] Link to source URL (external, new tab)
  - [ ] Add source type icon (Reddit, forum, blog, gov)

- [ ] **Task 2: Add Engagement Indicator** (AC: 3)
  - [ ] Create `components/protocol/EngagementScore.tsx`
  - [ ] Display upvote count with icon
  - [ ] Visual scale (low, medium, high engagement)
  - [ ] Tooltip explaining what engagement means

- [ ] **Task 3: Handle Multiple Sources** (AC: 4)
  - [ ] Show primary attribution by default
  - [ ] "See X more sources" expandable
  - [ ] List additional sources when expanded

- [ ] **Task 4: Add Community Verified Badge** (AC: 5)
  - [ ] Define threshold for "verified" (e.g., 100+ engagement)
  - [ ] Show badge on qualifying protocols
  - [ ] Style with checkmark and trust color

- [ ] **Task 5: Make Attribution Collapsible** (AC: 6)
  - [ ] Default: collapsed on mobile, visible on desktop
  - [ ] Toggle button to show/hide
  - [ ] Remember preference (optional)

- [ ] **Task 6: Integrate with ProtocolCard** (AC: 1-6)
  - [ ] Add Attribution to ProtocolCard expanded view
  - [ ] Pass attribution data from protocol
  - [ ] Handle missing attribution gracefully

---

## Dev Notes

### Attribution Component
[Source: architecture.md#data-models]

```typescript
// components/protocol/Attribution.tsx
"use client";

import { formatDistanceToNow } from "date-fns";
import { ExternalLink, MessageCircle, Globe, FileText, Building } from "lucide-react";
import { useTranslations } from "next-intl";

interface AttributionData {
  authorName?: string;
  sourceUrl: string;
  sourceDate?: number;
  engagement?: number;
}

interface AttributionProps {
  attribution: AttributionData;
  source: "reddit" | "forum" | "blog" | "government" | "news";
}

const sourceIcons: Record<string, any> = {
  reddit: MessageCircle,
  forum: MessageCircle,
  blog: FileText,
  government: Building,
  news: Globe,
};

const sourceColors: Record<string, string> = {
  reddit: "text-orange-500",
  forum: "text-blue-500",
  blog: "text-purple-500",
  government: "text-green-600",
  news: "text-gray-600",
};

export function Attribution({ attribution, source }: AttributionProps) {
  const t = useTranslations("attribution");
  const Icon = sourceIcons[source] ?? Globe;

  const formattedDate = attribution.sourceDate
    ? formatDistanceToNow(new Date(attribution.sourceDate), { addSuffix: true })
    : null;

  return (
    <div className="flex items-center gap-3 text-sm text-gray-600">
      {/* Source Icon */}
      <Icon size={16} className={sourceColors[source]} />

      {/* Author */}
      <span className="font-medium">
        {attribution.authorName ?? t("anonymous")}
      </span>

      {/* Date */}
      {formattedDate && (
        <>
          <span>•</span>
          <span>{formattedDate}</span>
        </>
      )}

      {/* Engagement */}
      {attribution.engagement && attribution.engagement > 0 && (
        <>
          <span>•</span>
          <EngagementScore score={attribution.engagement} />
        </>
      )}

      {/* Link */}
      <a
        href={attribution.sourceUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="ml-auto flex items-center gap-1 text-blue-600 hover:underline"
      >
        {t("viewSource")}
        <ExternalLink size={14} />
      </a>
    </div>
  );
}
```

### Engagement Score Component
```typescript
// components/protocol/EngagementScore.tsx
"use client";

import { ThumbsUp } from "lucide-react";

interface EngagementScoreProps {
  score: number;
}

export function EngagementScore({ score }: EngagementScoreProps) {
  const level = score >= 100 ? "high" : score >= 30 ? "medium" : "low";

  const colors = {
    high: "text-green-600",
    medium: "text-yellow-600",
    low: "text-gray-500",
  };

  return (
    <span className={`flex items-center gap-1 ${colors[level]}`}>
      <ThumbsUp size={14} />
      <span>{formatScore(score)}</span>
    </span>
  );
}

function formatScore(score: number): string {
  if (score >= 1000) return `${(score / 1000).toFixed(1)}k`;
  return score.toString();
}
```

### Community Verified Badge
```typescript
// components/protocol/CommunityVerifiedBadge.tsx
"use client";

import { CheckCircle } from "lucide-react";
import { useTranslations } from "next-intl";

interface CommunityVerifiedBadgeProps {
  engagement?: number;
  threshold?: number;
}

export function CommunityVerifiedBadge({
  engagement = 0,
  threshold = 100,
}: CommunityVerifiedBadgeProps) {
  const t = useTranslations("attribution");

  if (engagement < threshold) return null;

  return (
    <span className="inline-flex items-center gap-1 bg-green-100 text-green-700 text-xs font-bold px-2 py-1 border border-green-500">
      <CheckCircle size={12} />
      {t("communityVerified")}
    </span>
  );
}
```

### Multiple Sources Component
```typescript
// components/protocol/SourcesList.tsx
"use client";

import { useState } from "react";
import { ChevronDown, ChevronUp } from "lucide-react";
import { Attribution } from "./Attribution";
import { useTranslations } from "next-intl";

interface Source {
  authorName?: string;
  sourceUrl: string;
  sourceDate?: number;
  engagement?: number;
  type: "reddit" | "forum" | "blog" | "government" | "news";
}

interface SourcesListProps {
  sources: Source[];
}

export function SourcesList({ sources }: SourcesListProps) {
  const [expanded, setExpanded] = useState(false);
  const t = useTranslations("attribution");

  if (sources.length === 0) return null;

  const [primary, ...additional] = sources;

  return (
    <div className="border-t border-gray-200 pt-3 mt-3">
      {/* Primary Source */}
      <Attribution attribution={primary} source={primary.type} />

      {/* Additional Sources */}
      {additional.length > 0 && (
        <div className="mt-2">
          <button
            onClick={() => setExpanded(!expanded)}
            className="text-sm text-blue-600 flex items-center gap-1"
          >
            {expanded ? (
              <>
                {t("hideSources")}
                <ChevronUp size={14} />
              </>
            ) : (
              <>
                {t("moreSources", { count: additional.length })}
                <ChevronDown size={14} />
              </>
            )}
          </button>

          {expanded && (
            <div className="mt-2 space-y-2 pl-4 border-l-2 border-gray-200">
              {additional.map((source, i) => (
                <Attribution key={i} attribution={source} source={source.type} />
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

### Integration with ProtocolCard
```typescript
// Update components/protocol/ProtocolCard.tsx - Add to expanded section

{/* Attribution Section */}
{protocol.attribution && (
  <div className="mt-4 pt-4 border-t border-gray-200">
    <CommunityVerifiedBadge engagement={protocol.attribution.engagement} />
    <Attribution
      attribution={protocol.attribution}
      source={detectSourceType(protocol.attribution.sourceUrl)}
    />
  </div>
)}

function detectSourceType(url: string): "reddit" | "forum" | "blog" | "government" | "news" {
  if (url.includes("reddit.com")) return "reddit";
  if (url.includes("nairaland") || url.includes("internations")) return "forum";
  if (url.includes(".gov") || url.includes("embassy")) return "government";
  return "blog";
}
```

### Translation Keys
```json
// messages/en.json - Add attribution section
{
  "attribution": {
    "anonymous": "Community Member",
    "viewSource": "View source",
    "communityVerified": "Community Verified",
    "moreSources": "+ {count} more sources",
    "hideSources": "Hide sources"
  }
}
```

### File Structure
```
components/
└── protocol/
    ├── Attribution.tsx
    ├── EngagementScore.tsx
    ├── CommunityVerifiedBadge.tsx
    └── SourcesList.tsx
```

### Dependencies from Previous Stories
- Story 2.1: Protocol attribution field
- Story 3.2: ProtocolCard component

---

## Testing

### Test Scenarios

1. **Attribution Display**
   - [ ] Author name shown (or "Community Member")
   - [ ] Relative date displayed
   - [ ] Source link works (new tab)

2. **Engagement Score**
   - [ ] Score formatted (1.2k for 1200)
   - [ ] Color indicates level
   - [ ] Icon displayed

3. **Community Verified**
   - [ ] Badge shows for 100+ engagement
   - [ ] Hidden for low engagement

4. **Multiple Sources**
   - [ ] Primary shown by default
   - [ ] "See more" expands additional
   - [ ] All sources displayed when expanded

5. **Missing Attribution**
   - [ ] No errors for protocols without attribution
   - [ ] Section hidden if no data

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*
