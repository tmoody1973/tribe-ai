# Story 10.5: Migrate Visa Options Tool to ADK

## Status

**Completed**

---

## Story

**As a** user,
**I want** visa pathway discovery through ADK agent,
**so that** I can explore migration options conversationally.

---

## Acceptance Criteria

1. Create `searchVisaOptions` tool in ADK agent with parameters: origin (ISO3), destination (ISO3), getProcessingTimes (bool)
2. Tool calls Convex action for Travel Buddy API visa requirements
3. Returns structured visa data: visaRequired, visaType, stayDuration, requirements, estimatedCost
4. Optional processing times fetched via Perplexity API
5. Results cached in Convex for 7 days
6. Frontend renders `VisaPathwayCard` component showing visa comparison
7. Actionable buttons: "Add as alternative corridor", "View full requirements"
8. Error handling for invalid country codes with suggestions

---

## Tasks / Subtasks

- [x] **Task 1: Create Convex HTTP Endpoints** (AC: 2, 4)
  - [x] Create endpoint: POST /api/visa/requirements
  - [x] Create endpoint: POST /api/visa/processing-times (optional)
  - [x] Endpoints wrap existing visaDiscovery Convex actions
  - [x] Return cached results when available

- [x] **Task 2: Create Visa Search Tool** (AC: 1, 2, 3, 4, 5)
  - [x] Create `agents/tribe_agent/tools/visa.py`
  - [x] Define `search_visa_options` function with FunctionTool
  - [x] Parameters: origin (str), destination (str), get_processing_times (bool)
  - [x] Call Convex HTTP endpoint for visa requirements
  - [x] Optionally fetch processing times
  - [x] Parse and structure response
  - [x] Handle caching information

- [x] **Task 3: Add Country Code Validation** (AC: 8)
  - [x] Create country code validation helper with 60+ country mappings
  - [x] Map common country names to ISO3 codes
  - [x] Return suggestions for invalid codes
  - [x] Handle "USA" vs "US" vs "United States" variations

- [x] **Task 4: Register Tool with Agent** (AC: 1)
  - [x] Import visa tool in agent.py
  - [x] Add to agent's tools list
  - [x] Add clear description with country format guidance

- [x] **Task 5: Create Frontend Card** (AC: 6, 7)
  - [x] Create `components/chat/VisaPathwayCard.tsx`
  - [x] Display visa type and requirements
  - [x] Show stay duration and estimated cost
  - [x] Show processing time if available
  - [x] Add "Add as corridor" button callback
  - [x] Add expandable requirements section
  - [x] Create VisaSearchLoading component
  - [x] Create VisaErrorCard component

- [x] **Task 6: Register Tool Renderer** (AC: 6)
  - [x] Add `useCopilotAction` hook with `available: "remote"` for `search_visa_options`
  - [x] Handle loading state with origin/destination display
  - [x] Handle complete with VisaPathwayCard
  - [x] Handle errors with suggestions

---

## Technical Implementation Notes

### Convex HTTP Endpoints
```typescript
// convex/http.ts

http.route({
  path: "/api/visa/requirements",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    const { origin, destination } = await request.json();

    try {
      const result = await ctx.runAction(
        internal.visaDiscovery.getVisaRequirementsForCorridor,
        { origin, destination }
      );
      return new Response(JSON.stringify(result), {
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      return new Response(
        JSON.stringify({ error: true, message: String(error) }),
        { status: 500, headers: { "Content-Type": "application/json" } }
      );
    }
  }),
});

http.route({
  path: "/api/visa/processing-times",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    const { origin, destination, visaType } = await request.json();

    try {
      const result = await ctx.runAction(
        internal.visaDiscovery.getProcessingTimes,
        { origin, destination, visaType }
      );
      return new Response(JSON.stringify(result), {
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      return new Response(
        JSON.stringify({ error: true, message: String(error) }),
        { status: 500, headers: { "Content-Type": "application/json" } }
      );
    }
  }),
});
```

### Visa Tool (Python)
```python
# agents/tribe_agent/tools/visa.py
import os
import httpx
from google.adk.tools import FunctionTool

CONVEX_SITE_URL = os.environ.get("CONVEX_SITE_URL", "")

# Common country name to ISO3 mappings
COUNTRY_CODES = {
    "united states": "USA", "usa": "USA", "us": "USA", "america": "USA",
    "canada": "CAN", "ca": "CAN",
    "united kingdom": "GBR", "uk": "GBR", "britain": "GBR", "england": "GBR",
    "germany": "DEU", "de": "DEU",
    "france": "FRA", "fr": "FRA",
    "australia": "AUS", "au": "AUS",
    "nigeria": "NGA", "ng": "NGA",
    "india": "IND", "in": "IND",
    "philippines": "PHL", "ph": "PHL",
    "brazil": "BRA", "br": "BRA",
    # Add more as needed
}

def normalize_country_code(code: str) -> str:
    """Convert country name or code to ISO3 format."""
    normalized = code.strip().lower()
    if normalized in COUNTRY_CODES:
        return COUNTRY_CODES[normalized]
    # Already ISO3?
    if len(code) == 3 and code.isupper():
        return code
    return code.upper()[:3]

@FunctionTool
async def search_visa_options(
    origin: str,
    destination: str,
    get_processing_times: bool = False
) -> dict:
    """
    Discover visa requirements and pathways for migration between countries.

    Args:
        origin: Origin country (passport country) - ISO 3166-1 alpha-3 code
                (e.g., 'NGA' for Nigeria, 'IND' for India, 'PHL' for Philippines)
        destination: Destination country - ISO 3166-1 alpha-3 code
                     (e.g., 'CAN' for Canada, 'USA' for United States, 'GBR' for UK)
        get_processing_times: Whether to fetch real-time processing times (uses API quota)

    Returns:
        dict with visa requirements, type, duration, cost, and optional processing times
    """
    # Normalize country codes
    origin_code = normalize_country_code(origin)
    dest_code = normalize_country_code(destination)

    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            # Get visa requirements
            response = await client.post(
                f"{CONVEX_SITE_URL}/api/visa/requirements",
                json={"origin": origin_code, "destination": dest_code}
            )
            visa_data = response.json()

            if visa_data.get("error"):
                return visa_data

            result = {
                "success": True,
                "origin": origin_code,
                "destination": dest_code,
                "visaRequired": visa_data.get("visaRequired", True),
                "visaType": visa_data.get("visaType"),
                "stayDuration": visa_data.get("stayDuration"),
                "requirements": visa_data.get("requirements", []),
                "estimatedCost": visa_data.get("cost"),
                "cached": visa_data.get("cached", False),
                "quotaRemaining": visa_data.get("quotaRemaining")
            }

            # Optionally get processing times
            if get_processing_times and visa_data.get("visaType"):
                try:
                    times_response = await client.post(
                        f"{CONVEX_SITE_URL}/api/visa/processing-times",
                        json={
                            "origin": origin_code,
                            "destination": dest_code,
                            "visaType": visa_data["visaType"]
                        }
                    )
                    times_data = times_response.json()
                    if times_data.get("success"):
                        result["processingTime"] = {
                            "averageDays": times_data.get("averageProcessingDays"),
                            "source": times_data.get("source"),
                            "cached": times_data.get("cached")
                        }
                except:
                    pass  # Processing times are optional

            return result

        except httpx.TimeoutException:
            return {
                "error": True,
                "message": "Request timed out. Please try again."
            }
        except Exception as e:
            return {
                "error": True,
                "message": f"Failed to fetch visa information: {str(e)}"
            }
```

### Frontend Card Component
```typescript
// components/chat/VisaPathwayCard.tsx
"use client";

import { useState } from "react";
import { Plane, Clock, DollarSign, FileText, ChevronDown, Plus } from "lucide-react";
import { useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";

interface VisaResult {
  origin: string;
  destination: string;
  visaRequired: boolean;
  visaType: string;
  stayDuration: string;
  requirements: string[];
  estimatedCost: string;
  processingTime?: {
    averageDays: number;
    source: string;
  };
}

export function VisaPathwayCard({ result }: { result: VisaResult }) {
  const [expanded, setExpanded] = useState(false);
  const createCorridor = useMutation(api.corridors.createCorridor);

  const handleAddCorridor = async () => {
    await createCorridor({
      origin: result.origin,
      destination: result.destination,
      stage: "dreaming"
    });
  };

  return (
    <div className="border-4 border-black p-4 bg-purple-100 shadow-[4px_4px_0_0_#000]">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Plane className="w-5 h-5" />
          <h3 className="font-bold text-lg">
            {result.origin} → {result.destination}
          </h3>
        </div>
        <span className={`px-2 py-1 text-xs font-bold border-2 border-black ${
          result.visaRequired ? "bg-yellow-200" : "bg-green-200"
        }`}>
          {result.visaRequired ? "Visa Required" : "Visa Free"}
        </span>
      </div>

      <div className="grid grid-cols-2 gap-3 mb-3">
        <div className="bg-white border-2 border-black p-2">
          <div className="flex items-center gap-1 text-xs text-gray-600">
            <FileText className="w-3 h-3" />
            Visa Type
          </div>
          <div className="font-bold">{result.visaType || "N/A"}</div>
        </div>
        <div className="bg-white border-2 border-black p-2">
          <div className="flex items-center gap-1 text-xs text-gray-600">
            <Clock className="w-3 h-3" />
            Stay Duration
          </div>
          <div className="font-bold">{result.stayDuration || "Varies"}</div>
        </div>
        {result.estimatedCost && (
          <div className="bg-white border-2 border-black p-2">
            <div className="flex items-center gap-1 text-xs text-gray-600">
              <DollarSign className="w-3 h-3" />
              Est. Cost
            </div>
            <div className="font-bold">{result.estimatedCost}</div>
          </div>
        )}
        {result.processingTime && (
          <div className="bg-white border-2 border-black p-2">
            <div className="flex items-center gap-1 text-xs text-gray-600">
              <Clock className="w-3 h-3" />
              Processing
            </div>
            <div className="font-bold">{result.processingTime.averageDays} days</div>
          </div>
        )}
      </div>

      {result.requirements.length > 0 && (
        <div className="mb-3">
          <button
            onClick={() => setExpanded(!expanded)}
            className="flex items-center gap-1 text-sm font-bold"
          >
            <ChevronDown className={`w-4 h-4 transition-transform ${expanded ? "rotate-180" : ""}`} />
            Requirements ({result.requirements.length})
          </button>
          {expanded && (
            <ul className="mt-2 space-y-1 text-sm bg-white border-2 border-black p-2">
              {result.requirements.map((req, idx) => (
                <li key={idx} className="flex items-start gap-2">
                  <span className="text-gray-400">•</span>
                  {req}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      <div className="flex gap-2">
        <button
          onClick={handleAddCorridor}
          className="flex-1 flex items-center justify-center gap-1 py-2 border-2 border-black bg-blue-200 hover:bg-blue-300 font-bold"
        >
          <Plus className="w-4 h-4" />
          Add as Corridor
        </button>
      </div>
    </div>
  );
}
```

---

## Dependencies

- **Upstream**: Story 10.1 (ADK Agent), Story 10.2 (CopilotRuntime)
- **Convex**: visaDiscovery.getVisaRequirementsForCorridor, visaDiscovery.getProcessingTimes
- **External**: Travel Buddy API, Perplexity API (for processing times)

---

## Testing Strategy

### Test Cases

1. **Valid Country Codes**:
   - NGA → CAN returns correct visa info
   - IND → USA returns correct requirements
   - Cached results returned when available

2. **Country Code Normalization**:
   - "Nigeria" → "NGA"
   - "usa" → "USA"
   - "United Kingdom" → "GBR"

3. **Processing Times**:
   - Optional parameter works
   - Processing times merged into response
   - Graceful handling if times unavailable

4. **Error Handling**:
   - Invalid country code returns suggestions
   - API timeout handled gracefully
   - Network errors show helpful message

5. **Frontend**:
   - Card displays all visa information
   - Requirements expandable
   - Add corridor button works
   - Loading state with country flags
