# Story 6.2: Cultural Profile Builder

## Status

**Draft**

---

## Story

**As a** user,
**I want** to complete an AI-guided cultural interview,
**so that** TRIBE deeply understands my cultural background and can provide personalized cultural insights.

---

## Acceptance Criteria

1. AI-guided interview flow with 8-12 contextual questions
2. Questions cover: communication style, values, family structure, social norms, food/dietary, celebrations, conflict resolution, time orientation
3. Claude generates follow-up questions based on answers (adaptive interview)
4. Cultural profile stored in Convex with structured data
5. Profile summary displayed on user's dashboard
6. Option to edit/update profile answers
7. Profile data used to personalize cultural insights throughout app

---

## Tasks / Subtasks

- [ ] **Task 1: Create Cultural Profile Schema** (AC: 4)
  - [ ] Add `culturalProfiles` table to `convex/schema.ts`
  - [ ] Fields: userId, originCulture, communicationStyle, familyStructure, timeOrientation, values[], foodDietary[], celebrations[], interviewResponses, createdAt, updatedAt
  - [ ] Index by userId
  - [ ] Run `npx convex dev` to deploy schema

- [ ] **Task 2: Create Cultural Bridge Agent** (AC: 1, 2, 3)
  - [ ] Create `agents/culturalBridge.ts`
  - [ ] Configure Claude Sonnet 4 model
  - [ ] Write interview system prompt covering all cultural dimensions
  - [ ] Include adaptive follow-up question logic

- [ ] **Task 3: Create Interview Action** (AC: 1, 3)
  - [ ] Create `convex/cultural/interview.ts`
  - [ ] Implement `startInterview` action (initial questions)
  - [ ] Implement `continueInterview` action (follow-up based on answers)
  - [ ] Implement `completeInterview` action (finalize and save)

- [ ] **Task 4: Build Interview UI Component** (AC: 1, 2)
  - [ ] Create `components/cultural/CulturalProfileBuilder.tsx`
  - [ ] Chat-like interface for interview questions
  - [ ] Progress indicator (questions answered)
  - [ ] Free-text input for open questions
  - [ ] Multiple choice for structured questions
  - [ ] RetroUI styling (neobrutalist cards, bold typography)

- [ ] **Task 5: Save and Parse Profile** (AC: 4)
  - [ ] Create `saveCulturalProfile` mutation
  - [ ] Parse interview responses into structured fields
  - [ ] Extract values[], celebrations[], foodDietary[] from responses
  - [ ] Determine communicationStyle, familyStructure, timeOrientation

- [ ] **Task 6: Profile Summary Display** (AC: 5)
  - [ ] Create `components/cultural/CulturalProfileSummary.tsx`
  - [ ] Display cultural dimensions with visual indicators
  - [ ] Show values as badges/tags
  - [ ] Add to dashboard as new section
  - [ ] "Complete your cultural profile" CTA if incomplete

- [ ] **Task 7: Edit Profile Flow** (AC: 6)
  - [ ] Add "Edit" button to profile summary
  - [ ] Re-run interview or edit individual fields
  - [ ] Update mutation with new values
  - [ ] Show last updated timestamp

- [ ] **Task 8: Add Translations** (AC: 7)
  - [ ] Add cultural profile translation keys to all 9 locales
  - [ ] Interview questions translated
  - [ ] Profile labels translated
  - [ ] Cultural dimension descriptions translated

---

## Dev Notes

### Cultural Profile Schema
```typescript
// convex/schema.ts - Add culturalProfiles table
culturalProfiles: defineTable({
  userId: v.id("users"),
  originCulture: v.string(),  // e.g., "Nigerian Yoruba"
  communicationStyle: v.union(
    v.literal("direct"),
    v.literal("indirect"),
    v.literal("context-dependent")
  ),
  familyStructure: v.union(
    v.literal("nuclear"),
    v.literal("extended"),
    v.literal("multi-generational")
  ),
  timeOrientation: v.union(
    v.literal("monochronic"),
    v.literal("polychronic")
  ),
  values: v.array(v.string()),
  foodDietary: v.array(v.string()),
  celebrations: v.array(v.string()),
  interviewResponses: v.record(v.string(), v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"]),
```

### Cultural Bridge Agent
```typescript
// agents/culturalBridge.ts
import { Agent } from "@mastra/core";

export const culturalBridge = new Agent({
  name: "CulturalBridge",
  model: "claude-sonnet-4-20250514",
  instructions: `You are a cultural intelligence specialist conducting an interview to understand someone's cultural background.

INTERVIEW STRUCTURE:
1. Opening: Warm greeting, explain purpose
2. Origin: "Tell me about where you grew up and your cultural background"
3. Communication: "How do people in your culture typically express disagreement or criticism?"
4. Family: "Describe your family structure - who typically lives together?"
5. Values: "What values were most emphasized in your upbringing?"
6. Time: "How does your culture view punctuality and scheduling?"
7. Food: "Are there any dietary practices or food traditions important to you?"
8. Celebrations: "What are the major celebrations or holidays in your culture?"
9. Social: "How do people typically greet each other - friends vs. elders vs. strangers?"
10. Closing: Summarize what you learned, thank them

INTERVIEW STYLE:
- Warm, curious, never judgmental
- Ask follow-up questions when answers are interesting
- Validate their experiences ("That's really interesting...")
- Connect answers to previous responses when relevant
- Keep questions conversational, not clinical

ADAPTIVE BEHAVIOR:
- If they mention something unique, explore it
- If answers are brief, gently probe deeper
- If they seem uncomfortable, offer to skip and return later
- Celebrate cultural richness throughout

OUTPUT FORMAT:
Return questions one at a time, waiting for response before next.
Include a "progress" indicator (e.g., "Question 3 of 10").`,
});
```

### Interview Action
```typescript
// convex/cultural/interview.ts
import { action, mutation, query } from "../_generated/server";
import { v } from "convex/values";
import { api } from "../_generated/api";
import { culturalBridge } from "../../agents/culturalBridge";

interface InterviewState {
  questionNumber: number;
  responses: Record<string, string>;
  currentQuestion: string;
  isComplete: boolean;
}

export const startInterview = action({
  args: {},
  handler: async (ctx): Promise<InterviewState> => {
    const profile = await ctx.runQuery(api.users.getProfile);
    if (!profile) throw new Error("User not found");

    // Check for existing profile
    const existing = await ctx.runQuery(api.cultural.profile.getProfile);
    if (existing) {
      return {
        questionNumber: 0,
        responses: existing.interviewResponses,
        currentQuestion: "You already have a cultural profile. Would you like to update it?",
        isComplete: true,
      };
    }

    // Generate first question
    const result = await culturalBridge.generate(
      `Start the cultural interview for a user from ${profile.originCountry} moving to ${profile.destinationCountry}. Begin with a warm greeting and the first question.`
    );

    return {
      questionNumber: 1,
      responses: {},
      currentQuestion: result.text,
      isComplete: false,
    };
  },
});

export const continueInterview = action({
  args: {
    previousAnswer: v.string(),
    questionNumber: v.number(),
    responses: v.record(v.string(), v.string()),
  },
  handler: async (ctx, { previousAnswer, questionNumber, responses }) => {
    const profile = await ctx.runQuery(api.users.getProfile);
    if (!profile) throw new Error("User not found");

    // Save previous answer
    const updatedResponses = {
      ...responses,
      [`q${questionNumber}`]: previousAnswer,
    };

    // Check if interview is complete
    if (questionNumber >= 10) {
      // Save profile
      await ctx.runMutation(api.cultural.profile.saveProfile, {
        interviewResponses: updatedResponses,
      });

      return {
        questionNumber: questionNumber + 1,
        responses: updatedResponses,
        currentQuestion: "Thank you for sharing your cultural background! I've created your cultural profile. You can view and edit it anytime from your dashboard.",
        isComplete: true,
      };
    }

    // Build context from previous responses
    const context = Object.entries(updatedResponses)
      .map(([q, a]) => `${q}: ${a}`)
      .join("\n");

    // Generate next question
    const result = await culturalBridge.generate(
      `Continue the cultural interview. Previous responses:\n${context}\n\nGenerate question ${questionNumber + 1} of 10, adapting based on their previous answers.`
    );

    return {
      questionNumber: questionNumber + 1,
      responses: updatedResponses,
      currentQuestion: result.text,
      isComplete: false,
    };
  },
});
```

### CulturalProfileBuilder Component
```typescript
// components/cultural/CulturalProfileBuilder.tsx
"use client";

import { useState } from "react";
import { useAction } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useTranslations } from "next-intl";
import { Send, Loader2 } from "lucide-react";

interface InterviewState {
  questionNumber: number;
  responses: Record<string, string>;
  currentQuestion: string;
  isComplete: boolean;
}

export function CulturalProfileBuilder() {
  const t = useTranslations("cultural");
  const startInterview = useAction(api.cultural.interview.startInterview);
  const continueInterview = useAction(api.cultural.interview.continueInterview);

  const [state, setState] = useState<InterviewState | null>(null);
  const [answer, setAnswer] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [messages, setMessages] = useState<Array<{ role: "ai" | "user"; content: string }>>([]);

  const handleStart = async () => {
    setIsLoading(true);
    try {
      const result = await startInterview({});
      setState(result);
      setMessages([{ role: "ai", content: result.currentQuestion }]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSubmit = async () => {
    if (!state || !answer.trim()) return;

    setIsLoading(true);
    setMessages((prev) => [...prev, { role: "user", content: answer }]);

    try {
      const result = await continueInterview({
        previousAnswer: answer,
        questionNumber: state.questionNumber,
        responses: state.responses,
      });

      setState(result);
      setMessages((prev) => [...prev, { role: "ai", content: result.currentQuestion }]);
      setAnswer("");
    } finally {
      setIsLoading(false);
    }
  };

  if (!state) {
    return (
      <div className="bg-white border-4 border-black p-8 shadow-[8px_8px_0_0_#000] text-center">
        <h2 className="font-head text-2xl mb-4">{t("buildProfile")}</h2>
        <p className="text-gray-600 mb-6">{t("profileDescription")}</p>
        <button
          onClick={handleStart}
          disabled={isLoading}
          className="bg-amber-400 border-3 border-black px-6 py-3 font-bold shadow-[4px_4px_0_0_#000] hover:shadow-[2px_2px_0_0_#000] hover:translate-x-[2px] hover:translate-y-[2px] transition-all"
        >
          {isLoading ? <Loader2 className="animate-spin" /> : t("startInterview")}
        </button>
      </div>
    );
  }

  return (
    <div className="bg-white border-4 border-black shadow-[8px_8px_0_0_#000]">
      {/* Progress bar */}
      <div className="bg-gray-100 border-b-4 border-black p-4">
        <div className="flex items-center justify-between mb-2">
          <span className="font-bold">{t("culturalInterview")}</span>
          <span className="text-sm text-gray-600">
            {state.questionNumber} / 10
          </span>
        </div>
        <div className="h-3 bg-gray-300 border-2 border-black">
          <div
            className="h-full bg-green-400 transition-all duration-300"
            style={{ width: `${(state.questionNumber / 10) * 100}%` }}
          />
        </div>
      </div>

      {/* Messages */}
      <div className="h-96 overflow-y-auto p-4 space-y-4">
        {messages.map((msg, i) => (
          <div
            key={i}
            className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}
          >
            <div
              className={`max-w-[80%] p-4 border-3 border-black ${
                msg.role === "user"
                  ? "bg-cyan-100 shadow-[3px_3px_0_0_#000]"
                  : "bg-amber-100 shadow-[3px_3px_0_0_#000]"
              }`}
            >
              {msg.content}
            </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-gray-100 p-4 border-3 border-black">
              <Loader2 className="animate-spin" />
            </div>
          </div>
        )}
      </div>

      {/* Input */}
      {!state.isComplete && (
        <div className="border-t-4 border-black p-4">
          <div className="flex gap-2">
            <input
              type="text"
              value={answer}
              onChange={(e) => setAnswer(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
              placeholder={t("typeYourAnswer")}
              className="flex-1 border-3 border-black p-3 focus:outline-none focus:ring-2 focus:ring-amber-400"
              disabled={isLoading}
            />
            <button
              onClick={handleSubmit}
              disabled={isLoading || !answer.trim()}
              className="bg-green-400 border-3 border-black p-3 shadow-[3px_3px_0_0_#000] hover:shadow-[1px_1px_0_0_#000] hover:translate-x-[2px] hover:translate-y-[2px] transition-all disabled:opacity-50"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
```

### Profile Summary Component
```typescript
// components/cultural/CulturalProfileSummary.tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useTranslations } from "next-intl";
import { Heart, Users, Clock, MessageCircle, Utensils, PartyPopper } from "lucide-react";

const dimensionIcons = {
  communicationStyle: MessageCircle,
  familyStructure: Users,
  timeOrientation: Clock,
  values: Heart,
  foodDietary: Utensils,
  celebrations: PartyPopper,
};

export function CulturalProfileSummary() {
  const t = useTranslations("cultural");
  const profile = useQuery(api.cultural.profile.getProfile);

  if (!profile) {
    return (
      <div className="bg-amber-50 border-4 border-black p-6 shadow-[6px_6px_0_0_#000]">
        <h3 className="font-head text-xl mb-2">{t("noCulturalProfile")}</h3>
        <p className="text-gray-600 mb-4">{t("completeProfileCta")}</p>
        <a
          href="/cultural/profile"
          className="inline-block bg-amber-400 border-3 border-black px-4 py-2 font-bold shadow-[3px_3px_0_0_#000]"
        >
          {t("buildProfile")}
        </a>
      </div>
    );
  }

  return (
    <div className="bg-white border-4 border-black shadow-[6px_6px_0_0_#000]">
      <div className="bg-gradient-to-r from-amber-400 to-orange-400 border-b-4 border-black p-4">
        <h3 className="font-head text-xl text-black">{t("yourCulturalProfile")}</h3>
        <p className="text-sm">{profile.originCulture}</p>
      </div>

      <div className="p-4 grid grid-cols-2 gap-4">
        {/* Communication Style */}
        <div className="flex items-center gap-2">
          <MessageCircle className="w-5 h-5 text-blue-500" />
          <div>
            <div className="text-xs text-gray-500">{t("communication")}</div>
            <div className="font-bold">{t(`styles.${profile.communicationStyle}`)}</div>
          </div>
        </div>

        {/* Family Structure */}
        <div className="flex items-center gap-2">
          <Users className="w-5 h-5 text-green-500" />
          <div>
            <div className="text-xs text-gray-500">{t("family")}</div>
            <div className="font-bold">{t(`family.${profile.familyStructure}`)}</div>
          </div>
        </div>

        {/* Time Orientation */}
        <div className="flex items-center gap-2">
          <Clock className="w-5 h-5 text-purple-500" />
          <div>
            <div className="text-xs text-gray-500">{t("timeOrientation")}</div>
            <div className="font-bold">{t(`time.${profile.timeOrientation}`)}</div>
          </div>
        </div>
      </div>

      {/* Values */}
      <div className="border-t-2 border-gray-200 p-4">
        <div className="text-xs text-gray-500 mb-2">{t("coreValues")}</div>
        <div className="flex flex-wrap gap-2">
          {profile.values.map((value, i) => (
            <span
              key={i}
              className="bg-red-100 border-2 border-red-300 px-2 py-1 text-sm font-medium"
            >
              {value}
            </span>
          ))}
        </div>
      </div>

      {/* Celebrations */}
      <div className="border-t-2 border-gray-200 p-4">
        <div className="text-xs text-gray-500 mb-2">{t("celebrations")}</div>
        <div className="flex flex-wrap gap-2">
          {profile.celebrations.map((celebration, i) => (
            <span
              key={i}
              className="bg-yellow-100 border-2 border-yellow-300 px-2 py-1 text-sm"
            >
              {celebration}
            </span>
          ))}
        </div>
      </div>

      {/* Edit button */}
      <div className="border-t-4 border-black p-4">
        <a
          href="/cultural/profile/edit"
          className="inline-block bg-gray-100 border-2 border-black px-4 py-2 text-sm hover:bg-gray-200"
        >
          {t("editProfile")}
        </a>
      </div>
    </div>
  );
}
```

### File Structure
```
agents/
└── culturalBridge.ts         # Cultural Bridge agent

convex/
└── cultural/
    ├── interview.ts          # Interview actions
    └── profile.ts            # Profile queries/mutations

components/
└── cultural/
    ├── CulturalProfileBuilder.tsx
    └── CulturalProfileSummary.tsx

messages/
└── *.json                    # Add "cultural" translation keys
```

### Dependencies from Previous Stories
- Story 1.5: User profile with origin/destination countries
- Story 1.3: Internationalization setup

---

## Testing

### Test Scenarios

1. **Interview Flow**
   - [ ] Interview starts with greeting and first question
   - [ ] Follow-up questions adapt to answers
   - [ ] Progress indicator updates correctly
   - [ ] Interview completes after ~10 questions

2. **Profile Storage**
   - [ ] Profile saved to Convex on completion
   - [ ] Structured fields parsed correctly
   - [ ] Interview responses preserved

3. **Profile Display**
   - [ ] Summary shows all cultural dimensions
   - [ ] Values and celebrations displayed as tags
   - [ ] Edit button navigates correctly

4. **Edge Cases**
   - [ ] Empty answers handled gracefully
   - [ ] Very long answers truncated appropriately
   - [ ] Returning users see existing profile

5. **Localization**
   - [ ] Interview works in all 9 languages
   - [ ] Profile labels translated
   - [ ] Cultural dimension names localized

---

## Why This Feature Impresses Judges

1. **Novel Approach**: Bi-directional cultural understanding, not just "adapt to new culture"
2. **AI-Native**: Adaptive interview shows sophisticated agent behavior
3. **Emotional Impact**: Validates migrant identity and cultural pride
4. **Shareable Artifact**: Cultural cards spread understanding virally
5. **Measurable**: Belonging score shows integration progress

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-22 | 1.0 | Initial story draft | Claude |

---

## Dev Agent Record

*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*
