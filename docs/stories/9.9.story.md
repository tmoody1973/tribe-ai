# Story 9.9: Savings Goals - Milestone Notifications & Reminders

## Status

**Complete**

---

## Story

**As a** user saving toward migration goals,
**I want** timely notifications and reminders about my savings progress,
**so that** I stay motivated and on track without actively checking the app.

---

## Acceptance Criteria

1. Push notification when milestone achieved (25%, 50%, 75%, 100%)
2. Weekly reminder if no savings contributed this week
3. Alert when goal falls behind schedule (>15% behind expected progress)
4. Celebration notification when goal completed
5. Weekly savings summary email (optional, user preference)
6. In-app notification center showing all savings activity
7. Notification preferences: enable/disable per type
8. Smart timing: send reminders at user's peak saving days
9. Streak risk alert: "Add savings today to maintain 7-week streak"
10. Monthly progress report with insights and achievements

---

## Tasks / Subtasks

- [ ] **Task 1: Setup Notification Infrastructure** (AC: 6)
  - [ ] Create `notifications` table in Convex:
    ```typescript
    notifications: defineTable({
      userId: v.id("users"),
      type: v.union(
        v.literal("milestone_achieved"),
        v.literal("goal_completed"),
        v.literal("behind_schedule"),
        v.literal("weekly_reminder"),
        v.literal("streak_risk")
      ),
      title: v.string(),
      message: v.string(),
      metadata: v.object({
        goalId: v.optional(v.id("savingsGoals")),
        amount: v.optional(v.number()),
        milestone: v.optional(v.number()),
      }),
      read: v.boolean(),
      createdAt: v.number(),
    })
    ```
  - [ ] Add indices: by_user, by_user_unread, by_type
  - [ ] Create notification center UI component
  - [ ] Badge showing unread count

- [ ] **Task 2: Implement Milestone Notifications** (AC: 1, 4)
  - [ ] Trigger notification in `updateGoalProgress` mutation
  - [ ] Check if milestone just achieved (newly crossed threshold)
  - [ ] Create notification record in database
  - [ ] Send push notification (if enabled and user has granted permission)
  - [ ] Display toast in app with celebration animation
  - [ ] Special celebration for 100% (goal completion)
  - [ ] Email notification option for major milestones

- [ ] **Task 3: Build Weekly Reminder System** (AC: 2, 8)
  - [ ] Create cron job: `sendWeeklyReminders`
  - [ ] Schedule: Every Friday at user's preferred time
  - [ ] Check if user contributed to any goal this week
  - [ ] If no contribution, send reminder notification
  - [ ] Personalize message based on user's saving patterns
  - [ ] Include current streak status
  - [ ] Suggest amount based on goals at risk

- [ ] **Task 4: Create Behind Schedule Alerts** (AC: 3)
  - [ ] Daily cron job to check goal risk status
  - [ ] For goals >15% behind schedule, create alert
  - [ ] Calculate recommended weekly savings to catch up
  - [ ] Send notification with actionable recommendation
  - [ ] Limit to one alert per goal per week (avoid spam)
  - [ ] Include link to goal details page

- [ ] **Task 5: Implement Streak Risk Alerts** (AC: 9)
  - [ ] Check streak status daily (cron job)
  - [ ] If user has active streak and no contribution this week
  - [ ] Send alert on Thursday/Friday (before week ends)
  - [ ] Message: "ğŸ”¥ Add savings today to maintain your 7-week streak!"
  - [ ] Include quick action button to add savings
  - [ ] Celebrate when streak is maintained

- [ ] **Task 6: Build Weekly Summary Email** (AC: 5)
  - [ ] Sunday evening cron job
  - [ ] Generate HTML email with:
    - Total saved this week
    - Goals progress (with progress bars)
    - Milestones achieved
    - Upcoming target dates
    - Insights and recommendations
  - [ ] Use email template with TRIBE branding
  - [ ] Allow users to opt-in/opt-out in settings
  - [ ] Include "View in App" CTA button

- [ ] **Task 7: Create Monthly Progress Report** (AC: 10)
  - [ ] First day of month cron job
  - [ ] Generate comprehensive report:
    - Monthly savings summary
    - Goals completed this month
    - Overall progress across all goals
    - Savings velocity metrics
    - Achievements and milestones
    - Next month's recommendations
  - [ ] Send as email and in-app notification
  - [ ] PDF attachment option

- [ ] **Task 8: Build Notification Preferences** (AC: 7)
  - [ ] Add to user settings page
  - [ ] Toggle for each notification type:
    - Milestone notifications âœ“
    - Goal completion âœ“
    - Weekly reminders âœ“
    - Behind schedule alerts âœ“
    - Streak risk alerts âœ“
    - Weekly summary email âœ— (default off)
    - Monthly report email âœ“
  - [ ] Choose delivery methods: Push, Email, Both
  - [ ] Set quiet hours (don't send between 10 PM - 8 AM)
  - [ ] Test notification button to preview

- [ ] **Task 9: Implement Smart Timing** (AC: 8)
  - [ ] Analyze user's savings activity patterns
  - [ ] Identify peak saving days and times
  - [ ] Schedule reminders at optimal times
  - [ ] Example: User saves most on Friday evenings â†’ send reminder Friday 3 PM
  - [ ] Update timing preferences as patterns evolve
  - [ ] Store in user preferences: `reminderDay`, `reminderHour`

---

## Technical Implementation Notes

### Push Notification Setup
```typescript
// Using Web Push API
async function sendPushNotification(userId: string, notification: Notification) {
  const user = await ctx.db.get(userId);
  if (!user.pushSubscription) return;

  const payload = {
    title: notification.title,
    body: notification.message,
    icon: "/icon-192.png",
    badge: "/badge-72.png",
    data: {
      url: `/finances?goalId=${notification.metadata.goalId}`,
      type: notification.type,
    },
  };

  await webpush.sendNotification(
    user.pushSubscription,
    JSON.stringify(payload)
  );
}
```

### Weekly Reminder Cron Job
```typescript
// convex/crons.ts
crons.daily(
  "send-weekly-savings-reminders",
  { hourUTC: 18, minuteUTC: 0 }, // 6 PM UTC
  internal.notifications.sendWeeklyReminders
);

// convex/notifications.ts
export const sendWeeklyReminders = internalAction({
  handler: async (ctx) => {
    const users = await ctx.runQuery(internal.users.getActiveUsers);

    for (const user of users) {
      // Check if Friday (day 5)
      const userTimezone = user.timezone || "UTC";
      const userDay = new Date().toLocaleDateString("en-US", {
        weekday: "numeric",
        timeZone: userTimezone,
      });

      if (userDay !== "5") continue; // Not Friday for this user

      // Check if contributed this week
      const weekStart = getWeekStart();
      const contributions = await ctx.runQuery(
        internal.financial.getWeeklySavingsActivity,
        { userId: user._id, weekStart }
      );

      if (contributions.length === 0) {
        // No contributions this week - send reminder
        await ctx.runMutation(internal.notifications.create, {
          userId: user._id,
          type: "weekly_reminder",
          title: "ğŸ’° Weekly Savings Reminder",
          message: `You haven't added to your savings this week. Keep your streak alive!`,
          metadata: {},
        });

        if (user.preferences.pushNotifications) {
          await sendPushNotification(user._id, notification);
        }
      }
    }
  },
});
```

### Behind Schedule Alert
```typescript
// Daily cron to check goal risk
export const checkGoalsAtRisk = internalAction({
  handler: async (ctx) => {
    const goals = await ctx.runQuery(internal.financial.getAllActiveGoals);

    for (const goal of goals) {
      const riskAnalysis = analyzeGoalRisk(goal);

      if (riskAnalysis.riskLevel === "high") {
        // Check if already alerted this week
        const lastAlert = await ctx.runQuery(
          internal.notifications.getLastAlert,
          { goalId: goal._id, type: "behind_schedule" }
        );

        if (!lastAlert || Date.now() - lastAlert.createdAt > 7 * 24 * 60 * 60 * 1000) {
          await ctx.runMutation(internal.notifications.create, {
            userId: goal.userId,
            type: "behind_schedule",
            title: `âš ï¸ ${goal.name} Behind Schedule`,
            message: `Save $${riskAnalysis.recommendedWeeklySavings}/week to get back on track`,
            metadata: {
              goalId: goal._id,
              amount: riskAnalysis.recommendedWeeklySavings,
            },
          });
        }
      }
    }
  },
});
```

### Email Template (Weekly Summary)
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; }
    .header { background: #000; color: #fff; padding: 20px; text-align: center; }
    .goal-card { border: 4px solid #000; margin: 20px 0; padding: 15px; }
    .progress-bar { height: 24px; background: #e5e7eb; border: 2px solid #000; }
    .progress-fill { height: 100%; background: #3b82f6; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ’° Your Weekly Savings Summary</h1>
  </div>

  <div style="padding: 20px;">
    <h2>Total Saved This Week: $250 CAD</h2>
    <p>Great job! You're making steady progress toward your goals.</p>

    <div class="goal-card">
      <h3>ğŸ¯ Emergency Fund</h3>
      <p>$2,750 / $5,000 (55%)</p>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 55%"></div>
      </div>
    </div>

    <h3>ğŸ‰ Milestones This Week</h3>
    <ul>
      <li>Emergency Fund: Reached 50% milestone!</li>
    </ul>

    <h3>ğŸ’¡ This Week's Insight</h3>
    <p>You're averaging $125/week. At this rate, you'll complete Emergency Fund in 18 weeks!</p>

    <a href="https://tribe.app/finances" style="display: inline-block; background: #000; color: #fff; padding: 12px 24px; text-decoration: none; margin-top: 20px;">
      View in App
    </a>
  </div>
</body>
</html>
```

---

## Dependencies

- **Libraries**: web-push (push notifications), nodemailer (emails)
- **Convex Tables**: notifications (new), users (add pushSubscription field)
- **Environment Variables**: VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, EMAIL_API_KEY
- **Related Stories**: 9.7 (Goal Creation), 9.8 (Progress Tracking)

---

## Notification Types & Messages

### Milestone Achieved
```
Title: ğŸ‰ Milestone Reached!
Message: You've saved 50% toward Emergency Fund! $2,500 saved, halfway there!
```

### Goal Completed
```
Title: ğŸŠ Goal Achieved!
Message: Congratulations! You've completed Emergency Fund with $5,000 saved!
```

### Weekly Reminder
```
Title: ğŸ’° Weekly Savings Reminder
Message: You haven't added to your savings this week. Keep your 7-week streak alive!
```

### Behind Schedule Alert
```
Title: âš ï¸ Travel Fund Behind Schedule
Message: You're 20% behind schedule. Save $75/week to get back on track.
```

### Streak Risk Alert
```
Title: ğŸ”¥ Streak Alert!
Message: Add savings today to maintain your 7-week streak! Don't break the chain!
```

---

## User Preferences Schema
```typescript
// Add to users table
userPreferences: v.object({
  notifications: v.object({
    milestones: v.boolean(),         // default: true
    goalCompletion: v.boolean(),     // default: true
    weeklyReminders: v.boolean(),    // default: true
    behindSchedule: v.boolean(),     // default: true
    streakRisk: v.boolean(),         // default: true
    weeklySummaryEmail: v.boolean(), // default: false
    monthlyReport: v.boolean(),      // default: true
  }),
  quietHours: v.object({
    enabled: v.boolean(),
    start: v.number(),  // Hour 0-23
    end: v.number(),    // Hour 0-23
  }),
  timezone: v.string(),
})
```

---

## Testing Strategy

1. **Milestone Notifications**:
   - Update goal to 25% â†’ Notification created
   - Update goal to 50% â†’ Notification created
   - Update goal to 100% â†’ Special completion notification
   - Rapid updates â†’ Only create notification once per milestone

2. **Weekly Reminders**:
   - Week with contributions â†’ No reminder sent
   - Week without contributions â†’ Reminder sent on Friday
   - User disabled reminders â†’ No notification sent
   - User in quiet hours â†’ Notification delayed

3. **Behind Schedule Alerts**:
   - Goal on track â†’ No alert
   - Goal 15% behind â†’ Alert created
   - Already alerted this week â†’ No duplicate
   - Goal recovers â†’ No more alerts

4. **Email Delivery**:
   - Test email rendering in different clients
   - Test opt-out functionality
   - Test email sending limits (avoid spam)
   - Test personalization accuracy

---

## Performance & Scalability

- Batch notification sending (100 users per batch)
- Queue system for push notifications
- Rate limiting on email sending
- Cache user preferences to avoid repeated queries
- Debounce notification creation (avoid duplicates)
- Monitor notification open rates
- A/B test notification messaging
