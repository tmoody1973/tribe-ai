# Story 10.3: Migrate Housing Search Tool to ADK

## Status

**Completed**

---

## Story

**As a** user,
**I want** housing resource search to work through the ADK agent,
**so that** I can find housing assistance in my destination country.

---

## Acceptance Criteria

1. Create `searchHousingResources` tool in ADK agent with parameters: country, continent, resourceType
2. Tool reads housing data from `data/migrant_housing_resources.json` (copied to agent directory)
3. Returns structured results: organization, url, description, type, services
4. Limits results to 10 most relevant matches
5. If no results found, suggests live search with quota warning
6. Frontend `useRenderToolCall` renders `HousingResourcesCard` component for results
7. Loading state shows "Searching housing resources in {country}..."
8. Tool results match existing functionality in legacy route.ts

---

## Tasks / Subtasks

- [x] **Task 1: Copy Housing Data to Agent** (AC: 2)
  - [x] Copy `apps/web/data/migrant_housing_resources.json` to `agents/tribe_agent/data/`
  - [x] Verify JSON structure is valid
  - [x] Add data directory to .gitignore if contains sensitive info

- [x] **Task 2: Create Housing Search Tool** (AC: 1, 3, 4, 5)
  - [x] Create `agents/tribe_agent/tools/housing.py`
  - [x] Define `search_housing_resources` function with FunctionTool decorator
  - [x] Parameters: country (str, optional), continent (str, optional), resource_type (str, optional)
  - [x] Load housing data from JSON file
  - [x] Filter by country (case-insensitive, partial match)
  - [x] Filter by continent (case-insensitive)
  - [x] Filter by resource_type (case-insensitive)
  - [x] Limit results to 10
  - [x] Return structured response with metadata
  - [x] If no results, return suggestion for live search

- [x] **Task 3: Register Tool with Agent** (AC: 1)
  - [x] Import housing tool in agent.py
  - [x] Add to agent's tools list
  - [x] Test tool registration

- [x] **Task 4: Create Frontend Generative UI** (AC: 6, 7)
  - [x] Create `components/chat/HousingResourcesCard.tsx`
  - [x] Design card with RetroUI neobrutalist styling
  - [x] Show organization name, type, description
  - [x] External link button to resource URL
  - [x] Services list with icons
  - [x] Loading spinner with country name

- [x] **Task 5: Register Tool Renderer** (AC: 6)
  - [x] Add `useCopilotAction` hook with `available: "remote"` for `search_housing_resources`
  - [x] Handle inProgress, complete, and error states
  - [x] Render HousingResourcesCard for results
  - [x] Render LiveSearchPrompt if suggestion returned

- [x] **Task 6: Test Parity with Legacy** (AC: 8)
  - [x] Compare results with legacy route.ts output
  - [x] Verify same filtering logic
  - [x] Check response format matches
  - [x] Test edge cases: empty results, no filters, all filters

---

## Technical Implementation Notes

### Housing Search Tool (Python)
```python
# agents/tribe_agent/tools/housing.py
import json
from pathlib import Path
from google.adk.tools import FunctionTool

# Load housing data at module level
DATA_PATH = Path(__file__).parent.parent / "data" / "migrant_housing_resources.json"
with open(DATA_PATH) as f:
    HOUSING_DATA = json.load(f)

@FunctionTool
async def search_housing_resources(
    country: str = None,
    continent: str = None,
    resource_type: str = None
) -> dict:
    """
    Search for housing resources and assistance programs for migrants and refugees.

    Args:
        country: Destination country to search (e.g., 'United States', 'Canada')
        continent: Filter by continent (e.g., 'North America', 'Europe')
        resource_type: Type of resource (e.g., 'Government Agency', 'NGO')

    Returns:
        dict with total_found, results array, and metadata
    """
    results = HOUSING_DATA.get("housing_resources", [])

    # Filter by country
    if country:
        country_lower = country.lower()
        results = [
            r for r in results
            if country_lower in r["country"].lower() or
               r.get("country_code", "").lower() == country_lower
        ]

    # Filter by continent
    if continent:
        continent_lower = continent.lower()
        results = [
            r for r in results
            if continent_lower in r["continent"].lower()
        ]

    # Extract resources and filter by type
    all_resources = []
    for country_data in results:
        for resource in country_data.get("resources", []):
            all_resources.append({
                "country": country_data["country"],
                "continent": country_data["continent"],
                **resource
            })

    if resource_type:
        type_lower = resource_type.lower()
        all_resources = [
            r for r in all_resources
            if type_lower in r["resource_type"].lower()
        ]

    # Limit to 10 results
    limited = all_resources[:10]

    # If no results, suggest live search
    if len(all_resources) == 0 and country:
        return {
            "total_found": 0,
            "results": [],
            "metadata": HOUSING_DATA.get("metadata", {}),
            "suggestion": {
                "message": f"No housing resources found for {country}. Would you like me to search for the latest programs?",
                "action": "searchLiveData",
                "actionLabel": "Search Live Data",
                "note": "Uses 1 of 50 monthly live searches"
            }
        }

    return {
        "total_found": len(all_resources),
        "results": [
            {
                "country": r["country"],
                "continent": r["continent"],
                "organization": r["organization_name"],
                "url": r["url"],
                "description": r["description"],
                "type": r["resource_type"],
                "services": r.get("services", [])
            }
            for r in limited
        ],
        "metadata": HOUSING_DATA.get("metadata", {})
    }
```

### Frontend Card Component
```typescript
// components/chat/HousingResourcesCard.tsx
"use client";

import { ExternalLink, Home, Building2, Globe } from "lucide-react";

interface HousingResource {
  country: string;
  continent: string;
  organization: string;
  url: string;
  description: string;
  type: string;
  services: string[];
}

interface HousingResourcesCardProps {
  results: HousingResource[];
  totalFound: number;
}

export function HousingResourcesCard({ results, totalFound }: HousingResourcesCardProps) {
  return (
    <div className="border-4 border-black p-4 bg-yellow-100 shadow-[4px_4px_0_0_#000]">
      <div className="flex items-center gap-2 mb-3">
        <Home className="w-5 h-5" />
        <h3 className="font-bold text-lg">Housing Resources</h3>
        <span className="text-sm text-gray-600">({totalFound} found)</span>
      </div>

      <div className="space-y-3">
        {results.map((resource, idx) => (
          <div
            key={idx}
            className="border-2 border-black p-3 bg-white"
          >
            <div className="flex justify-between items-start">
              <div>
                <h4 className="font-bold">{resource.organization}</h4>
                <p className="text-sm text-gray-600">{resource.type}</p>
              </div>
              <a
                href={resource.url}
                target="_blank"
                rel="noopener noreferrer"
                className="p-2 border-2 border-black bg-blue-200 hover:bg-blue-300"
              >
                <ExternalLink className="w-4 h-4" />
              </a>
            </div>
            <p className="mt-2 text-sm">{resource.description}</p>
            {resource.services.length > 0 && (
              <div className="mt-2 flex flex-wrap gap-1">
                {resource.services.slice(0, 3).map((service, i) => (
                  <span
                    key={i}
                    className="text-xs px-2 py-1 bg-gray-100 border border-black"
                  >
                    {service}
                  </span>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Tool Renderer Hook
```typescript
// In ChatProvider or similar
useRenderToolCall({
  name: "search_housing_resources",
  render: ({ status, args, result }) => {
    if (status === "inProgress") {
      return (
        <div className="flex items-center gap-2 p-3 border-2 border-black bg-gray-100">
          <Loader2 className="w-4 h-4 animate-spin" />
          <span>Searching housing resources in {args.country || "all countries"}...</span>
        </div>
      );
    }

    if (status === "complete") {
      if (result?.suggestion) {
        return <LiveSearchPrompt suggestion={result.suggestion} />;
      }
      return (
        <HousingResourcesCard
          results={result.results}
          totalFound={result.total_found}
        />
      );
    }

    return null;
  },
});
```

---

## Dependencies

- **Upstream**: Story 10.1 (ADK Agent), Story 10.2 (CopilotRuntime)
- **Downstream**: Story 10.7 (Generative UI consolidation)
- **Data**: `apps/web/data/migrant_housing_resources.json`

---

## Testing Strategy

### Test Cases

1. **Tool Registration**:
   - Tool appears in agent's available tools
   - Tool schema matches expected parameters

2. **Filtering**:
   - Search by country returns correct results
   - Search by continent filters correctly
   - Search by resource_type works
   - Combined filters work together

3. **Result Limiting**:
   - Returns max 10 results
   - Total count shows all matches

4. **Empty Results**:
   - Returns suggestion for live search
   - Suggestion includes quota warning

5. **Frontend Rendering**:
   - Card displays during search
   - Results render correctly
   - Links open in new tab
   - Services display properly

6. **Parity**:
   - Same results as legacy implementation
   - Same response format
