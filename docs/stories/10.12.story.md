# Story 10.12: Migration Cleanup and Testing

## Status

**Draft**

---

## Story

**As a** developer,
**I want** legacy chat code removed and comprehensive tests in place,
**so that** the codebase is clean and the new chat is verified.

---

## Acceptance Criteria

1. Remove `lib/adapters/gemini3-adapter.ts` (deprecated)
2. Remove legacy action definitions from old route.ts (now in ADK agent)
3. Update CopilotProvider to remove legacy configuration
4. E2E test: User sends message → Agent responds with streaming text
5. E2E test: User asks about housing → HousingCard renders
6. E2E test: User asks about visa → VisaCard renders with pathways
7. E2E test: Shared state (corridor) reflected in agent responses
8. Performance test: Chat response under 2s for 95th percentile
9. Error handling test: Agent disconnection shows helpful error
10. Update CLAUDE.md with new ADK model guidance

---

## Tasks / Subtasks

- [ ] **Task 1: Remove Legacy Code** (AC: 1, 2, 3)
  - [ ] Delete `apps/web/lib/adapters/gemini3-adapter.ts`
  - [ ] Remove action definitions from route.ts (now in ADK agent):
    - searchHousingResources
    - searchLiveData
    - searchVisaOptions
  - [ ] Remove legacy imports (fs, path for housing data)
  - [ ] Remove `GoogleGenerativeAIAdapter` references
  - [ ] Clean up unused ConvexHttpClient for actions
  - [ ] Remove any commented legacy code
  - [ ] Update imports in affected files

- [ ] **Task 2: Update CopilotProvider** (AC: 3)
  - [ ] Remove any legacy props from CopilotKit
  - [ ] Verify `agent="tribe_agent"` is set
  - [ ] Remove deprecated adapter configuration
  - [ ] Clean up unused hooks

- [ ] **Task 3: Create E2E Test Suite** (AC: 4, 5, 6, 7)
  - [ ] Set up Playwright or Cypress for E2E tests
  - [ ] Create test for basic chat flow
  - [ ] Create test for housing search and card render
  - [ ] Create test for visa search and card render
  - [ ] Create test for corridor context in responses

- [ ] **Task 4: Create Performance Tests** (AC: 8)
  - [ ] Set up performance test framework
  - [ ] Test chat response latency
  - [ ] Measure 95th percentile response time
  - [ ] Create baseline metrics document

- [ ] **Task 5: Create Error Handling Tests** (AC: 9)
  - [ ] Test agent disconnection handling
  - [ ] Test network timeout handling
  - [ ] Test invalid response handling
  - [ ] Verify error messages are user-friendly

- [ ] **Task 6: Update Documentation** (AC: 10)
  - [ ] Update CLAUDE.md with new model guidance
  - [ ] Document ADK agent architecture
  - [ ] Add troubleshooting section
  - [ ] Update any README references to chat

---

## Technical Implementation Notes

### Files to Delete
```
apps/web/lib/adapters/gemini3-adapter.ts
```

### Files to Modify

#### route.ts Cleanup
```typescript
// apps/web/app/api/copilotkit/route.ts
// BEFORE (legacy)
import {
  CopilotRuntime,
  copilotRuntimeNextJSAppRouterEndpoint,
  GoogleGenerativeAIAdapter,  // DELETE
} from "@copilotkit/runtime";
import fs from "fs";  // DELETE
import path from "path";  // DELETE
import { ConvexHttpClient } from "convex/browser";  // DELETE (for actions)
import { api, internal } from "@/convex/_generated/api";  // DELETE (for actions)

// DELETE all action definitions
const runtime = new CopilotRuntime({
  actions: [...]  // DELETE entire actions array
});

// AFTER (clean)
import {
  CopilotRuntime,
  ExperimentalEmptyAdapter,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { ADKAgent } from "@ag-ui/adk";

const serviceAdapter = new ExperimentalEmptyAdapter();

const runtime = new CopilotRuntime({
  agents: {
    tribe_agent: new ADKAgent({
      url: process.env.ADK_AGENT_URL || "http://localhost:8000/agui",
    }),
  },
});

export const POST = async (req: Request) => {
  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    serviceAdapter,
    endpoint: "/api/copilotkit",
  });
  return handleRequest(req);
};
```

### E2E Test Examples

#### Basic Chat Test
```typescript
// e2e/chat.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Chat Functionality", () => {
  test.beforeEach(async ({ page }) => {
    // Login and navigate to chat
    await page.goto("/dashboard");
    await page.waitForSelector("[data-testid=chat-input]");
  });

  test("sends message and receives streaming response", async ({ page }) => {
    const input = page.locator("[data-testid=chat-input]");
    const sendButton = page.locator("[data-testid=chat-send]");

    await input.fill("Hello, what can you help me with?");
    await sendButton.click();

    // Wait for response to start streaming
    const response = page.locator("[data-testid=assistant-message]").last();
    await expect(response).toBeVisible({ timeout: 10000 });

    // Response should have content
    await expect(response).not.toBeEmpty();
  });

  test("housing search renders HousingCard", async ({ page }) => {
    const input = page.locator("[data-testid=chat-input]");
    await input.fill("Find housing resources in Canada");
    await page.keyboard.press("Enter");

    // Wait for tool to execute and render
    const housingCard = page.locator("[data-testid=housing-card]");
    await expect(housingCard).toBeVisible({ timeout: 15000 });

    // Card should have results
    const results = housingCard.locator("[data-testid=housing-result]");
    expect(await results.count()).toBeGreaterThan(0);
  });

  test("visa search renders VisaCard", async ({ page }) => {
    const input = page.locator("[data-testid=chat-input]");
    await input.fill("What are the visa requirements for Nigeria to Canada?");
    await page.keyboard.press("Enter");

    // Wait for visa card
    const visaCard = page.locator("[data-testid=visa-card]");
    await expect(visaCard).toBeVisible({ timeout: 15000 });

    // Card should show visa info
    await expect(visaCard.locator("[data-testid=visa-type]")).toBeVisible();
  });

  test("corridor context reflected in responses", async ({ page }) => {
    // Assume user has Nigeria → Canada corridor set
    const input = page.locator("[data-testid=chat-input]");
    await input.fill("What's my destination?");
    await page.keyboard.press("Enter");

    const response = page.locator("[data-testid=assistant-message]").last();
    await expect(response).toContainText(/Canada/i, { timeout: 10000 });
  });
});
```

#### Performance Test
```typescript
// e2e/performance.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Chat Performance", () => {
  test("response time under 2s for 95th percentile", async ({ page }) => {
    await page.goto("/dashboard");
    await page.waitForSelector("[data-testid=chat-input]");

    const responseTimes: number[] = [];

    // Run 20 queries
    for (let i = 0; i < 20; i++) {
      const startTime = Date.now();

      await page.locator("[data-testid=chat-input]").fill(`Test query ${i}`);
      await page.keyboard.press("Enter");

      // Wait for response
      await page.waitForSelector("[data-testid=assistant-message]:last-child", {
        timeout: 10000,
      });

      const endTime = Date.now();
      responseTimes.push(endTime - startTime);

      // Small delay between queries
      await page.waitForTimeout(500);
    }

    // Calculate 95th percentile
    responseTimes.sort((a, b) => a - b);
    const p95Index = Math.floor(responseTimes.length * 0.95);
    const p95 = responseTimes[p95Index];

    console.log("Response times:", responseTimes);
    console.log("95th percentile:", p95, "ms");

    expect(p95).toBeLessThan(2000);
  });
});
```

#### Error Handling Test
```typescript
// e2e/error-handling.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Error Handling", () => {
  test("shows helpful error when agent disconnected", async ({ page }) => {
    // Mock agent endpoint to fail
    await page.route("**/api/copilotkit", async (route) => {
      await route.abort("connectionfailed");
    });

    await page.goto("/dashboard");
    const input = page.locator("[data-testid=chat-input]");
    await input.fill("Hello");
    await page.keyboard.press("Enter");

    // Should show error message
    const error = page.locator("[data-testid=chat-error]");
    await expect(error).toBeVisible({ timeout: 5000 });
    await expect(error).toContainText(/unavailable|try again/i);
  });
});
```

### CLAUDE.md Updates
```markdown
## AI Models

This project uses Google Gemini models. Use these specific model IDs:

| Use Case | Model ID |
|----------|----------|
| Chat (ADK Agent) | `gemini-2.5-flash` |
| Mastra Agents | `google/gemini-2.5-flash` |
| Voice/Live API | `gemini-2.0-flash-live-preview-04-09` |

**Important:**
- Chat is handled by Google ADK agent (Python/FastAPI), NOT in-process
- Do NOT use `gemini-3-flash-preview` - it has "thinking mode" that causes parsing issues
- CopilotKit uses `ExperimentalEmptyAdapter` since LLM is external
- ADK agent communicates via AG-UI protocol over SSE
- See: agents/tribe_agent/ for ADK agent code
```

---

## Dependencies

- **Upstream**: All Epic 10 stories (10.1-10.11)
- **Testing**: Playwright or Cypress
- **Documentation**: CLAUDE.md, README.md

---

## Testing Strategy

### Test Coverage Requirements

1. **Unit Tests**:
   - Tool renderers render correctly
   - State hooks work as expected
   - Error components display properly

2. **Integration Tests**:
   - CopilotKit connects to ADK agent
   - Tools execute and return results
   - State synchronization works

3. **E2E Tests**:
   - Full chat flow
   - Tool rendering
   - Error handling
   - Performance benchmarks

4. **Regression Tests**:
   - No legacy code remains
   - All imports resolved
   - Build passes without warnings

### Definition of Done

- [ ] All legacy code removed
- [ ] All E2E tests passing
- [ ] Performance meets NFR2 (<2s response)
- [ ] Error handling verified
- [ ] Documentation updated
- [ ] Build passes
- [ ] No console errors in production
