# Story 3.1: Corridor Selection & Dashboard Layout

## Status

**Complete**

---

## Story

**As a** user,
**I want** to see my corridor dashboard immediately after login,
**so that** I can access my migration intelligence quickly.

---

## Acceptance Criteria

1. Dashboard page loads user's corridor from profile
2. Dashboard header shows corridor (e.g., "Nigeria ‚Üí Germany")
3. Dashboard displays user's current stage prominently
4. Quick stats section shows: visa type, cost comparison, language
5. Loading state while fetching protocol data
6. Empty state for new corridors being researched
7. RetroUI card-based layout for all dashboard sections

---

## Tasks / Subtasks

- [x] **Task 1: Create Dashboard Page** (AC: 1, 7)
  - [x] Create `app/[locale]/(dashboard)/dashboard/page.tsx`
  - [x] Fetch user's active corridor via `getActiveCorridor` query
  - [x] Handle loading state with skeleton UI
  - [x] Handle no corridor state (redirect to onboarding)
  - [x] Apply RetroUI card styling

- [x] **Task 2: Create Corridor Header Component** (AC: 2, 3)
  - [x] Create `components/corridor/CorridorHeader.tsx`
  - [x] Display origin ‚Üí destination with country flags
  - [x] Show current stage badge (Dreaming, Planning, etc.)
  - [x] Add "Change Corridor" button (optional for MVP)
  - [x] Style with bold RetroUI typography

- [x] **Task 3: Create Quick Stats Component** (AC: 4)
  - [x] Create `components/corridor/QuickStats.tsx`
  - [x] Display visa requirement type
  - [x] Show cost of living comparison (if available)
  - [x] Display destination language
  - [x] Show timezone difference
  - [x] Fetch data via `getCorridorBaseline` action

- [x] **Task 4: Create Dashboard Layout Grid** (AC: 7)
  - [x] Design responsive grid layout
  - [x] Mobile: single column stack
  - [x] Desktop: 2-column or 3-column grid
  - [x] Sidebar for quick actions (optional)

- [x] **Task 5: Create Loading State** (AC: 5)
  - [x] Create `components/corridor/DashboardSkeleton.tsx`
  - [x] Skeleton cards matching final layout
  - [x] Animate with pulse effect
  - [x] Show while protocols loading

- [x] **Task 6: Create Empty State** (AC: 6)
  - [x] Create `components/corridor/EmptyState.tsx`
  - [x] Message: "Researching your corridor..."
  - [x] Show animated progress indicator
  - [x] Display estimated time
  - [x] Trigger research if not started

- [x] **Task 7: Add Dashboard Translations** (AC: 2, 3, 4)
  - [x] Add dashboard keys to all 9 locale files
  - [x] Keys: header, stats labels, stage names
  - [x] Verify translations display correctly

---

## Dev Notes

### Dashboard Page Structure
[Source: architecture.md#routing-architecture]

```typescript
// app/[locale]/(dashboard)/dashboard/page.tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useRequireOnboarding } from "@/hooks/useRequireOnboarding";
import { CorridorHeader } from "@/components/corridor/CorridorHeader";
import { QuickStats } from "@/components/corridor/QuickStats";
import { ProtocolList } from "@/components/protocol/ProtocolList";
import { DashboardSkeleton } from "@/components/corridor/DashboardSkeleton";
import { EmptyState } from "@/components/corridor/EmptyState";

export default function DashboardPage() {
  // Ensure onboarding complete
  const { profile, isLoading: profileLoading } = useRequireOnboarding();

  // Get active corridor
  const corridor = useQuery(api.corridors.getActiveCorridor);

  // Get protocols with freshness
  const protocolData = useQuery(
    api.protocols.getProtocolsWithFreshness,
    corridor ? { corridorId: corridor._id } : "skip"
  );

  if (profileLoading || corridor === undefined) {
    return <DashboardSkeleton />;
  }

  if (!corridor) {
    // No corridor - should redirect to onboarding
    return null;
  }

  const protocols = protocolData?.protocols ?? [];
  const isResearching = protocolData?.freshness?.status === "refreshing";

  return (
    <div className="space-y-6">
      <CorridorHeader corridor={corridor} />

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="md:col-span-2">
          {protocols.length === 0 && isResearching ? (
            <EmptyState corridorId={corridor._id} />
          ) : (
            <ProtocolList protocols={protocols} corridorId={corridor._id} />
          )}
        </div>

        <div className="space-y-6">
          <QuickStats corridorId={corridor._id} />
        </div>
      </div>
    </div>
  );
}
```

### Corridor Header Component
[Source: architecture.md#components]

```typescript
// components/corridor/CorridorHeader.tsx
"use client";

import { useTranslations } from "next-intl";
import { Doc } from "@/convex/_generated/dataModel";
import { CountryFlag } from "@/components/ui/CountryFlag";
import { StageBadge } from "@/components/corridor/StageBadge";

interface CorridorHeaderProps {
  corridor: Doc<"corridors">;
}

export function CorridorHeader({ corridor }: CorridorHeaderProps) {
  const t = useTranslations("dashboard");

  return (
    <div className="border-4 border-black bg-white p-6 shadow-[4px_4px_0_0_#000]">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        {/* Corridor Route */}
        <div className="flex items-center gap-3">
          <CountryFlag code={corridor.origin} size="lg" />
          <span className="text-2xl font-black">‚Üí</span>
          <CountryFlag code={corridor.destination} size="lg" />
          <div className="ml-2">
            <h1 className="text-2xl font-black">
              {t("yourJourney")}
            </h1>
            <p className="text-gray-600">
              {getCountryName(corridor.origin)} ‚Üí {getCountryName(corridor.destination)}
            </p>
          </div>
        </div>

        {/* Stage Badge */}
        <StageBadge stage={corridor.stage} />
      </div>
    </div>
  );
}

function getCountryName(code: string): string {
  // Use Intl.DisplayNames for localized country names
  const names = new Intl.DisplayNames(["en"], { type: "region" });
  return names.of(code) ?? code;
}
```

### Quick Stats Component
[Source: architecture.md#components]

```typescript
// components/corridor/QuickStats.tsx
"use client";

import { useAction, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useTranslations } from "next-intl";
import { Id } from "@/convex/_generated/dataModel";
import { useEffect, useState } from "react";

interface QuickStatsProps {
  corridorId: Id<"corridors">;
}

export function QuickStats({ corridorId }: QuickStatsProps) {
  const t = useTranslations("dashboard.stats");
  const corridor = useQuery(api.corridors.getCorridor, { id: corridorId });
  const [baseline, setBaseline] = useState<any>(null);

  const getBaseline = useAction(api.corridorData.getCorridorBaseline);

  useEffect(() => {
    if (corridor) {
      getBaseline({
        origin: corridor.origin,
        destination: corridor.destination,
      }).then(setBaseline);
    }
  }, [corridor?.origin, corridor?.destination]);

  if (!corridor) return null;

  return (
    <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
      <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
        {t("title")}
      </h3>

      <div className="space-y-4">
        {/* Visa Status */}
        <StatItem
          label={t("visaRequired")}
          value={baseline?.visa?.visaRequired ? t("yes") : t("no")}
          icon="üõÇ"
        />

        {/* Visa Type */}
        {baseline?.visa?.visaType && (
          <StatItem
            label={t("visaType")}
            value={baseline.visa.visaType}
            icon="üìã"
          />
        )}

        {/* Language */}
        <StatItem
          label={t("language")}
          value={baseline?.destination?.languages?.[0] ?? "‚Äî"}
          icon="üó£Ô∏è"
        />

        {/* Currency */}
        <StatItem
          label={t("currency")}
          value={baseline?.destination?.currencies?.[0]?.code ?? "‚Äî"}
          icon="üí∞"
        />

        {/* Timezone */}
        <StatItem
          label={t("timezone")}
          value={baseline?.destination?.timezone ?? "‚Äî"}
          icon="üïê"
        />
      </div>
    </div>
  );
}

function StatItem({ label, value, icon }: { label: string; value: string; icon: string }) {
  return (
    <div className="flex items-center justify-between">
      <span className="text-gray-600 flex items-center gap-2">
        <span>{icon}</span>
        {label}
      </span>
      <span className="font-bold">{value}</span>
    </div>
  );
}
```

### Stage Badge Component
```typescript
// components/corridor/StageBadge.tsx
"use client";

import { useTranslations } from "next-intl";

const stageColors: Record<string, string> = {
  dreaming: "bg-purple-100 text-purple-800 border-purple-800",
  planning: "bg-blue-100 text-blue-800 border-blue-800",
  preparing: "bg-yellow-100 text-yellow-800 border-yellow-800",
  relocating: "bg-orange-100 text-orange-800 border-orange-800",
  settling: "bg-green-100 text-green-800 border-green-800",
};

interface StageBadgeProps {
  stage: string;
}

export function StageBadge({ stage }: StageBadgeProps) {
  const t = useTranslations("onboarding.stages");

  return (
    <span
      className={`px-4 py-2 border-2 font-bold text-sm ${stageColors[stage] ?? "bg-gray-100"}`}
    >
      {t(`${stage}.title`)}
    </span>
  );
}
```

### Dashboard Skeleton
```typescript
// components/corridor/DashboardSkeleton.tsx
export function DashboardSkeleton() {
  return (
    <div className="space-y-6 animate-pulse">
      {/* Header Skeleton */}
      <div className="border-4 border-gray-200 bg-gray-100 p-6 h-24" />

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Protocol List Skeleton */}
        <div className="md:col-span-2 space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="border-4 border-gray-200 bg-gray-100 p-4 h-32" />
          ))}
        </div>

        {/* Stats Skeleton */}
        <div className="border-4 border-gray-200 bg-gray-100 p-4 h-64" />
      </div>
    </div>
  );
}
```

### Empty State Component
```typescript
// components/corridor/EmptyState.tsx
"use client";

import { useTranslations } from "next-intl";
import { useAction } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { useEffect } from "react";

interface EmptyStateProps {
  corridorId: Id<"corridors">;
}

export function EmptyState({ corridorId }: EmptyStateProps) {
  const t = useTranslations("dashboard.empty");
  const generateProtocols = useAction(api.ai.pipeline.generateCorridorProtocols);

  useEffect(() => {
    // Trigger research if not already running
    generateProtocols({ corridorId }).catch(console.error);
  }, [corridorId]);

  return (
    <div className="border-4 border-black bg-yellow-50 p-8 text-center">
      <div className="animate-spin text-4xl mb-4">üîç</div>
      <h3 className="text-xl font-bold mb-2">{t("title")}</h3>
      <p className="text-gray-600">{t("description")}</p>
      <p className="text-sm text-gray-500 mt-4">{t("estimatedTime")}</p>
    </div>
  );
}
```

### Country Flag Component
```typescript
// components/ui/CountryFlag.tsx
interface CountryFlagProps {
  code: string;
  size?: "sm" | "md" | "lg";
}

const sizes = {
  sm: "w-6 h-4",
  md: "w-8 h-6",
  lg: "w-12 h-8",
};

export function CountryFlag({ code, size = "md" }: CountryFlagProps) {
  // Use flag CDN (flagcdn.com or similar)
  return (
    <img
      src={`https://flagcdn.com/${code.toLowerCase()}.svg`}
      alt={code}
      className={`${sizes[size]} object-cover border border-black`}
    />
  );
}
```

### Translation Keys
```json
// messages/en.json - Add dashboard section
{
  "dashboard": {
    "yourJourney": "Your Journey",
    "empty": {
      "title": "Researching your corridor...",
      "description": "We're gathering the latest migration intelligence for you.",
      "estimatedTime": "This usually takes 1-2 minutes"
    },
    "stats": {
      "title": "Quick Stats",
      "visaRequired": "Visa Required",
      "visaType": "Visa Type",
      "language": "Language",
      "currency": "Currency",
      "timezone": "Timezone",
      "yes": "Yes",
      "no": "No"
    }
  }
}
```

### File Structure
```
components/
‚îú‚îÄ‚îÄ corridor/
‚îÇ   ‚îú‚îÄ‚îÄ CorridorHeader.tsx
‚îÇ   ‚îú‚îÄ‚îÄ QuickStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ StageBadge.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DashboardSkeleton.tsx
‚îÇ   ‚îî‚îÄ‚îÄ EmptyState.tsx
‚îî‚îÄ‚îÄ ui/
    ‚îî‚îÄ‚îÄ CountryFlag.tsx

app/
‚îî‚îÄ‚îÄ [locale]/
    ‚îî‚îÄ‚îÄ (dashboard)/
        ‚îî‚îÄ‚îÄ dashboard/
            ‚îî‚îÄ‚îÄ page.tsx
```

### Dependencies from Previous Stories
- Story 1.4: Dashboard layout, Header component
- Story 1.5: Onboarding check hook
- Story 2.1: Corridors table, queries
- Story 2.2: getCorridorBaseline action
- Story 2.5: getProtocolsWithFreshness query

---

## Testing

### Test Scenarios

1. **Dashboard Load**
   - [ ] Login with completed onboarding
   - [ ] Dashboard loads without errors
   - [ ] Corridor header shows origin ‚Üí destination

2. **Quick Stats**
   - [ ] Visa requirement displayed
   - [ ] Language and currency shown
   - [ ] Handles missing data gracefully

3. **Loading State**
   - [ ] Skeleton shows while loading
   - [ ] Transitions smoothly to content

4. **Empty State**
   - [ ] New corridor shows "Researching..."
   - [ ] Research triggers automatically
   - [ ] Updates when protocols ready

5. **Responsive Design**
   - [ ] Mobile: single column
   - [ ] Desktop: multi-column grid

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed ESLint errors: unused corridorId prop, useEffect dependencies, img element warning
- Fixed TypeScript circular type inference in maintenance.ts
- Fixed query chaining type issue in metrics.ts

### Completion Notes List
- Dashboard page displays corridor header with flags and stage badge
- QuickStats fetches baseline data from REST Countries API
- Empty state triggers research pipeline automatically
- All 9 locales updated with dashboard translations
- RetroUI styling applied throughout

### File List
- `app/[locale]/(dashboard)/dashboard/page.tsx` - Updated dashboard with corridor awareness
- `components/corridor/CorridorHeader.tsx` - NEW: Shows origin ‚Üí destination with flags
- `components/corridor/QuickStats.tsx` - NEW: Displays visa, language, currency, timezone
- `components/corridor/StageBadge.tsx` - NEW: Colored badge for migration stage
- `components/corridor/DashboardSkeleton.tsx` - NEW: Loading state skeleton
- `components/corridor/EmptyState.tsx` - NEW: Research in progress state
- `components/ui/CountryFlag.tsx` - NEW: Flag images from CDN
- `components/protocol/ProtocolList.tsx` - NEW: Protocol list with categories
- `convex/maintenance.ts` - Fixed type annotation
- `convex/metrics.ts` - Fixed query chaining
- `messages/*.json` - All 9 locales updated with dashboard translations

---

## QA Results
*To be filled by QA Agent*
