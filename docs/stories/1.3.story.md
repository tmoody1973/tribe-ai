# Story 1.3: Internationalization Setup with next-intl

## Status

**Complete**

---

## Story

**As a** user,
**I want** the app to display in my preferred language,
**so that** I can understand all interface elements without language barriers.

---

## Acceptance Criteria

1. next-intl configured with App Router integration
2. Locale files created for 9 languages: en, yo, hi, pt, tl, ko, de, fr, es
3. Language detection from browser preferences on first visit
4. Language switcher component functional in header/settings
5. All static UI strings (buttons, labels, navigation) use translation keys
6. Language preference persisted to user profile in Convex
7. URL structure supports locale prefix (`/en/dashboard`, `/yo/dashboard`)

---

## Tasks / Subtasks

- [x] **Task 1: Install and Configure next-intl** (AC: 1)
  - [x] Install: `npm install next-intl`
  - [x] Create `i18n/config.ts` with locale configuration
  - [x] Create `i18n/request.ts` for server-side locale handling
  - [x] Update `next.config.mjs` with next-intl plugin

- [x] **Task 2: Create Locale Message Files** (AC: 2)
  - [x] Create `messages/en.json` with all UI strings
  - [x] Create `messages/yo.json` (Yoruba)
  - [x] Create `messages/hi.json` (Hindi)
  - [x] Create `messages/pt.json` (Portuguese)
  - [x] Create `messages/tl.json` (Tagalog)
  - [x] Create `messages/ko.json` (Korean)
  - [x] Create `messages/de.json` (German)
  - [x] Create `messages/fr.json` (French)
  - [x] Create `messages/es.json` (Spanish)
  - [x] Initial strings: common, navigation, auth, errors, landing, dashboard

- [x] **Task 3: Setup Locale-Based Routing** (AC: 7)
  - [x] Restructure `app/` to `app/[locale]/`
  - [x] Move existing pages under `[locale]` dynamic segment
  - [x] Create `app/[locale]/layout.tsx` with NextIntlClientProvider
  - [x] Update middleware to handle locale detection and routing

- [x] **Task 4: Integrate with Clerk Middleware** (AC: 1, 7)
  - [x] Update `middleware.ts` to chain next-intl with Clerk
  - [x] Ensure locale prefix preserved after auth redirects
  - [x] API routes excluded from intl middleware

- [x] **Task 5: Implement Browser Language Detection** (AC: 3)
  - [x] Configure next-intl to detect Accept-Language header
  - [x] Set fallback locale to 'en'
  - [x] First-time visitors redirected to detected locale
  - [x] localePrefix set to "always"

- [x] **Task 6: Create Language Switcher Component** (AC: 4)
  - [x] Create `components/layout/LanguageSwitcher.tsx`
  - [x] Display current language with flag/name
  - [x] Dropdown with all 9 language options
  - [x] On select: update URL locale prefix
  - [x] Style with RetroUI neobrutalist design

- [x] **Task 7: Persist Language to User Profile** (AC: 6)
  - [x] Update `convex/users.ts` mutation: `updateLanguage` for 9 languages
  - [x] Update `convex/schema.ts` to support 9 language options

- [x] **Task 8: Apply Translations to UI** (AC: 5)
  - [x] Update landing page with translation keys
  - [x] Update dashboard with translation keys
  - [x] Add LanguageSwitcher to landing and dashboard pages
  - [x] Add `useTranslations` hook to components with text

---

## Dev Notes

### next-intl Configuration
[Source: architecture.md#frontend-architecture]

```typescript
// i18n/config.ts
export const locales = ["en", "yo", "hi", "pt", "tl", "ko", "de", "fr", "es"] as const;
export type Locale = (typeof locales)[number];
export const defaultLocale: Locale = "en";

export const localeNames: Record<Locale, string> = {
  en: "English",
  yo: "Yorùbá",
  hi: "हिन्दी",
  pt: "Português",
  tl: "Tagalog",
  ko: "한국어",
  de: "Deutsch",
  fr: "Français",
  es: "Español",
};
```

### File Structure After i18n Setup
```
app/
├── [locale]/                    # All routes under locale
│   ├── layout.tsx               # NextIntlClientProvider
│   ├── page.tsx                 # Landing page
│   ├── dashboard/
│   │   └── page.tsx
│   ├── sign-in/[[...sign-in]]/page.tsx
│   └── sign-up/[[...sign-up]]/page.tsx
├── api/                         # API routes stay outside [locale]
│   ├── health/route.ts
│   └── webhooks/clerk/route.ts
├── layout.tsx                   # Root layout (ClerkProvider, etc.)
├── providers.tsx
└── globals.css

i18n/
├── config.ts                    # Locale configuration
└── request.ts                   # Server request config

messages/
├── en.json
├── yo.json
├── hi.json
├── pt.json
├── tl.json
├── ko.json
├── de.json
├── fr.json
└── es.json

components/
└── layout/
    └── LanguageSwitcher.tsx
```

### Dependencies from Previous Stories
- Story 1.1: Project scaffold, Convex connected
- Story 1.2: Clerk authentication, middleware, users table

---

## Testing

### Test Scenarios

1. **Locale Routing**
   - [ ] Visit `/` → redirected to `/en` (or browser locale)
   - [ ] Visit `/yo/dashboard` → displays Yoruba interface
   - [ ] Visit `/invalid/dashboard` → 404 or redirect to default

2. **Language Switcher**
   - [ ] Switch from English to Yoruba
   - [ ] URL updates to `/yo/...`
   - [ ] All visible text changes language

3. **Language Persistence**
   - [ ] Authenticated user switches to Hindi
   - [ ] Sign out, sign back in
   - [ ] User returns to Hindi interface

4. **Browser Detection**
   - [ ] Set browser language to Portuguese
   - [ ] Visit site for first time
   - [ ] Redirected to `/pt`

5. **Auth Flow with Locale**
   - [ ] Visit `/yo/sign-in`
   - [ ] Sign in successfully
   - [ ] Redirected to `/yo/dashboard` (not `/en/dashboard`)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |
| 2025-12-21 | 1.1 | Implementation complete - expanded to 9 languages | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- User requested additional languages: Korean, German, French, Spanish (expanded from 5 to 9)
- next-intl middleware chained with Clerk middleware for auth + i18n

### Completion Notes List
- next-intl installed and configured with App Router plugin
- 9 language message files created with full UI translations
- App restructured to `app/[locale]/` pattern
- Middleware integrates next-intl with Clerk auth
- LanguageSwitcher component with RetroUI styling
- Convex schema updated to support 9 languages
- Build verified successful

### File List
**Created:**
- `apps/web/i18n/config.ts` - Locale configuration with 9 languages
- `apps/web/i18n/request.ts` - Server-side locale handling
- `apps/web/messages/en.json` - English translations
- `apps/web/messages/yo.json` - Yoruba translations
- `apps/web/messages/hi.json` - Hindi translations
- `apps/web/messages/pt.json` - Portuguese translations
- `apps/web/messages/tl.json` - Tagalog translations
- `apps/web/messages/ko.json` - Korean translations
- `apps/web/messages/de.json` - German translations
- `apps/web/messages/fr.json` - French translations
- `apps/web/messages/es.json` - Spanish translations
- `apps/web/app/[locale]/layout.tsx` - Locale layout with NextIntlClientProvider
- `apps/web/app/[locale]/page.tsx` - Landing page with translations
- `apps/web/app/[locale]/dashboard/page.tsx` - Dashboard with translations
- `apps/web/components/layout/LanguageSwitcher.tsx` - Language switcher component

**Modified:**
- `apps/web/next.config.mjs` - Added next-intl plugin
- `apps/web/middleware.ts` - Integrated next-intl with Clerk
- `apps/web/app/layout.tsx` - Updated for i18n support
- `apps/web/convex/schema.ts` - Added 4 new language options
- `apps/web/convex/users.ts` - Updated updateLanguage mutation

**Moved:**
- `apps/web/app/sign-in/` → `apps/web/app/[locale]/sign-in/`
- `apps/web/app/sign-up/` → `apps/web/app/[locale]/sign-up/`

---

## QA Results
*To be filled by QA Agent*
