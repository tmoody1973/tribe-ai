# Story 10.9: Human-in-the-Loop Approvals

## Status

**Draft**

---

## Story

**As a** user,
**I want** the AI to ask for confirmation before taking significant actions,
**so that** I maintain control over my migration journey data.

---

## Acceptance Criteria

1. `useHumanInTheLoop` hook configured for destructive/expensive actions
2. Actions requiring approval: "Create new corridor", "Refresh all protocols", "Import 50+ expenses"
3. Approval UI shows action description, impact, and confirm/cancel buttons
4. Agent pauses execution until user responds
5. Approval timeout after 60 seconds with auto-cancel
6. Audit log of all approved/rejected actions in chat history
7. HITL patterns match CopilotKit best practices
8. User can skip HITL for trusted actions via preference setting (future)

---

## Tasks / Subtasks

- [ ] **Task 1: Define HITL Actions** (AC: 2)
  - [ ] List all actions requiring approval
  - [ ] Categorize by risk level: high, medium, low
  - [ ] Document impact of each action
  - [ ] Decide which are mandatory vs optional HITL

- [ ] **Task 2: Create ADK Agent HITL Tools** (AC: 1, 4)
  - [ ] Create tools that require user confirmation
  - [ ] Implement `create_corridor_with_approval`
  - [ ] Implement `refresh_protocols_with_approval`
  - [ ] Implement `bulk_import_with_approval`
  - [ ] Tools pause for user response

- [ ] **Task 3: Create Approval UI Component** (AC: 3)
  - [ ] Create `ActionApprovalCard.tsx`
  - [ ] Display action name and description
  - [ ] Show impact summary (what will change)
  - [ ] Confirm button (green, prominent)
  - [ ] Cancel button (red, secondary)
  - [ ] RetroUI styling

- [ ] **Task 4: Implement useHumanInTheLoop** (AC: 1, 4, 5)
  - [ ] Configure hook for HITL actions
  - [ ] Handle approval/rejection responses
  - [ ] Implement 60-second timeout
  - [ ] Auto-cancel with user notification

- [ ] **Task 5: Add Audit Logging** (AC: 6)
  - [ ] Log approval requests to chat history
  - [ ] Log user response (approved/rejected)
  - [ ] Store in Convex for history
  - [ ] Display in chat as system message

- [ ] **Task 6: Test HITL Flow** (AC: all)
  - [ ] Test approval flow end-to-end
  - [ ] Test rejection stops action
  - [ ] Test timeout auto-cancels
  - [ ] Test audit log captures all

---

## Technical Implementation Notes

### HITL Action Definitions
```typescript
// lib/constants/hitl-actions.ts
export const HITL_ACTIONS = {
  // High risk - always require approval
  CREATE_CORRIDOR: {
    name: "create_corridor",
    description: "Create a new migration corridor",
    riskLevel: "high",
    impact: "Adds a new corridor to your dashboard",
    requiresApproval: true,
  },
  DELETE_CORRIDOR: {
    name: "delete_corridor",
    description: "Delete a migration corridor",
    riskLevel: "high",
    impact: "Permanently removes corridor and all associated data",
    requiresApproval: true,
  },
  REFRESH_PROTOCOLS: {
    name: "refresh_protocols",
    description: "Regenerate all protocols for corridor",
    riskLevel: "medium",
    impact: "Replaces existing protocols with AI-generated ones",
    requiresApproval: true,
  },

  // Medium risk - approval recommended
  BULK_IMPORT: {
    name: "bulk_import_expenses",
    description: "Import multiple expenses from CSV",
    riskLevel: "medium",
    impact: (count: number) => `Adds ${count} new expense records`,
    requiresApproval: (count: number) => count > 50,
  },

  // Low risk - optional approval
  ADD_TODO: {
    name: "add_todo",
    description: "Add item to your task list",
    riskLevel: "low",
    impact: "Adds a new task to your todo list",
    requiresApproval: false,
  },
} as const;
```

### ADK Agent HITL Tool
```python
# agents/tribe_agent/tools/hitl.py
from google.adk.tools import FunctionTool
from google.adk.hitl import request_approval

@FunctionTool
async def create_corridor_with_approval(
    origin: str,
    destination: str,
    stage: str = "dreaming"
) -> dict:
    """
    Create a new migration corridor. This action requires user approval.

    Args:
        origin: Origin country code (ISO3)
        destination: Destination country code (ISO3)
        stage: Initial stage (dreaming, planning, preparing, relocating, settling)

    Returns:
        dict with corridor creation result
    """
    # Request approval from user
    approval = await request_approval(
        action="create_corridor",
        description=f"Create new corridor: {origin} → {destination}",
        impact="This will add a new migration corridor to your dashboard.",
        timeout_seconds=60
    )

    if not approval.approved:
        return {
            "cancelled": True,
            "message": "Corridor creation cancelled by user.",
            "reason": approval.reason
        }

    # Execute the action
    async with httpx.AsyncClient() as client:
        response = await client.post(
            f"{CONVEX_SITE_URL}/api/corridors/create",
            json={"origin": origin, "destination": destination, "stage": stage}
        )
        result = response.json()

    return {
        "success": True,
        "corridorId": result.get("corridorId"),
        "message": f"Created corridor: {origin} → {destination}",
        "approved": True,
        "timestamp": result.get("timestamp")
    }
```

### Approval UI Component
```typescript
// components/chat/ActionApprovalCard.tsx
"use client";

import { useState, useEffect } from "react";
import { AlertTriangle, Check, X, Clock } from "lucide-react";

interface ActionApprovalCardProps {
  action: string;
  description: string;
  impact: string;
  riskLevel: "high" | "medium" | "low";
  timeoutSeconds: number;
  onApprove: () => void;
  onReject: (reason?: string) => void;
}

const riskColors = {
  high: "bg-red-100 border-red-500",
  medium: "bg-yellow-100 border-yellow-500",
  low: "bg-blue-100 border-blue-500",
};

export function ActionApprovalCard({
  action,
  description,
  impact,
  riskLevel,
  timeoutSeconds,
  onApprove,
  onReject,
}: ActionApprovalCardProps) {
  const [timeLeft, setTimeLeft] = useState(timeoutSeconds);

  // Countdown timer
  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft((prev) => {
        if (prev <= 1) {
          clearInterval(timer);
          onReject("Timed out");
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [onReject]);

  return (
    <div className={`border-4 border-black p-4 ${riskColors[riskLevel]} shadow-[4px_4px_0_0_#000]`}>
      <div className="flex items-center gap-2 mb-3">
        <AlertTriangle className="w-5 h-5" />
        <h3 className="font-bold text-lg">Action Requires Approval</h3>
        <span className="ml-auto flex items-center gap-1 text-sm text-gray-600">
          <Clock className="w-4 h-4" />
          {timeLeft}s
        </span>
      </div>

      <div className="bg-white border-2 border-black p-3 mb-3">
        <p className="font-bold">{description}</p>
        <p className="text-sm text-gray-600 mt-1">{impact}</p>
      </div>

      <div className="flex gap-3">
        <button
          onClick={onApprove}
          className="flex-1 flex items-center justify-center gap-2 py-2 border-2 border-black bg-green-300 hover:bg-green-400 font-bold"
        >
          <Check className="w-4 h-4" />
          Approve
        </button>
        <button
          onClick={() => onReject("User cancelled")}
          className="flex-1 flex items-center justify-center gap-2 py-2 border-2 border-black bg-red-300 hover:bg-red-400 font-bold"
        >
          <X className="w-4 h-4" />
          Cancel
        </button>
      </div>

      {riskLevel === "high" && (
        <p className="text-xs text-red-600 mt-2 text-center">
          ⚠️ This action cannot be undone
        </p>
      )}
    </div>
  );
}
```

### useHumanInTheLoop Integration
```typescript
// components/chat/ChatProvider.tsx
import { useHumanInTheLoop } from "@copilotkit/react-core";
import { ActionApprovalCard } from "./ActionApprovalCard";
import { HITL_ACTIONS } from "@/lib/constants/hitl-actions";

function HITLHandler() {
  useHumanInTheLoop({
    name: "tribe_agent",
    render: ({ action, description, impact, resolve, reject }) => {
      const actionConfig = Object.values(HITL_ACTIONS).find(
        (a) => a.name === action
      );

      return (
        <ActionApprovalCard
          action={action}
          description={description}
          impact={impact}
          riskLevel={actionConfig?.riskLevel || "medium"}
          timeoutSeconds={60}
          onApprove={() => resolve({ approved: true })}
          onReject={(reason) => reject({ approved: false, reason })}
        />
      );
    },
  });

  return null;
}
```

### Audit Logging
```typescript
// convex/hitl.ts
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const logApprovalRequest = mutation({
  args: {
    corridorId: v.id("corridors"),
    action: v.string(),
    description: v.string(),
    impact: v.string(),
    riskLevel: v.union(v.literal("high"), v.literal("medium"), v.literal("low")),
  },
  handler: async (ctx, args) => {
    return await ctx.db.insert("hitlAuditLog", {
      ...args,
      status: "pending",
      requestedAt: Date.now(),
    });
  },
});

export const logApprovalResponse = mutation({
  args: {
    logId: v.id("hitlAuditLog"),
    approved: v.boolean(),
    reason: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.logId, {
      status: args.approved ? "approved" : "rejected",
      reason: args.reason,
      respondedAt: Date.now(),
    });
  },
});
```

---

## Dependencies

- **Upstream**: Story 10.2 (CopilotRuntime), Story 10.6 (Shared State)
- **CopilotKit**: useHumanInTheLoop hook
- **Convex**: hitlAuditLog table

---

## Testing Strategy

### Test Cases

1. **Approval Flow**:
   - Request shown with correct details
   - User clicks Approve
   - Action executes
   - Audit log updated

2. **Rejection Flow**:
   - User clicks Cancel
   - Action does not execute
   - Agent acknowledges cancellation
   - Audit log shows rejection

3. **Timeout**:
   - Counter counts down
   - Auto-rejects at 0
   - User notified of timeout
   - Audit log shows timeout

4. **Risk Levels**:
   - High risk shows warning
   - Medium risk shows caution
   - Low risk (if shown) is informational

5. **Audit Log**:
   - All requests logged
   - Responses logged with timestamp
   - Can query history

6. **Edge Cases**:
   - Multiple pending approvals
   - User navigates away
   - Network error during approval
