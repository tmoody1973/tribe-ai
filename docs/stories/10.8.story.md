# Story 10.8: Predictive State Updates

## Status

**Draft**

---

## Story

**As a** user,
**I want** to see real-time progress as the AI researches my query,
**so that** I know the agent is working and what it's doing.

---

## Acceptance Criteria

1. ADK agent emits intermediate state updates during tool execution
2. Frontend receives state via `useCoAgent` hook
3. Progress displayed in chat: "Step 1: Searching housing database...", "Step 2: Checking 3 sources..."
4. `useCoAgentStateRender` renders progress component in chat flow
5. State updates appear within 500ms of agent emitting them
6. Final state replaces intermediate updates when tool completes
7. Long-running searches (>3s) show animated progress indicator
8. User can see agent "thinking" process for transparency

---

## Tasks / Subtasks

- [ ] **Task 1: Research AG-UI State Events** (AC: 1, 2)
  - [ ] Review AG-UI protocol for state emission patterns
  - [ ] Understand how ADK agent emits intermediate states
  - [ ] Document available state event types
  - [ ] Check CopilotKit hooks for state reception

- [ ] **Task 2: Configure ADK Agent State Emission** (AC: 1)
  - [ ] Update ADK agent to emit state during tool execution
  - [ ] Emit state at key milestones:
    - Tool started
    - Fetching data
    - Processing results
    - Formatting response
  - [ ] Include progress percentage when possible

- [ ] **Task 3: Create Progress Component** (AC: 3, 4, 7)
  - [ ] Create `AgentProgressCard.tsx`
  - [ ] Display current step and description
  - [ ] Show animated dots or spinner
  - [ ] Auto-hide when final response arrives
  - [ ] Style with RetroUI

- [ ] **Task 4: Integrate useCoAgent Hook** (AC: 2, 5)
  - [ ] Add `useCoAgent` hook to chat context
  - [ ] Subscribe to agent state updates
  - [ ] Map state to progress display
  - [ ] Handle state transitions smoothly

- [ ] **Task 5: Implement State Render Hook** (AC: 4, 6)
  - [ ] Add `useCoAgentStateRender` for inline progress
  - [ ] Render progress in chat message flow
  - [ ] Replace progress with final result
  - [ ] Handle edge cases (rapid updates, errors)

- [ ] **Task 6: Add Thinking Transparency** (AC: 8)
  - [ ] Display agent's reasoning steps (if available)
  - [ ] Show "Thinking..." indicator
  - [ ] Optionally expand to show full thought process
  - [ ] Toggle for verbose vs minimal progress

---

## Technical Implementation Notes

### ADK Agent State Emission
```python
# agents/tribe_agent/tools/housing.py
from google.adk.tools import FunctionTool
from google.adk.state import emit_state

@FunctionTool
async def search_housing_resources(
    country: str = None,
    continent: str = None,
    resource_type: str = None
) -> dict:
    """Search for housing resources with progress updates."""

    # Emit initial state
    await emit_state({
        "step": 1,
        "total_steps": 3,
        "message": "Loading housing database...",
        "progress": 0.1
    })

    # Load data
    results = load_housing_data()

    await emit_state({
        "step": 2,
        "total_steps": 3,
        "message": f"Filtering {len(results)} resources...",
        "progress": 0.5
    })

    # Filter results
    filtered = filter_results(results, country, continent, resource_type)

    await emit_state({
        "step": 3,
        "total_steps": 3,
        "message": f"Found {len(filtered)} matching resources",
        "progress": 0.9
    })

    # Return final result (clears progress state)
    return format_response(filtered)
```

### Progress Component
```typescript
// components/chat/AgentProgressCard.tsx
"use client";

import { useEffect, useState } from "react";
import { Loader2, CheckCircle } from "lucide-react";

interface AgentState {
  step: number;
  total_steps: number;
  message: string;
  progress: number;
}

interface AgentProgressCardProps {
  state: AgentState;
}

export function AgentProgressCard({ state }: AgentProgressCardProps) {
  const [dots, setDots] = useState("");

  // Animate dots
  useEffect(() => {
    const interval = setInterval(() => {
      setDots((prev) => (prev.length >= 3 ? "" : prev + "."));
    }, 500);
    return () => clearInterval(interval);
  }, []);

  const progressPercent = Math.round(state.progress * 100);

  return (
    <div className="border-2 border-black p-4 bg-blue-50">
      <div className="flex items-center gap-3 mb-2">
        <Loader2 className="w-5 h-5 animate-spin text-blue-600" />
        <span className="font-medium">
          Step {state.step} of {state.total_steps}
        </span>
      </div>

      <p className="text-sm text-gray-700 mb-3">
        {state.message}{dots}
      </p>

      {/* Progress bar */}
      <div className="h-2 bg-gray-200 border border-black overflow-hidden">
        <div
          className="h-full bg-blue-500 transition-all duration-300"
          style={{ width: `${progressPercent}%` }}
        />
      </div>
      <div className="text-xs text-gray-500 mt-1 text-right">
        {progressPercent}%
      </div>
    </div>
  );
}
```

### useCoAgent Integration
```typescript
// components/chat/ChatProvider.tsx
"use client";

import { useCoAgent, useCoAgentStateRender } from "@copilotkit/react-core";
import { AgentProgressCard } from "./AgentProgressCard";

function ChatProviderInner({ children }: { children: React.ReactNode }) {
  // Subscribe to agent state
  const { state: agentState, isRunning } = useCoAgent({
    name: "tribe_agent",
  });

  // Render state updates in chat flow
  useCoAgentStateRender({
    name: "tribe_agent",
    render: ({ state }) => {
      if (!state || !state.step) return null;

      return <AgentProgressCard state={state} />;
    },
  });

  return <>{children}</>;
}
```

### Thinking Transparency Component
```typescript
// components/chat/ThinkingIndicator.tsx
"use client";

import { useState } from "react";
import { Brain, ChevronDown, ChevronUp } from "lucide-react";

interface ThinkingIndicatorProps {
  thoughts?: string[];
  isThinking: boolean;
}

export function ThinkingIndicator({ thoughts = [], isThinking }: ThinkingIndicatorProps) {
  const [expanded, setExpanded] = useState(false);

  if (!isThinking && thoughts.length === 0) return null;

  return (
    <div className="border-l-4 border-purple-500 pl-3 py-2 bg-purple-50 mb-2">
      <button
        onClick={() => setExpanded(!expanded)}
        className="flex items-center gap-2 text-sm font-medium text-purple-700 w-full"
      >
        <Brain className="w-4 h-4" />
        <span>
          {isThinking ? "Thinking..." : `Thought process (${thoughts.length} steps)`}
        </span>
        {thoughts.length > 0 && (
          expanded ? <ChevronUp className="w-4 h-4 ml-auto" /> : <ChevronDown className="w-4 h-4 ml-auto" />
        )}
      </button>

      {expanded && thoughts.length > 0 && (
        <ul className="mt-2 space-y-1 text-xs text-gray-600">
          {thoughts.map((thought, idx) => (
            <li key={idx} className="flex gap-2">
              <span className="text-purple-400">{idx + 1}.</span>
              {thought}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
```

---

## Dependencies

- **Upstream**: Story 10.2 (CopilotRuntime), Story 10.6 (Shared State)
- **CopilotKit**: useCoAgent, useCoAgentStateRender hooks
- **ADK**: State emission API

---

## Testing Strategy

### Test Cases

1. **State Emission**:
   - Agent emits state at each step
   - State includes step, message, progress
   - State received by frontend

2. **Progress Display**:
   - Progress card appears during processing
   - Step counter updates correctly
   - Progress bar animates smoothly

3. **Timing**:
   - Updates appear within 500ms
   - No flickering on rapid updates
   - Smooth transition to final result

4. **Long-Running Queries**:
   - >3s queries show animated indicator
   - User not confused by delay
   - Can still interact with chat

5. **Thinking Transparency**:
   - Expandable thought process
   - Shows agent reasoning (if available)
   - Collapses to minimal view

6. **Edge Cases**:
   - Error during progress
   - Multiple concurrent queries
   - User navigates away mid-query
