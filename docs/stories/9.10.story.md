# Story 9.10: Enhanced Audio Briefings - Daily Briefings

## Status

**Complete**

---

## Story

**As a** busy migrant preparing to move,
**I want** a personalized daily audio briefing with my tasks, updates, and insights,
**so that** I can stay informed and focused without spending time reading.

---

## Acceptance Criteria

1. Generate daily audio briefing every morning (6 AM user timezone)
2. Aggregate data from 10 sources: todos, documents, feed alerts, Perplexity news/jobs/culture, corridor stats, financial data, community wisdom
3. Synthesize content using Claude (Gemini fallback) into conversational script
4. 7-section structure: greeting, urgent actions, progress, opportunities, financial check, focus, motivation
5. Render audio using Google Cloud Text-to-Speech (220+ languages)
6. Duration: 2-3 minutes (300-500 words)
7. Store briefing with transcript and audio URL
8. Display in dashboard with play button and transcript view
9. Download option for offline listening
10. Skip briefing if no meaningful updates for the day

---

## Tasks / Subtasks

- [ ] **Task 1: Create Data Aggregation Pipeline** (AC: 2)
  - [ ] Create `convex/ai/briefings.ts` with `aggregateDailyData` function
  - [ ] Query user's todos (top 3 urgent items for today)
  - [ ] Query saved documents (recent 5 documents added this week)
  - [ ] Query corridor feed alerts (last 24 hours)
  - [ ] Call Perplexity API (4 queries):
    - Immigration news: `{destination} immigration policy changes today`
    - Job market: `{destination} job market trends {user skills}`
    - Cultural events: `{destination} cultural events news migrants`
    - General news: `{destination} news {origin} migrants`
  - [ ] Query corridor stats (progress percentage, days until move)
  - [ ] Query financial data (budget summary, upcoming expenses)
  - [ ] Query community highlights (popular posts, tips)
  - [ ] Return aggregated data object

- [ ] **Task 2: Build Briefing Script Generator** (AC: 3, 4)
  - [ ] Create `generateDailyScript` function using Claude
  - [ ] System prompt for briefing tone: friendly, motivational, concise
  - [ ] 7-section structure:
    ```typescript
    const sections = [
      "greeting",        // Good morning! Today is Monday, January 15th
      "urgent_actions",  // Here's what needs your attention today
      "progress",        // Your migration journey progress
      "opportunities",   // New job postings, visa updates, events
      "financial_check", // Budget status, upcoming expenses
      "focus",           // One key task to prioritize today
      "motivation",      // Encouraging message to end
    ];
    ```
  - [ ] Generate 300-500 word script
  - [ ] Include specific data points (names, numbers, dates)
  - [ ] Conversational tone, avoid robotic language
  - [ ] Fallback to Gemini if Claude unavailable

- [ ] **Task 3: Implement Google Cloud TTS** (AC: 5, 9)
  - [ ] Setup Google Cloud Text-to-Speech client
  - [ ] Environment variable: `GOOGLE_CLOUD_TTS_API_KEY`
  - [ ] Install: `npm install @google-cloud/text-to-speech`
  - [ ] Create `synthesizeSpeech` function:
    - Input: script text, language code, voice name
    - Output: audio buffer (MP3)
  - [ ] Auto-detect language from user preferences
  - [ ] Use neural voices for natural speech
  - [ ] Store audio in Convex file storage or S3
  - [ ] Return audio URL for playback

- [ ] **Task 4: Create Daily Briefing Cron Job** (AC: 1)
  - [ ] Add to `convex/crons.ts`:
    ```typescript
    crons.daily(
      "generate-daily-briefings",
      { hourUTC: 6, minuteUTC: 0 },
      internal.ai.briefings.generateDailyBriefings
    );
    ```
  - [ ] For each active user:
    - Check if user enabled daily briefings
    - Aggregate daily data
    - Generate script with Claude
    - Synthesize audio with Google TTS
    - Store briefing in database
  - [ ] Skip if no meaningful updates (AC: 10)
  - [ ] Log generation statistics

- [ ] **Task 5: Build Briefing Player UI** (AC: 8)
  - [ ] Create `components/dashboard/DailyBriefing.tsx`
  - [ ] Display on dashboard (top or sidebar)
  - [ ] Audio player with:
    - Play/Pause button
    - Progress bar
    - Playback speed control (0.75x, 1x, 1.25x, 1.5x)
    - Current time / total duration
  - [ ] "View Transcript" expand/collapse
  - [ ] Download audio button
  - [ ] Date picker to view previous briefings
  - [ ] Neo-brutalism styling

- [ ] **Task 6: Add Briefing Preferences** (AC: 1, 9)
  - [ ] Add to user settings:
    - Enable daily briefings (toggle)
    - Preferred time (dropdown: 6 AM, 7 AM, 8 AM, 9 AM)
    - Language preference (220+ options)
    - Voice preference (male/female, accent)
    - Include sections (checkboxes for 7 sections)
    - Auto-download for offline (toggle)
  - [ ] Store in user preferences table
  - [ ] Apply preferences in cron job

---

## Technical Implementation Notes

### Data Aggregation
```typescript
async function aggregateDailyData(userId: string, corridorId: string) {
  const [todos, documents, feedAlerts, financialSummary, corridorStats] =
    await Promise.all([
      ctx.db.query("todos")
        .withIndex("by_user", q => q.eq("userId", userId))
        .filter(q => q.eq(q.field("completed"), false))
        .order("desc")
        .take(3),

      ctx.db.query("savedDocuments")
        .withIndex("by_user", q => q.eq("userId", userId))
        .order("desc")
        .take(5),

      ctx.db.query("corridorFeed")
        .filter(q => q.eq(q.field("isAlert"), true))
        .filter(q => q.gte(q.field("publishedAt"), Date.now() - 24 * 60 * 60 * 1000))
        .take(3),

      ctx.runQuery(api.financial.getBudgetSummary, { corridorId }),
      ctx.runQuery(api.corridors.getStats, { corridorId }),
    ]);

  // Perplexity queries for real-time intelligence
  const perplexityData = await Promise.all([
    perplexity.search(`${corridor.destination} immigration policy changes today`),
    perplexity.search(`${corridor.destination} job market trends tech workers`),
    perplexity.search(`${corridor.destination} cultural events news migrants`),
    perplexity.search(`${corridor.destination} news ${corridor.origin} migrants`),
  ]);

  return {
    todos,
    documents,
    feedAlerts,
    policyNews: perplexityData[0],
    jobTrends: perplexityData[1],
    culturalNews: perplexityData[2],
    destinationNews: perplexityData[3],
    financialSummary,
    corridorStats,
    communityWisdom: await getCommunityHighlights(corridorId),
  };
}
```

### Script Generation with Claude
```typescript
async function generateDailyScript(data: DailyData, user: User) {
  const prompt = `Generate a friendly, motivational daily migration briefing for ${user.name}.

CONTEXT:
- Origin: ${data.corridor.origin}
- Destination: ${data.corridor.destination}
- Stage: ${data.corridor.stage}
- Language: ${user.language}

DATA:
- Todos: ${JSON.stringify(data.todos)}
- Recent news: ${data.policyNews}
- Job trends: ${data.jobTrends}
- Budget: ${data.financialSummary.percentageSpent}% spent
- Upcoming expenses: ${data.financialSummary.upcomingExpenses}

STRUCTURE (300-500 words):
1. Greeting: Warm, personalized good morning
2. Urgent Actions: Top 3 todos for today
3. Progress: Migration journey update
4. Opportunities: New jobs, policy updates, events
5. Financial Check: Budget status, upcoming expenses
6. Focus: One key task to prioritize
7. Motivation: Encouraging sign-off

TONE: Conversational, supportive, action-oriented. Use specific names, numbers, dates.`;

  const response = await anthropic.messages.create({
    model: "claude-3-5-sonnet-20241022",
    max_tokens: 1000,
    messages: [{ role: "user", content: prompt }],
  });

  return response.content[0].text;
}
```

### Google Cloud TTS Integration
```typescript
import textToSpeech from "@google-cloud/text-to-speech";
const ttsClient = new textToSpeech.TextToSpeechClient();

async function synthesizeSpeech(
  text: string,
  languageCode: string,
  voiceName?: string
) {
  const [response] = await ttsClient.synthesizeSpeech({
    input: { text },
    voice: {
      languageCode,
      name: voiceName, // Auto-select if not provided
      ssmlGender: "NEUTRAL",
    },
    audioConfig: {
      audioEncoding: "MP3",
      speakingRate: 1.0,
      pitch: 0.0,
      effectsProfileId: ["small-bluetooth-speaker-class-device"],
    },
  });

  // Upload to storage
  const audioBuffer = response.audioContent as Buffer;
  const fileName = `briefings/${userId}/${Date.now()}.mp3`;
  const audioUrl = await uploadToStorage(audioBuffer, fileName);

  return audioUrl;
}

// Language codes: en-US, fr-CA, es-ES, hi-IN, pt-BR, yo-NG, etc.
// 220+ languages available
```

### Daily Briefing Cron Job
```typescript
export const generateDailyBriefings = internalAction({
  handler: async (ctx) => {
    const users = await ctx.runQuery(internal.users.getActiveUsers);

    for (const user of users) {
      try {
        // Check preferences
        if (!user.preferences.dailyBriefings?.enabled) continue;

        // Check user timezone and target hour
        const userHour = new Date().toLocaleString("en-US", {
          hour: "numeric",
          hour12: false,
          timeZone: user.timezone || "UTC",
        });

        if (parseInt(userHour) !== (user.preferences.dailyBriefings.hour || 6)) {
          continue;
        }

        // Get active corridor
        const corridor = await ctx.runQuery(api.corridors.getActiveCorridor, {
          userId: user._id,
        });
        if (!corridor) continue;

        // Aggregate data
        const data = await aggregateDailyData(user._id, corridor._id);

        // Check if meaningful updates exist
        if (!hasMeaningfulUpdates(data)) {
          console.log(`Skipping briefing for ${user.name} - no updates`);
          continue;
        }

        // Generate script
        const script = await generateDailyScript(data, user);

        // Synthesize audio
        const audioUrl = await synthesizeSpeech(
          script,
          user.language || "en-US",
          user.preferences.dailyBriefings.voice
        );

        // Store briefing
        await ctx.runMutation(api.briefings.create, {
          userId: user._id,
          corridorId: corridor._id,
          type: "daily",
          transcript: script,
          audioUrl,
          duration: estimateDuration(script),
          generatedAt: Date.now(),
        });

        console.log(`Generated daily briefing for ${user.name}`);
      } catch (error) {
        console.error(`Failed to generate briefing for user ${user._id}:`, error);
      }
    }
  },
});

function hasMeaningfulUpdates(data: DailyData): boolean {
  return (
    data.todos.length > 0 ||
    data.feedAlerts.length > 0 ||
    data.policyNews?.length > 0 ||
    data.financialSummary.upcomingExpenses.length > 0
  );
}

function estimateDuration(script: string): number {
  // Average speaking rate: 150 words per minute
  const wordCount = script.split(/\s+/).length;
  return Math.ceil((wordCount / 150) * 60); // Duration in seconds
}
```

---

## Dependencies

- **APIs**: Claude API, Google Cloud Text-to-Speech, Perplexity API
- **Libraries**: @google-cloud/text-to-speech, @anthropic-ai/sdk
- **Convex Tables**: audioBriefings (already exists in schema)
- **Storage**: Convex file storage or AWS S3 for audio files
- **Related Stories**: 9.11 (Weekly Briefings), 9.12 (Multi-language Support)

---

## Example Daily Briefing Script

```
Good morning! It's Monday, January 15th, 2025.

Let's start with what needs your attention today. First, you have your IELTS exam registration deadline today - don't forget to complete that! Second, you need to schedule your medical examination appointment. And third, review your budget allocation for Q1.

Great progress on your migration journey - you're now at 65% completion! You've submitted your Express Entry profile and completed your language test. Your estimated move date is 120 days away.

Some exciting opportunities for you today: There are 12 new tech job postings in Toronto matching your skills, particularly in software engineering. Also, Canada just announced a new pathway for tech workers with expedited processing times of 6-8 weeks.

On the financial front, you've spent 42% of your budget so far - right on track! You have two upcoming expenses this week: your medical exam ($250) and document translation ($180).

Today's focus: Complete your IELTS registration. This is your most time-sensitive task, and once it's done, you'll have a major milestone checked off.

Remember, every small step brings you closer to your new life in Canada. You've got this! Have a productive day.
```

---

## Testing Strategy

1. **Data Aggregation**:
   - Test with full data → Complete briefing
   - Test with minimal data → Shorter briefing or skip
   - Test with no data → Skip briefing
   - Test Perplexity API failures → Graceful fallback

2. **Script Generation**:
   - Verify all 7 sections included
   - Check personalization (names, dates, numbers)
   - Validate word count (300-500)
   - Test Claude API failure → Gemini fallback

3. **Audio Synthesis**:
   - Test multiple languages (en, fr, es, hi, pt, yo)
   - Verify audio quality and naturalness
   - Check file size and duration
   - Test Google TTS quota limits

4. **Cron Job Execution**:
   - Verify runs at correct user timezone
   - Test with multiple users in different timezones
   - Check skip logic for no updates
   - Monitor API usage and costs

---

## Cost Estimates

| Service | Usage | Cost |
|---------|-------|------|
| Claude API | 500 words × 100 users/day | $0.015/day × 30 = $0.45/month |
| Google TTS | 500 chars × 100 users/day | Free tier: 1M chars/month ✓ |
| Perplexity API | 4 queries × 100 users/day | Basic plan with rate limits |
| Storage (audio) | 2 MB × 100 users × 30 days | ~$0.06/month (S3) |

**Total estimated cost**: < $1/month for 100 daily active users

---

## Accessibility

- Audio player keyboard controls (Space, Left/Right arrows)
- Transcript available for deaf/hard of hearing users
- Playback speed control for learning/comprehension
- Download option for offline access
- Screen reader compatible player controls
