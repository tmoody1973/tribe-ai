# Story 1.3: Internationalization Setup with next-intl

## Status

**Draft**

---

## Story

**As a** user,
**I want** the app to display in my preferred language,
**so that** I can understand all interface elements without language barriers.

---

## Acceptance Criteria

1. next-intl configured with App Router integration
2. Locale files created for 5 MVP languages: en, yo, hi, pt, tl
3. Language detection from browser preferences on first visit
4. Language switcher component functional in header/settings
5. All static UI strings (buttons, labels, navigation) use translation keys
6. Language preference persisted to user profile in Convex
7. URL structure supports locale prefix (`/en/dashboard`, `/yo/dashboard`)

---

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure next-intl** (AC: 1)
  - [ ] Install: `npm install next-intl`
  - [ ] Create `i18n/config.ts` with locale configuration
  - [ ] Create `i18n/request.ts` for server-side locale handling
  - [ ] Update `next.config.js` with next-intl plugin

- [ ] **Task 2: Create Locale Message Files** (AC: 2)
  - [ ] Create `messages/en.json` with all UI strings
  - [ ] Create `messages/yo.json` (Yoruba)
  - [ ] Create `messages/hi.json` (Hindi)
  - [ ] Create `messages/pt.json` (Portuguese)
  - [ ] Create `messages/tl.json` (Tagalog)
  - [ ] Initial strings: common, navigation, auth, errors

- [ ] **Task 3: Setup Locale-Based Routing** (AC: 7)
  - [ ] Restructure `app/` to `app/[locale]/`
  - [ ] Move existing pages under `[locale]` dynamic segment
  - [ ] Create `app/[locale]/layout.tsx` with NextIntlClientProvider
  - [ ] Update middleware to handle locale detection and routing

- [ ] **Task 4: Integrate with Clerk Middleware** (AC: 1, 7)
  - [ ] Update `middleware.ts` to chain next-intl with Clerk
  - [ ] Ensure locale prefix preserved after auth redirects
  - [ ] Test: `/yo/sign-in` works correctly
  - [ ] Test: protected routes maintain locale after redirect

- [ ] **Task 5: Implement Browser Language Detection** (AC: 3)
  - [ ] Configure next-intl to detect Accept-Language header
  - [ ] Set fallback locale to 'en'
  - [ ] First-time visitors redirected to detected locale
  - [ ] Returning users use stored preference

- [ ] **Task 6: Create Language Switcher Component** (AC: 4)
  - [ ] Create `components/layout/LanguageSwitcher.tsx`
  - [ ] Display current language with flag/name
  - [ ] Dropdown with all 5 language options
  - [ ] On select: update URL locale prefix
  - [ ] Style with RetroUI dropdown component

- [ ] **Task 7: Persist Language to User Profile** (AC: 6)
  - [ ] Create `convex/users.ts` mutation: `updateLanguage`
  - [ ] On language switch: call mutation if user authenticated
  - [ ] On login: apply user's saved language preference
  - [ ] Create hook: `useUserLanguage()` to manage preference

- [ ] **Task 8: Apply Translations to UI** (AC: 5)
  - [ ] Update Header component with translation keys
  - [ ] Update auth pages (sign-in, sign-up) labels
  - [ ] Update UserMenu with translated strings
  - [ ] Add `useTranslations` hook to all components with text

---

## Dev Notes

### next-intl Configuration
[Source: architecture.md#frontend-architecture]

```typescript
// i18n/config.ts
export const locales = ["en", "yo", "hi", "pt", "tl"] as const;
export type Locale = (typeof locales)[number];
export const defaultLocale: Locale = "en";

export const localeNames: Record<Locale, string> = {
  en: "English",
  yo: "Yorùbá",
  hi: "हिन्दी",
  pt: "Português",
  tl: "Tagalog",
};
```

```typescript
// i18n/request.ts
import { getRequestConfig } from "next-intl/server";
import { locales, defaultLocale } from "./config";

export default getRequestConfig(async ({ locale }) => {
  if (!locales.includes(locale as any)) {
    locale = defaultLocale;
  }

  return {
    messages: (await import(`../messages/${locale}.json`)).default,
  };
});
```

### Middleware Integration Pattern
[Source: architecture.md#routing-architecture]

```typescript
// middleware.ts
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";
import createIntlMiddleware from "next-intl/middleware";
import { locales, defaultLocale } from "./i18n/config";

const intlMiddleware = createIntlMiddleware({
  locales,
  defaultLocale,
  localePrefix: "always",
});

const isProtectedRoute = createRouteMatcher([
  "/:locale/dashboard(.*)",
  "/:locale/corridor(.*)",
  "/:locale/settings(.*)",
  "/:locale/voice(.*)",
]);

const isPublicRoute = createRouteMatcher([
  "/:locale/sign-in(.*)",
  "/:locale/sign-up(.*)",
  "/:locale",
  "/api/webhooks(.*)",
  "/api/health",
]);

export default clerkMiddleware((auth, req) => {
  if (isProtectedRoute(req)) {
    auth().protect();
  }
  return intlMiddleware(req);
});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

### Locale Layout Pattern
[Source: architecture.md#frontend-architecture]

```typescript
// app/[locale]/layout.tsx
import { NextIntlClientProvider } from "next-intl";
import { getMessages } from "next-intl/server";
import { notFound } from "next/navigation";
import { locales } from "@/i18n/config";

export default async function LocaleLayout({
  children,
  params: { locale },
}: {
  children: React.ReactNode;
  params: { locale: string };
}) {
  if (!locales.includes(locale as any)) {
    notFound();
  }

  const messages = await getMessages();

  return (
    <NextIntlClientProvider messages={messages}>
      {children}
    </NextIntlClientProvider>
  );
}
```

### Message File Structure
[Source: PRD#2.1-FR2]

```json
// messages/en.json
{
  "common": {
    "loading": "Loading...",
    "error": "Something went wrong",
    "retry": "Try again",
    "save": "Save",
    "cancel": "Cancel"
  },
  "navigation": {
    "dashboard": "Dashboard",
    "chat": "Ask TRIBE",
    "audio": "Audio Briefings",
    "settings": "Settings"
  },
  "auth": {
    "signIn": "Sign In",
    "signUp": "Sign Up",
    "signOut": "Sign Out",
    "continueWithGoogle": "Continue with Google"
  },
  "errors": {
    "NETWORK_ERROR": "Connection error",
    "UNAUTHORIZED": "Please sign in",
    "NOT_FOUND": "Not found"
  }
}
```

### Language Switcher Component
[Source: architecture.md#components]

```typescript
// components/layout/LanguageSwitcher.tsx
"use client";

import { useLocale } from "next-intl";
import { useRouter, usePathname } from "next/navigation";
import { locales, localeNames, Locale } from "@/i18n/config";

export function LanguageSwitcher() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const handleChange = (newLocale: Locale) => {
    // Replace current locale in path with new locale
    const newPath = pathname.replace(`/${locale}`, `/${newLocale}`);
    router.push(newPath);
  };

  return (
    <select
      value={locale}
      onChange={(e) => handleChange(e.target.value as Locale)}
      className="border-2 border-black px-2 py-1"
    >
      {locales.map((loc) => (
        <option key={loc} value={loc}>
          {localeNames[loc]}
        </option>
      ))}
    </select>
  );
}
```

### Convex Language Mutation
[Source: architecture.md#database-schema]

```typescript
// convex/users.ts (add to existing file)
export const updateLanguage = mutation({
  args: { language: v.union(v.literal("en"), v.literal("yo"), v.literal("hi"), v.literal("pt"), v.literal("tl")) },
  handler: async (ctx, { language }) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthenticated");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    await ctx.db.patch(user._id, { language });
  },
});
```

### File Structure After i18n Setup
```
app/
├── [locale]/                    # All routes under locale
│   ├── layout.tsx               # NextIntlClientProvider
│   ├── page.tsx                 # Landing page
│   ├── (auth)/
│   │   ├── sign-in/[[...sign-in]]/page.tsx
│   │   └── sign-up/[[...sign-up]]/page.tsx
│   └── (dashboard)/
│       └── dashboard/page.tsx
├── api/                         # API routes stay outside [locale]
│   ├── health/route.ts
│   └── webhooks/clerk/route.ts
└── layout.tsx                   # Root layout (ClerkProvider, etc.)

i18n/
├── config.ts                    # Locale configuration
└── request.ts                   # Server request config

messages/
├── en.json
├── yo.json
├── hi.json
├── pt.json
└── tl.json

components/
└── layout/
    └── LanguageSwitcher.tsx
```

### Translation Usage Pattern
```typescript
// In any component
import { useTranslations } from "next-intl";

export function MyComponent() {
  const t = useTranslations("navigation");

  return <nav>{t("dashboard")}</nav>;
}
```

### Dependencies from Previous Stories
- Story 1.1: Project scaffold, Convex connected
- Story 1.2: Clerk authentication, middleware, users table

---

## Testing

### Test Scenarios

1. **Locale Routing**
   - [ ] Visit `/` → redirected to `/en` (or browser locale)
   - [ ] Visit `/yo/dashboard` → displays Yoruba interface
   - [ ] Visit `/invalid/dashboard` → 404 or redirect to default

2. **Language Switcher**
   - [ ] Switch from English to Yoruba
   - [ ] URL updates to `/yo/...`
   - [ ] All visible text changes language

3. **Language Persistence**
   - [ ] Authenticated user switches to Hindi
   - [ ] Sign out, sign back in
   - [ ] User returns to Hindi interface

4. **Browser Detection**
   - [ ] Set browser language to Portuguese
   - [ ] Visit site for first time
   - [ ] Redirected to `/pt`

5. **Auth Flow with Locale**
   - [ ] Visit `/yo/sign-in`
   - [ ] Sign in successfully
   - [ ] Redirected to `/yo/dashboard` (not `/en/dashboard`)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*
