# Story 10.10: Frontend Tools for Agent UI Control

## Status

**Draft**

---

## Story

**As a** user,
**I want** the AI to navigate me to relevant pages and open helpful modals,
**so that** I can act on AI suggestions instantly.

---

## Acceptance Criteria

1. `useFrontendTool` hooks registered: navigateToCorridor, openExpenseModal, saveToVault, addToTodos
2. `navigateToCorridor`: Agent can say "Let me take you to your Canada dashboard" and navigate
3. `openExpenseModal`: Agent opens expense entry modal after discussing finances
4. `saveToVault`: Agent saves discussed resource to user's document vault
5. `addToTodos`: Agent adds suggested task to user's todo list
6. Frontend tools execute immediately upon agent invocation
7. Success/failure feedback shown in chat
8. Tools respect current page context and user permissions

---

## Tasks / Subtasks

- [ ] **Task 1: Create Frontend Tool Definitions** (AC: 1)
  - [ ] Define tool schemas for ADK agent
  - [ ] Create matching useFrontendTool hooks
  - [ ] Document tool parameters and behaviors

- [ ] **Task 2: Implement navigateToCorridor** (AC: 2, 6, 7, 8)
  - [ ] Create navigation tool in ADK agent
  - [ ] Frontend hook uses Next.js router
  - [ ] Navigate to /dashboard/[corridorId]
  - [ ] Show toast on navigation
  - [ ] Handle invalid corridor IDs

- [ ] **Task 3: Implement openExpenseModal** (AC: 3, 6, 7)
  - [ ] Create modal trigger tool in ADK agent
  - [ ] Frontend hook opens expense modal
  - [ ] Pre-fill modal with suggested data if provided
  - [ ] Return confirmation when modal opened
  - [ ] Handle modal already open

- [ ] **Task 4: Implement saveToVault** (AC: 4, 6, 7)
  - [ ] Create vault save tool in ADK agent
  - [ ] Frontend calls Convex mutation
  - [ ] Accept title, URL, content, type
  - [ ] Show success toast
  - [ ] Handle duplicate detection

- [ ] **Task 5: Implement addToTodos** (AC: 5, 6, 7)
  - [ ] Create todo add tool in ADK agent
  - [ ] Frontend calls Convex mutation
  - [ ] Accept title, priority, due date
  - [ ] Show success with link to board
  - [ ] Handle validation errors

- [ ] **Task 6: Add Permission Checks** (AC: 8)
  - [ ] Verify user owns target corridor
  - [ ] Check user has vault/todo access
  - [ ] Return helpful error if denied
  - [ ] Log permission failures

---

## Technical Implementation Notes

### ADK Agent Frontend Tools
```python
# agents/tribe_agent/tools/frontend.py
from google.adk.tools import FrontendTool

@FrontendTool
async def navigate_to_corridor(corridor_id: str) -> dict:
    """
    Navigate the user to a specific corridor's dashboard.
    Use this when the user wants to view or work on a particular corridor.

    Args:
        corridor_id: The ID of the corridor to navigate to

    Returns:
        dict with success status
    """
    # Frontend tool - execution happens on client side
    return {
        "action": "navigate",
        "path": f"/dashboard/{corridor_id}",
        "corridorId": corridor_id
    }

@FrontendTool
async def open_expense_modal(
    suggested_amount: float = None,
    suggested_category: str = None,
    suggested_description: str = None
) -> dict:
    """
    Open the expense entry modal for the user to add a new expense.
    Use this after discussing finances or when user wants to track spending.

    Args:
        suggested_amount: Pre-fill amount if known
        suggested_category: Pre-fill category (visaImmigration, tests, travel, etc.)
        suggested_description: Pre-fill description

    Returns:
        dict with modal open status
    """
    return {
        "action": "openModal",
        "modal": "expense",
        "prefill": {
            "amount": suggested_amount,
            "category": suggested_category,
            "description": suggested_description
        }
    }

@FrontendTool
async def save_to_vault(
    title: str,
    url: str = None,
    content: str = None,
    doc_type: str = "resource"
) -> dict:
    """
    Save a resource or document to the user's vault for later reference.
    Use this when you've found helpful resources the user might want to keep.

    Args:
        title: Title of the document/resource
        url: URL if it's a web resource
        content: Text content to save
        doc_type: Type of document (resource, visa, housing, guide)

    Returns:
        dict with save status
    """
    return {
        "action": "saveToVault",
        "document": {
            "title": title,
            "url": url,
            "content": content,
            "type": doc_type
        }
    }

@FrontendTool
async def add_to_todos(
    title: str,
    priority: str = "medium",
    due_date: str = None,
    category: str = None
) -> dict:
    """
    Add a task to the user's todo list / task board.
    Use this when suggesting actionable next steps.

    Args:
        title: Task title/description
        priority: Priority level (critical, high, medium, low)
        due_date: Optional due date (ISO format)
        category: Category (visa, finance, housing, etc.)

    Returns:
        dict with task creation status
    """
    return {
        "action": "addTodo",
        "task": {
            "title": title,
            "priority": priority,
            "dueDate": due_date,
            "category": category
        }
    }
```

### Frontend Tool Hooks
```typescript
// components/chat/FrontendTools.tsx
"use client";

import { useFrontendTool } from "@copilotkit/react-core";
import { useRouter } from "next/navigation";
import { useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { toast } from "sonner";
import { useExpenseModal } from "@/hooks/useExpenseModal";

export function FrontendTools() {
  const router = useRouter();
  const { openModal: openExpense, setPrefilledData } = useExpenseModal();
  const saveDocument = useMutation(api.documents.saveDocument);
  const createTask = useMutation(api.tasks.createTask);

  // Navigate to corridor
  useFrontendTool({
    name: "navigate_to_corridor",
    handler: async ({ corridorId }) => {
      try {
        router.push(`/dashboard/${corridorId}`);
        toast.success("Navigating to corridor...");
        return { success: true };
      } catch (error) {
        toast.error("Failed to navigate");
        return { success: false, error: String(error) };
      }
    },
  });

  // Open expense modal
  useFrontendTool({
    name: "open_expense_modal",
    handler: async ({ prefill }) => {
      try {
        if (prefill) {
          setPrefilledData(prefill);
        }
        openExpense();
        toast.info("Opening expense form...");
        return { success: true, modalOpened: true };
      } catch (error) {
        toast.error("Failed to open expense form");
        return { success: false, error: String(error) };
      }
    },
  });

  // Save to vault
  useFrontendTool({
    name: "save_to_vault",
    handler: async ({ document }) => {
      try {
        const docId = await saveDocument({
          title: document.title,
          url: document.url,
          content: document.content,
          type: document.type,
        });
        toast.success("Saved to your vault!");
        return { success: true, documentId: docId };
      } catch (error) {
        toast.error("Failed to save document");
        return { success: false, error: String(error) };
      }
    },
  });

  // Add to todos
  useFrontendTool({
    name: "add_to_todos",
    handler: async ({ task }) => {
      try {
        const taskId = await createTask({
          title: task.title,
          priority: task.priority || "medium",
          dueDate: task.dueDate ? new Date(task.dueDate).getTime() : undefined,
          category: task.category,
          column: "todo",
        });
        toast.success("Added to your task board!", {
          action: {
            label: "View",
            onClick: () => router.push("/board"),
          },
        });
        return { success: true, taskId };
      } catch (error) {
        toast.error("Failed to add task");
        return { success: false, error: String(error) };
      }
    },
  });

  return null; // Just registers hooks
}
```

### Tool Response Display
```typescript
// components/chat/FrontendToolResult.tsx
"use client";

import { CheckCircle, XCircle, ExternalLink, ListTodo, Bookmark } from "lucide-react";

interface FrontendToolResultProps {
  tool: string;
  success: boolean;
  message?: string;
  action?: {
    label: string;
    onClick: () => void;
  };
}

const toolIcons = {
  navigate_to_corridor: ExternalLink,
  open_expense_modal: ExternalLink,
  save_to_vault: Bookmark,
  add_to_todos: ListTodo,
};

export function FrontendToolResult({
  tool,
  success,
  message,
  action,
}: FrontendToolResultProps) {
  const Icon = toolIcons[tool as keyof typeof toolIcons] || CheckCircle;

  return (
    <div className={`flex items-center gap-2 p-2 rounded ${
      success ? "bg-green-50 border-green-200" : "bg-red-50 border-red-200"
    } border`}>
      {success ? (
        <CheckCircle className="w-4 h-4 text-green-600" />
      ) : (
        <XCircle className="w-4 h-4 text-red-600" />
      )}
      <Icon className="w-4 h-4 text-gray-600" />
      <span className="text-sm">{message}</span>
      {action && (
        <button
          onClick={action.onClick}
          className="ml-auto text-xs text-blue-600 hover:underline"
        >
          {action.label}
        </button>
      )}
    </div>
  );
}
```

### Permission Checking
```typescript
// lib/permissions.ts
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

export function useCorridorPermission(corridorId: string) {
  const corridor = useQuery(api.corridors.getCorridor, { id: corridorId });
  const user = useQuery(api.users.getCurrentUser);

  if (!corridor || !user) return { loading: true, hasPermission: false };

  const hasPermission = corridor.userId === user._id;

  return { loading: false, hasPermission };
}

export async function checkVaultPermission(ctx: any, userId: string) {
  // Check if user has vault feature enabled
  // For now, all authenticated users have access
  return !!userId;
}

export async function checkTodoPermission(ctx: any, userId: string, corridorId: string) {
  // Verify user owns the corridor for the todo
  const corridor = await ctx.db.get(corridorId);
  return corridor && corridor.userId === userId;
}
```

---

## Dependencies

- **Upstream**: Story 10.2 (CopilotRuntime), Story 10.6 (Shared State)
- **CopilotKit**: useFrontendTool hook
- **Next.js**: useRouter for navigation
- **Convex**: documents, tasks mutations

---

## Testing Strategy

### Test Cases

1. **Navigation Tool**:
   - Navigates to correct corridor
   - Shows toast on navigation
   - Handles invalid corridor ID
   - Respects corridor ownership

2. **Expense Modal Tool**:
   - Opens modal successfully
   - Prefills data if provided
   - Handles already open modal
   - Shows feedback

3. **Save to Vault Tool**:
   - Creates document in Convex
   - Shows success toast
   - Handles duplicates
   - Validates required fields

4. **Add to Todos Tool**:
   - Creates task in Convex
   - Sets correct priority
   - Handles due date parsing
   - Links to task board

5. **Permission Checks**:
   - Denies non-owner corridor access
   - Returns helpful error message
   - Logs permission failures

6. **Integration**:
   - Agent triggers tool correctly
   - UI responds appropriately
   - Error states handled
