# Story 9.11: Enhanced Audio Briefings - Weekly Briefings

## Status

**Complete**

---

## Story

**As a** migrant managing a complex relocation process,
**I want** a comprehensive weekly audio briefing reviewing my progress and upcoming priorities,
**so that** I can reflect on achievements and plan the week ahead.

---

## Acceptance Criteria

1. Generate weekly audio briefing every Sunday evening (7 PM user timezone)
2. Aggregate full week's data from all 10 sources
3. Synthesize comprehensive review using Claude into engaging narrative
4. 7-section structure: week review, corridor intelligence, financial deep dive, community insights, roadmap, comparative analysis, celebration
5. Duration: 5-7 minutes (750-1000 words)
6. Include week-over-week comparisons and trend analysis
7. Highlight achievements and milestones from the week
8. Provide strategic recommendations for next week
9. Multi-language support via Google Cloud TTS
10. Optional email with summary bullet points and audio link

---

## Tasks / Subtasks

- [ ] **Task 1: Create Weekly Data Aggregation** (AC: 2, 6)
  - [ ] Create `aggregateWeeklyData` function
  - [ ] Query all activity from past 7 days:
    - Todos completed vs created
    - Documents saved and researched
    - Feed items read and engaged with
    - Expenses added and budget changes
    - Chat conversations and insights gained
    - Community posts and interactions
    - Corridor progress updates
  - [ ] Calculate week-over-week deltas:
    - Budget spent: This week vs last week
    - Todos completed: This week vs last week
    - Progress percentage: This week vs last week
  - [ ] Identify top 3 achievements of the week
  - [ ] Identify top 3 priorities for next week
  - [ ] Return comprehensive weekly summary object

- [ ] **Task 2: Build Weekly Script Generator** (AC: 3, 4, 7, 8)
  - [ ] Create `generateWeeklyScript` function with extended prompt
  - [ ] 7-section narrative structure:
    ```typescript
    const sections = [
      "week_review",           // Recap of the week's activities
      "corridor_intelligence", // Immigration news, policy updates, trends
      "financial_deep_dive",   // Detailed budget analysis, projections
      "community_insights",    // What others in your corridor are discussing
      "roadmap",              // Next week's priorities and timeline
      "comparative_analysis",  // Your progress vs typical timeline
      "celebration",          // Wins, milestones, motivation
    ];
    ```
  - [ ] Generate 750-1000 word narrative
  - [ ] Include specific metrics and data points
  - [ ] Storytelling approach: highlight journey narrative
  - [ ] End with actionable next steps

- [ ] **Task 3: Implement Trend Analysis** (AC: 6)
  - [ ] Calculate weekly trends:
    - Savings velocity: Increasing/decreasing/stable
    - Todo completion rate: Improving/declining
    - Budget adherence: On track/over/under
    - Progress pace: Ahead/behind/on schedule
  - [ ] Identify patterns:
    - Most productive day of week
    - Most common expense category
    - Most engaged feed topics
  - [ ] Generate insights from trends:
    - "Your savings rate increased 15% this week"
    - "You're most productive on Wednesdays"
    - "Visa expenses were 30% higher than planned"

- [ ] **Task 4: Create Weekly Cron Job** (AC: 1)
  - [ ] Add to `convex/crons.ts`:
    ```typescript
    crons.weekly(
      "generate-weekly-briefings",
      { hourUTC: 19, minuteUTC: 0, dayOfWeek: "sunday" },
      internal.ai.briefings.generateWeeklyBriefings
    );
    ```
  - [ ] For each active user:
    - Aggregate weekly data
    - Generate extended script
    - Synthesize longer audio (5-7 minutes)
    - Store briefing
    - Send email notification with summary

- [ ] **Task 5: Build Comparative Analysis** (AC: 8)
  - [ ] Query community data for similar corridors
  - [ ] Calculate average timeline for corridor
  - [ ] Compare user's progress to averages:
    - Days since onboarding vs average
    - Budget spent vs average
    - Milestones completed vs average
  - [ ] Provide context: "You're 2 weeks ahead of typical timeline"
  - [ ] Suggest optimizations based on community patterns

- [ ] **Task 6: Create Weekly Summary Email** (AC: 10)
  - [ ] HTML email template with:
    - Subject: "Your Weekly Migration Briefing ðŸ“Š"
    - Hero section with progress percentage
    - Bullet point summary of key sections
    - Embedded audio player or download link
    - "Listen Now" CTA button
    - Opt-out link
  - [ ] Send if user has email notifications enabled
  - [ ] Track open rates and engagement

---

## Technical Implementation Notes

### Weekly Data Aggregation
```typescript
async function aggregateWeeklyData(userId: string, corridorId: string) {
  const weekStart = Date.now() - (7 * 24 * 60 * 60 * 1000);

  // Get all activity from past week
  const [
    todosCompleted,
    todosCreated,
    documentsAdded,
    feedItemsRead,
    expensesAdded,
    chatMessages,
    communityActivity,
    budgetChanges,
  ] = await Promise.all([
    ctx.db.query("todos")
      .withIndex("by_user", q => q.eq("userId", userId))
      .filter(q => q.gte(q.field("completedAt"), weekStart))
      .collect(),

    ctx.db.query("todos")
      .withIndex("by_user", q => q.eq("userId", userId))
      .filter(q => q.gte(q.field("createdAt"), weekStart))
      .collect(),

    ctx.db.query("savedDocuments")
      .withIndex("by_user", q => q.eq("userId", userId))
      .filter(q => q.gte(q.field("createdAt"), weekStart))
      .collect(),

    // ... other queries
  ]);

  // Calculate week-over-week changes
  const prevWeekStart = weekStart - (7 * 24 * 60 * 60 * 1000);
  const prevWeekData = await getPreviousWeekData(userId, prevWeekStart, weekStart);

  const budgetSpentThisWeek = calculateWeeklySpending(expensesAdded);
  const budgetSpentLastWeek = prevWeekData.budgetSpent;
  const spendingDelta = ((budgetSpentThisWeek - budgetSpentLastWeek) / budgetSpentLastWeek) * 100;

  return {
    thisWeek: {
      todosCompleted: todosCompleted.length,
      todosCreated: todosCreated.length,
      documentsAdded: documentsAdded.length,
      budgetSpent: budgetSpentThisWeek,
      progressGain: calculateProgressGain(userId, weekStart),
    },
    lastWeek: prevWeekData,
    deltas: {
      todos: todosCompleted.length - prevWeekData.todosCompleted,
      documents: documentsAdded.length - prevWeekData.documentsAdded,
      spending: spendingDelta,
      progress: calculateProgressGain(userId, weekStart) - prevWeekData.progressGain,
    },
    achievements: identifyAchievements(userId, weekStart),
    priorities: identifyPriorities(userId),
  };
}
```

### Weekly Script Generation
```typescript
async function generateWeeklyScript(data: WeeklyData, user: User) {
  const prompt = `Generate a comprehensive, engaging weekly migration briefing for ${user.name}.

CONTEXT:
- Origin: ${data.corridor.origin}
- Destination: ${data.corridor.destination}
- Overall Progress: ${data.corridor.progressPercentage}%
- Days since onboarding: ${data.corridor.daysActive}

THIS WEEK'S DATA:
- Todos completed: ${data.thisWeek.todosCompleted} (${data.deltas.todos > 0 ? '+' : ''}${data.deltas.todos} vs last week)
- Documents saved: ${data.thisWeek.documentsAdded}
- Budget spent: $${data.thisWeek.budgetSpent} (${data.deltas.spending > 0 ? '+' : ''}${data.deltas.spending}% vs last week)
- Progress gain: ${data.thisWeek.progressGain}%

ACHIEVEMENTS:
${data.achievements.map(a => `- ${a.title}: ${a.description}`).join('\n')}

CORRIDOR INTELLIGENCE:
- Policy updates: ${data.policyUpdates}
- Job market: ${data.jobTrends}
- Community discussions: ${data.communityTopics}

FINANCIAL ANALYSIS:
- Total spent: ${data.financial.totalSpent} (${data.financial.percentSpent}% of budget)
- Remaining: ${data.financial.remaining}
- On track: ${data.financial.onTrack ? 'Yes' : 'No'}

COMPARATIVE ANALYSIS:
- Your timeline: ${data.comparison.userDays} days
- Average timeline: ${data.comparison.avgDays} days
- Status: ${data.comparison.status} (${data.comparison.delta} days ${data.comparison.ahead ? 'ahead' : 'behind'})

NEXT WEEK'S PRIORITIES:
${data.priorities.map(p => `- ${p.title}`).join('\n')}

STRUCTURE (750-1000 words):
1. Week Review: Recap this week's activities, wins, and challenges
2. Corridor Intelligence: Deep dive into immigration news, policy changes, job market trends
3. Financial Deep Dive: Budget analysis, spending patterns, projections
4. Community Insights: What your corridor community is discussing and learning
5. Roadmap: Next week's priorities, timeline, key milestones
6. Comparative Analysis: How you compare to others in your corridor
7. Celebration: Acknowledge achievements, provide motivation

TONE: Reflective, insightful, strategic. Use data to tell a story. Make it engaging like a podcast episode.`;

  const response = await anthropic.messages.create({
    model: "claude-3-5-sonnet-20241022",
    max_tokens: 2000,
    messages: [{ role: "user", content: prompt }],
  });

  return response.content[0].text;
}
```

### Trend Analysis
```typescript
function analyzeTrends(weeklyData: WeeklyData[]) {
  // Analyze last 4 weeks of data
  const weeks = weeklyData.slice(-4);

  // Savings velocity trend
  const savingsVelocity = weeks.map(w => w.budgetSpent);
  const savingsTrend = calculateTrend(savingsVelocity);
  // Returns: "increasing", "decreasing", "stable"

  // Todo completion trend
  const todoCompletionRates = weeks.map(w => w.todosCompleted / w.todosCreated);
  const completionTrend = calculateTrend(todoCompletionRates);

  // Identify patterns
  const dayOfWeekActivity = groupByDayOfWeek(weeklyData.flatMap(w => w.activities));
  const mostProductiveDay = Object.keys(dayOfWeekActivity)
    .sort((a, b) => dayOfWeekActivity[b].length - dayOfWeekActivity[a].length)[0];

  return {
    savings: {
      trend: savingsTrend,
      message: getSavingsTrendMessage(savingsTrend, savingsVelocity),
    },
    productivity: {
      trend: completionTrend,
      mostProductiveDay,
      message: `You're most productive on ${mostProductiveDay}s`,
    },
  };
}

function calculateTrend(values: number[]): "increasing" | "decreasing" | "stable" {
  const firstHalf = values.slice(0, Math.floor(values.length / 2));
  const secondHalf = values.slice(Math.floor(values.length / 2));

  const firstAvg = firstHalf.reduce((sum, v) => sum + v, 0) / firstHalf.length;
  const secondAvg = secondHalf.reduce((sum, v) => sum + v, 0) / secondHalf.length;

  const change = ((secondAvg - firstAvg) / firstAvg) * 100;

  if (change > 10) return "increasing";
  if (change < -10) return "decreasing";
  return "stable";
}
```

---

## Dependencies

- **APIs**: Claude API, Google Cloud TTS, Perplexity API
- **Convex Tables**: audioBriefings, todos, savedDocuments, financialExpenses
- **Related Stories**: 9.10 (Daily Briefings), 9.12 (Multi-language)

---

## Example Weekly Briefing Script

```
Welcome to your weekly migration briefing for the week of January 8th to 14th.

What a productive week! You completed 12 tasks, added 5 important documents to your library, and made significant progress on your Express Entry profile. You're now at 68% completion - that's a 5% jump from last week. The momentum is building!

Let's dive into corridor intelligence. This week, Canada announced some exciting changes to their Express Entry system. Processing times for tech workers have been reduced to 6-8 weeks - down from the previous 10-12 weeks. This is great news for your timeline. We're also seeing strong job market activity with 47 new software engineering positions posted in Toronto this week, a 15% increase from last week.

On the financial front, you spent $580 this week across various categories. That's 12% higher than last week, primarily due to your medical examination and document translation costs. You're currently at 43% of your total budget with 4 months remaining - still well on track. Based on current spending patterns, you're projected to finish $300 under budget, which gives you a nice cushion for unexpected costs.

Your corridor community has been buzzing this week. The top discussion was about the new digital nomad visa option, with many sharing their experiences. One particularly helpful tip from a community member: banks in Canada often waive their first-year fees for newcomers - something to remember when you arrive.

Looking ahead to next week, your top three priorities are: First, complete your police clearance certificate application - this has a 4-week processing time, so getting it started now keeps you on schedule. Second, finalize your reference letters from previous employers. And third, review and shortlist housing options in Toronto.

How do you compare to others? You're actually 2 weeks ahead of the typical timeline for your corridor. While the average migrant at this stage is at 60% completion, you're at 68%. Your budget management is also better than average - you're spending 5% less than typical at this stage.

This week's wins: You achieved two major milestones - completing your language test and submitting your Express Entry profile. You also maintained your 8-week savings streak and stayed consistent with your financial goals. These aren't just checkmarks - each one is a real step toward your new life.

Keep up the excellent momentum. Your next big milestone is just 3 weeks away. You've got this!
```

---

## Testing Strategy

1. **Data Aggregation**:
   - Test with full week of activity â†’ Complete briefing
   - Test with minimal activity â†’ Shorter briefing
   - Test week-over-week deltas â†’ Accurate calculations
   - Test with missing data â†’ Graceful handling

2. **Script Quality**:
   - Verify all 7 sections present
   - Check narrative flow and engagement
   - Validate data accuracy in script
   - Test tone and personalization

3. **Audio Duration**:
   - Verify 5-7 minute target (750-1000 words)
   - Test with different languages â†’ Adjusted for speaking rate
   - Check audio quality and naturalness

4. **Trend Analysis**:
   - Test with increasing trend â†’ "Your savings are accelerating"
   - Test with decreasing trend â†’ "Consider adjusting strategy"
   - Test with stable trend â†’ "You're maintaining consistency"

---

## Cost Estimates

| Service | Usage (per user/week) | Cost |
|---------|----------------------|------|
| Claude API | 1000 words | ~$0.003 |
| Google TTS | 1000 chars | Free tier âœ“ |
| Perplexity | 4 queries | Rate limited |
| Storage | ~5 MB audio | ~$0.0001 |

**Weekly cost per user**: < $0.01
**Monthly cost (100 users)**: < $5

---

## Email Template (Weekly Summary)

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; }
    .header { background: #000; color: #fff; padding: 30px; text-align: center; }
    .metric { text-align: center; padding: 20px; border: 4px solid #000; margin: 10px 0; }
    .progress-bar { height: 32px; background: #e5e7eb; border: 3px solid #000; margin: 20px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ“Š Your Weekly Migration Briefing</h1>
    <p>Week of January 8-14, 2025</p>
  </div>

  <div style="padding: 30px;">
    <div class="metric">
      <h2 style="margin: 0; font-size: 48px;">68%</h2>
      <p style="margin: 5px 0 0 0;">Migration Progress</p>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" style="width: 68%"></div>
    </div>

    <h3>This Week's Highlights:</h3>
    <ul>
      <li>âœ… Completed Express Entry profile submission</li>
      <li>âœ… Finished language test (IELTS: 8.0 overall)</li>
      <li>ðŸ“ˆ 5% progress gain from last week</li>
      <li>ðŸ’° Maintained 8-week savings streak</li>
      <li>ðŸŽ¯ You're 2 weeks ahead of typical timeline</li>
    </ul>

    <h3>Next Week's Priorities:</h3>
    <ol>
      <li>Complete police clearance certificate application</li>
      <li>Finalize reference letters</li>
      <li>Review housing options in Toronto</li>
    </ol>

    <div style="text-align: center; margin: 30px 0;">
      <a href="https://tribe.app/briefings/weekly" style="display: inline-block; background: #000; color: #fff; padding: 16px 32px; text-decoration: none; font-weight: bold; font-size: 18px;">
        ðŸŽ§ Listen to Full Briefing (6 min)
      </a>
    </div>

    <p style="text-align: center; color: #666; font-size: 12px; margin-top: 30px;">
      <a href="#" style="color: #666;">Unsubscribe from weekly briefings</a>
    </p>
  </div>
</body>
</html>
```

---

## Accessibility & User Experience

- Skip to specific sections in audio player
- Transcript with section headers for easy scanning
- Downloadable PDF summary alongside audio
- Adjustable playback speed (0.5x to 2x)
- Chapter markers for 7 sections
- Keyboard shortcuts for player control
