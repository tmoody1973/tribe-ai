# Story 7.1: Task Board Implementation

**Epic:** Epic 7 - Task Board (Kanban)
**Story:** Complete Task Board Feature Implementation
**Status:** Ready for Development
**Priority:** High

---

## Overview

Implement a Trello-style Kanban task board that integrates with the existing protocol system, allowing users to visually track migration tasks with drag-and-drop functionality.

## Dependencies

- `@dnd-kit/core` - Core drag-and-drop functionality
- `@dnd-kit/sortable` - Sortable items within columns
- `@dnd-kit/utilities` - CSS utilities for transforms

Reference implementation: https://github.com/janhesters/shadcn-kanban-board

## Implementation Tasks

### 1. Database Schema (Convex)

**File:** `convex/schema.ts`

Add the tasks table:

```typescript
tasks: defineTable({
  corridorId: v.id("corridors"),
  protocolStepId: v.optional(v.id("protocols")),
  title: v.string(),
  description: v.optional(v.string()),
  column: v.union(
    v.literal("todo"),
    v.literal("in_progress"),
    v.literal("blocked"),
    v.literal("done")
  ),
  priority: v.union(
    v.literal("critical"),
    v.literal("high"),
    v.literal("medium"),
    v.literal("low")
  ),
  category: v.optional(v.union(
    v.literal("visa"),
    v.literal("finance"),
    v.literal("housing"),
    v.literal("employment"),
    v.literal("legal"),
    v.literal("health"),
    v.literal("social")
  )),
  dueDate: v.optional(v.number()),
  order: v.number(),
  notes: v.optional(v.string()),
  completedAt: v.optional(v.number()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_corridor", ["corridorId"])
  .index("by_corridor_column", ["corridorId", "column"])
  .index("by_protocol_step", ["protocolStepId"])
  .index("by_category", ["corridorId", "category"]),
```

### 2. Convex Functions

**File:** `convex/tasks.ts`

Create CRUD operations:

```typescript
// Queries
- getTasks(corridorId) - Get all tasks for a journey
- getTasksByColumn(corridorId, column) - Get tasks filtered by column
- getTaskForProtocolStep(protocolStepId) - Check if protocol step has a task

// Mutations
- createTask(corridorId, title, description?, priority, category?, dueDate?, column?)
- createTaskFromProtocol(protocolStepId) - Create task linked to protocol step
- updateTaskColumn(taskId, column, order) - Move task + sync protocol if needed
- updateTask(taskId, fields) - Update task details
- deleteTask(taskId) - Delete task
- reorderTasks(taskIds, orders) - Batch reorder for drag-drop
```

### 3. Install Dependencies

```bash
pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

### 4. Component Structure

Create in `components/taskboard/`:

1. **TaskBoard.tsx** - Main container with DndContext
2. **TaskColumn.tsx** - Droppable column (To Do, In Progress, Blocked, Done)
3. **TaskCard.tsx** - Task card display
4. **TaskCardDraggable.tsx** - Wrapper with useSortable hook
5. **TaskDetailModal.tsx** - Edit task modal/drawer
6. **TaskForm.tsx** - Create/edit form
7. **TaskFilters.tsx** - Filter by category/priority/due date
8. **AddTaskButton.tsx** - Quick add floating button
9. **EmptyColumn.tsx** - Empty state per column

### 5. Key Features to Implement

#### Drag-and-Drop (using @dnd-kit)
- DndContext provider wrapping the board
- SortableContext for each column
- Sensors for mouse, touch, and keyboard
- Collision detection strategy
- Optimistic UI updates

#### Protocol Integration
- "Add to Board" button on ProtocolCard
- Badge showing "On Board" when task exists
- Two-way sync: completing task marks protocol done
- Link from task back to source protocol

#### Journey Scoping
- Tasks filtered by active corridor
- Journey switcher updates board
- Each journey has independent board state

### 6. UI/UX Guidelines

- Neobrutalist styling consistent with existing UI
- Responsive: columns stack on mobile
- Color-coded priority indicators
- Due date badges with overdue highlighting
- Smooth drag animations with Framer Motion

### 7. Dashboard Integration

**File:** `app/[locale]/(dashboard)/dashboard/page.tsx`

Add TaskBoard widget to the dashboard layout. Options:
- Full-width section below protocols
- Collapsible widget in sidebar
- Separate /taskboard route with link from dashboard

### 8. Translations

**File:** `messages/en.json`

Add translation keys:
```json
"taskboard": {
  "title": "Task Board",
  "columns": {
    "todo": "To Do",
    "in_progress": "In Progress",
    "blocked": "Blocked",
    "done": "Done"
  },
  "addTask": "Add Task",
  "addToBoard": "Add to Board",
  "onBoard": "On Board",
  "emptyColumn": "No tasks here yet",
  "dragToMove": "Drag to move"
}
```

---

## Acceptance Criteria

- [ ] Four-column Kanban board displays for active journey
- [ ] Tasks can be dragged between columns
- [ ] Task completion syncs with linked protocol step
- [ ] Custom tasks can be created without protocol link
- [ ] Protocol cards show "Add to Board" button
- [ ] Board updates when journey is switched
- [ ] Filters work for category, priority, due date
- [ ] Task details can be edited via modal
- [ ] Mobile-responsive layout
- [ ] Neobrutalist styling matches existing UI

---

## Technical Notes

### @dnd-kit Implementation Pattern

```tsx
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';

function TaskBoard() {
  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    if (over && active.id !== over.id) {
      // Update task column/order in Convex
    }
  };

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      {columns.map((column) => (
        <SortableContext items={tasks} strategy={verticalListSortingStrategy}>
          <TaskColumn column={column} tasks={columnTasks} />
        </SortableContext>
      ))}
    </DndContext>
  );
}
```

### Protocol-Task Sync Pattern

```typescript
// In updateTaskColumn mutation
if (column === "done" && task.protocolStepId) {
  await ctx.db.patch(task.protocolStepId, {
    status: "completed",
    completedAt: Date.now(),
  });
}
```

---

## Definition of Done

1. All acceptance criteria met
2. Tests written for Convex functions
3. Component tests for TaskBoard
4. No TypeScript errors
5. Translations added for all supported languages
6. Documentation updated if needed
7. QA review passed
