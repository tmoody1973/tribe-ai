# Story 9.8: Savings Goals - Progress Tracking & Insights

## Status

**Complete**

---

## Story

**As a** user working toward multiple savings goals,
**I want** to see insights and analytics on my progress,
**so that** I understand my saving patterns and stay motivated.

---

## Acceptance Criteria

1. Display total savings across all goals with summary statistics
2. Show progress velocity (average savings per week/month)
3. Calculate projected completion date based on current savings rate
4. Identify goals at risk (behind schedule) with visual warnings
5. Show savings streak (consecutive weeks with contributions)
6. Display savings history chart (line/bar chart over time)
7. Compare actual progress vs. planned trajectory
8. Provide actionable insights and recommendations
9. Export savings report as PDF (future enhancement)
10. Filter insights by date range (7 days, 30 days, 90 days, all time)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Savings Insights Dashboard** (AC: 1, 10)
  - [ ] Create `components/finances/SavingsInsights.tsx`
  - [ ] Summary cards:
    - Total Saved: Sum of currentAmount across all goals
    - Total Target: Sum of targetAmount across all goals
    - Overall Progress: Total saved / Total target
    - Active Goals Count
  - [ ] Date range selector: 7 days, 30 days, 90 days, all time
  - [ ] Mobile-responsive grid layout
  - [ ] Neo-brutalism card design

- [ ] **Task 2: Calculate Savings Velocity** (AC: 2, 3)
  - [ ] Create `convex/financial.ts` query: `getSavingsVelocity`
  - [ ] Track savings updates with timestamps
  - [ ] Calculate average savings per week over selected period
  - [ ] Calculate average savings per month over selected period
  - [ ] Project completion date: (target - current) / avgPerWeek
  - [ ] Display: "At current rate, you'll reach goal in X weeks"
  - [ ] Show confidence interval based on consistency

- [ ] **Task 3: Implement Risk Detection** (AC: 4)
  - [ ] For each goal, calculate expected progress:
    ```typescript
    const totalDays = targetDate - createdAt;
    const daysElapsed = Date.now() - createdAt;
    const expectedProgress = (daysElapsed / totalDays) * targetAmount;
    const isAtRisk = currentAmount < expectedProgress * 0.8; // 20% behind
    ```
  - [ ] Display warning badge for at-risk goals
  - [ ] Show "Recommended weekly savings" to get back on track
  - [ ] Alert notification when goal falls behind schedule
  - [ ] Highlight at-risk goals in dashboard

- [ ] **Task 4: Build Savings Streak Tracker** (AC: 5)
  - [ ] Create `savingsActivity` table:
    ```typescript
    savingsActivity: defineTable({
      userId: v.id("users"),
      goalId: v.id("savingsGoals"),
      amount: v.number(),
      weekNumber: v.number(), // YYYY-WW format
      createdAt: v.number(),
    })
    ```
  - [ ] Track consecutive weeks with savings contributions
  - [ ] Display current streak: "ðŸ”¥ 7 week streak!"
  - [ ] Show longest streak: "Best: 12 weeks"
  - [ ] Celebrate streak milestones (4 weeks, 8 weeks, 12 weeks)
  - [ ] Warning when streak is at risk (no contribution this week)

- [ ] **Task 5: Create Savings History Chart** (AC: 6, 7)
  - [ ] Install charting library: `npm install recharts`
  - [ ] Create line chart component showing savings over time
  - [ ] X-axis: Weeks/Months
  - [ ] Y-axis: Cumulative savings amount
  - [ ] Plot actual savings as solid line
  - [ ] Plot planned trajectory as dotted line
  - [ ] Highlight milestones with markers
  - [ ] Color-code: on track (green), behind (red), ahead (blue)
  - [ ] Tooltip showing exact amounts and dates

- [ ] **Task 6: Generate Actionable Insights** (AC: 8)
  - [ ] Create AI-powered insights engine
  - [ ] Analyze saving patterns and provide recommendations:
    ```typescript
    const insights = [
      "You save 40% more on Fridays - consider automated transfers",
      "Emergency Fund is 80% complete - great progress!",
      "Travel Fund is behind schedule. Save $50/week to catch up",
      "You've maintained a 6-week streak - keep it going!",
    ];
    ```
  - [ ] Categorize insights: Achievements, Warnings, Suggestions
  - [ ] Display in card format with icons
  - [ ] Refresh insights weekly
  - [ ] Prioritize actionable recommendations

- [ ] **Task 7: Build Savings Report Generator** (AC: 9 - Future)
  - [ ] Create PDF export functionality
  - [ ] Report sections:
    - Summary statistics
    - Goal progress breakdown
    - Savings history chart
    - Insights and recommendations
  - [ ] Professional formatting with TRIBE branding
  - [ ] Download as PDF or share via email
  - [ ] Generate monthly or custom date range reports

---

## Technical Implementation Notes

### Savings Velocity Calculation
```typescript
export const getSavingsVelocity = query({
  args: {
    userId: v.id("users"),
    periodDays: v.number(), // 7, 30, 90
  },
  handler: async (ctx, args) => {
    const startDate = Date.now() - (args.periodDays * 24 * 60 * 60 * 1000);

    // Get all savings activity in period
    const activities = await ctx.db
      .query("savingsActivity")
      .withIndex("by_user", q => q.eq("userId", args.userId))
      .filter(q => q.gte(q.field("createdAt"), startDate))
      .collect();

    const totalSaved = activities.reduce((sum, a) => sum + a.amount, 0);
    const daysInPeriod = args.periodDays;
    const avgPerDay = totalSaved / daysInPeriod;
    const avgPerWeek = avgPerDay * 7;
    const avgPerMonth = avgPerDay * 30;

    return {
      totalSaved,
      avgPerDay,
      avgPerWeek,
      avgPerMonth,
      contributionCount: activities.length,
      consistency: calculateConsistency(activities, daysInPeriod),
    };
  },
});

function calculateConsistency(activities: any[], days: number) {
  const weeksInPeriod = Math.ceil(days / 7);
  const weeksWithActivity = new Set(
    activities.map(a => getWeekNumber(a.createdAt))
  ).size;

  return Math.round((weeksWithActivity / weeksInPeriod) * 100);
}
```

### Risk Detection Algorithm
```typescript
interface GoalRiskAnalysis {
  goalId: string;
  riskLevel: "low" | "medium" | "high";
  behindSchedule: boolean;
  recommendedWeeklySavings: number;
  daysRemaining: number;
}

function analyzeGoalRisk(goal: SavingsGoal): GoalRiskAnalysis {
  if (!goal.targetDate) {
    return { riskLevel: "low", behindSchedule: false, ... };
  }

  const totalDays = goal.targetDate - goal.createdAt;
  const daysElapsed = Date.now() - goal.createdAt;
  const daysRemaining = Math.max(0, goal.targetDate - Date.now());

  const expectedProgress = (daysElapsed / totalDays) * goal.targetAmount;
  const actualProgress = goal.currentAmount;
  const percentBehind = ((expectedProgress - actualProgress) / expectedProgress) * 100;

  let riskLevel: "low" | "medium" | "high" = "low";
  if (percentBehind > 30) riskLevel = "high";
  else if (percentBehind > 15) riskLevel = "medium";

  const remainingAmount = goal.targetAmount - actualProgress;
  const weeksRemaining = daysRemaining / 7;
  const recommendedWeeklySavings = Math.ceil(remainingAmount / weeksRemaining);

  return {
    goalId: goal._id,
    riskLevel,
    behindSchedule: percentBehind > 10,
    recommendedWeeklySavings,
    daysRemaining,
  };
}
```

### Savings History Chart
```typescript
// Using Recharts
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

function SavingsChart({ goalId, period }: { goalId: string, period: number }) {
  const history = useQuery(api.financial.getSavingsHistory, { goalId, period });
  const goal = useQuery(api.financial.getSavingsGoal, { goalId });

  // Generate planned trajectory
  const plannedData = generatePlannedTrajectory(goal);

  return (
    <LineChart width={600} height={300} data={history}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="week" />
      <YAxis />
      <Tooltip />
      <Legend />
      <Line type="monotone" dataKey="actual" stroke="#3b82f6" strokeWidth={2} />
      <Line type="monotone" dataKey="planned" stroke="#94a3b8" strokeDasharray="5 5" />
    </LineChart>
  );
}

function generatePlannedTrajectory(goal) {
  const weeks = Math.ceil((goal.targetDate - goal.createdAt) / (7 * 24 * 60 * 60 * 1000));
  const weeklyTarget = goal.targetAmount / weeks;

  return Array.from({ length: weeks }, (_, i) => ({
    week: `Week ${i + 1}`,
    planned: weeklyTarget * (i + 1),
  }));
}
```

---

## Dependencies

- **Libraries**: recharts (charts), jsPDF (PDF export - future)
- **Convex Tables**: savingsGoals, savingsActivity (new)
- **Related Stories**: 9.7 (Goal Creation), 9.9 (Notifications)

---

## UI Components

### Insights Dashboard Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ’° Savings Insights                      [7D][30D][90D][All]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Total Saved â”‚ â”‚ Total Targetâ”‚ â”‚  Progress   â”‚           â”‚
â”‚ â”‚   $6,250    â”‚ â”‚  $15,000    â”‚ â”‚    42%      â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚ ðŸ“ˆ Savings Velocity                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ $125/week average   â”‚   Projected: 18 weeks to complete â”‚â”‚
â”‚ â”‚ $540/month average  â”‚   Consistency: 87%                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ ðŸ”¥ Streak Status                                           â”‚
â”‚ Current: 7 weeks ðŸ”¥  |  Longest: 12 weeks                 â”‚
â”‚                                                             â”‚
â”‚ ðŸ“Š Savings Over Time                                       â”‚
â”‚ [Line Chart: Actual vs Planned]                           â”‚
â”‚                                                             â”‚
â”‚ ðŸ’¡ Insights & Recommendations                              â”‚
â”‚ âœ… Emergency Fund: 80% complete - excellent progress!      â”‚
â”‚ âš ï¸  Travel Fund: Behind schedule. Save $75/week to catch upâ”‚
â”‚ ðŸŽ¯ You save 40% more on Fridays - automate transfers      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Insights Algorithm

### Pattern Detection
```typescript
interface SavingsPattern {
  dayOfWeekPreference: number; // 0-6 (Sun-Sat)
  avgAmountPerContribution: number;
  contributionFrequency: "daily" | "weekly" | "biweekly" | "monthly";
  peakSavingDay: string;
}

function detectSavingsPatterns(activities: SavingsActivity[]): SavingsPattern {
  // Group by day of week
  const byDayOfWeek = groupBy(activities, a => new Date(a.createdAt).getDay());
  const mostActiveDay = Object.keys(byDayOfWeek)
    .sort((a, b) => byDayOfWeek[b].length - byDayOfWeek[a].length)[0];

  // Calculate average time between contributions
  const sortedActivities = activities.sort((a, b) => a.createdAt - b.createdAt);
  const intervals = sortedActivities.slice(1).map((a, i) =>
    a.createdAt - sortedActivities[i].createdAt
  );
  const avgInterval = intervals.reduce((sum, i) => sum + i, 0) / intervals.length;
  const avgIntervalDays = avgInterval / (24 * 60 * 60 * 1000);

  let frequency: "daily" | "weekly" | "biweekly" | "monthly" = "weekly";
  if (avgIntervalDays < 3) frequency = "daily";
  else if (avgIntervalDays < 10) frequency = "weekly";
  else if (avgIntervalDays < 20) frequency = "biweekly";
  else frequency = "monthly";

  return {
    dayOfWeekPreference: parseInt(mostActiveDay),
    avgAmountPerContribution: activities.reduce((sum, a) => sum + a.amount, 0) / activities.length,
    contributionFrequency: frequency,
    peakSavingDay: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][parseInt(mostActiveDay)],
  };
}
```

---

## Testing Strategy

1. **Velocity Calculations**:
   - Test with consistent weekly savings â†’ Accurate velocity
   - Test with irregular savings â†’ Averaged velocity
   - Test with no savings â†’ 0 velocity
   - Test projection accuracy over time

2. **Risk Detection**:
   - Goal on track â†’ Green status
   - Goal 15% behind â†’ Medium risk warning
   - Goal 30% behind â†’ High risk alert
   - Goal with no target date â†’ No risk assessment

3. **Streak Tracking**:
   - Weekly contribution â†’ Streak continues
   - Skip a week â†’ Streak breaks
   - Multiple contributions per week â†’ Counts as one week
   - First contribution â†’ Streak starts at 1

4. **Chart Accuracy**:
   - Verify actual line matches database
   - Verify planned line matches calculation
   - Test with various date ranges
   - Test milestone markers appear correctly

---

## Performance Optimization

- Cache insights calculation (refresh hourly)
- Lazy load charts (only when insights tab active)
- Paginate savings history for long time periods
- Index savingsActivity by week for faster aggregation
- Debounce date range selector
