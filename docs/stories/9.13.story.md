# Story 9.13: Travel Buddy API - Visa Pathway Discovery

## Status

**Pending**

---

## Story

**As a** migrant exploring destination options,
**I want** to discover visa pathways through conversational AI chat,
**so that** I can understand my options without navigating complex visa databases.

---

## Acceptance Criteria

1. Travel Buddy API v2 integration with three endpoints:
   - `/v2/visa/map` - Get all 210 destinations for a passport
   - `/v2/visa/check` - Get detailed visa requirements between two countries
   - `/v2/passport/rank/custom` - Get passport difficulty score
2. VisaRequirements table in Convex schema for caching visa data
3. AI chat tool `searchVisaOptions` for conversational visa discovery
4. Weekly cron job refreshes visa data for active corridors
5. Data cached for 7 days to minimize API calls
6. Supplemented with Perplexity API for processing times and policy updates
7. Processing times database from manual research and cached data
8. Stay within free tier: 120 requests/month (30 corridors Ã— 4 weeks)
9. Graceful fallback when API quota exceeded
10. Integration with CopilotKit chat for seamless UX

---

## Tasks / Subtasks

- [ ] **Task 1: Setup Travel Buddy API Client** (AC: 1)
  - [ ] Sign up for Travel Buddy API and get API key
  - [ ] Store API key in environment variable: `TRAVEL_BUDDY_API_KEY`
  - [ ] Create `lib/api/travel-buddy.ts` API client module
  - [ ] Implement `getVisaMap(passport)` - calls `/v2/visa/map`
  - [ ] Implement `checkVisaRequirements(origin, destination)` - calls `/v2/visa/check`
  - [ ] Implement `getPassportRank(passport)` - calls `/v2/passport/rank/custom`
  - [ ] Add error handling for API failures and rate limits
  - [ ] Add TypeScript types for API responses

- [ ] **Task 2: Create Visa Requirements Schema** (AC: 2)
  - [ ] Add `visaRequirements` table to `convex/schema.ts` (already done in architecture)
  - [ ] Fields: origin, destination, visaRequired, visaType, stayDuration, requirements[], processingTime, cachedAt, expiresAt
  - [ ] Add indices: by_corridor (origin + destination), by_expiry
  - [ ] Create `convex/visas.ts` with CRUD operations
  - [ ] Implement `getCached` query to fetch cached visa data
  - [ ] Implement `cache` mutation to store API responses
  - [ ] Implement `clearExpired` mutation to remove old data

- [ ] **Task 3: Build Visa Discovery Convex Actions** (AC: 3, 5, 6)
  - [ ] Create `convex/ai/visa-discovery.ts`
  - [ ] Implement `searchVisaPathways` action:
    - Check cache first (7-day expiry)
    - Call Travel Buddy API if cache miss
    - Store results in Convex
    - Return formatted visa options
  - [ ] Implement `getDetailedRequirements` action:
    - Fetch from Travel Buddy `/v2/visa/check`
    - Supplement with Perplexity for processing times
    - Combine Travel Buddy + Perplexity + cached data
    - Return comprehensive visa guide
  - [ ] Add error handling for API quota exceeded
  - [ ] Log API usage for monitoring

- [ ] **Task 4: Create CopilotKit Chat Tool** (AC: 3, 10)
  - [ ] Add `searchVisaOptions` tool to CopilotKit configuration
  - [ ] Tool parameters: originPassport (string), preferredDestinations (optional array)
  - [ ] Tool description: "Discover visa pathways and requirements for migration destinations"
  - [ ] Call Convex `searchVisaPathways` action
  - [ ] Format response as conversational text with visa options
  - [ ] Include visa-free destinations, visa-on-arrival, e-visa, embassy visa
  - [ ] Sort by ease of entry (visa-free first, then by processing time)
  - [ ] Highlight opportunities (easy visas, work permits, study options)

- [ ] **Task 5: Implement Weekly Cron Job** (AC: 4, 8)
  - [ ] Add to `convex/crons.ts`:
    ```typescript
    crons.weekly(
      "refresh-visa-data",
      { hourUTC: 3, minuteUTC: 0, dayOfWeek: "monday" },
      internal.integrations.visa.refreshActiveCorridorData
    );
    ```
  - [ ] Create `convex/integrations/visa.ts` with `refreshActiveCorridorData` internal action
  - [ ] Query all active corridors (users with stage !== "dreaming")
  - [ ] Limit to 30 most recent corridors to stay within 120/month quota
  - [ ] For each corridor, fetch visa data from Travel Buddy API
  - [ ] Update cache with fresh data
  - [ ] Log refresh statistics (corridors updated, API calls made)

- [ ] **Task 6: Build Processing Times Database** (AC: 7)
  - [ ] Create `processingTimes` table in Convex:
    - Fields: origin, destination, visaType, averageProcessingDays, source, lastUpdated
    - Indices: by_corridor, by_source
  - [ ] Seed initial data from manual research (common migration corridors)
  - [ ] Implement Perplexity query to fetch latest processing times:
    ```typescript
    perplexity.search(`${destination} visa processing time from ${origin} 2025`)
    ```
  - [ ] Parse Perplexity response and extract processing time estimates
  - [ ] Store in database with source attribution
  - [ ] Update monthly via cron job

- [ ] **Task 7: Implement Quota Management** (AC: 8, 9)
  - [ ] Create `apiQuota` table to track Travel Buddy API usage:
    - Fields: endpoint, callCount, resetDate
  - [ ] Increment counter on each API call
  - [ ] Check quota before making API calls
  - [ ] If quota exceeded, return cached data (even if expired) with warning
  - [ ] Alert user: "Visa data may be outdated. Refresh quota resets on [date]"
  - [ ] Admin dashboard to monitor API usage (future enhancement)

---

## Technical Implementation Notes

### Travel Buddy API Client
```typescript
// lib/api/travel-buddy.ts
export async function getVisaPathways(originPassport: string) {
  const cached = await ctx.runQuery(api.visas.getCached, { origin: originPassport });
  if (cached && Date.now() - cached.lastUpdated < 7 * 24 * 60 * 60 * 1000) {
    return cached.pathways;
  }

  // Endpoint: /v2/visa/map - Returns all 210 destinations for a passport
  const response = await fetch(
    `https://travel-buddy.ai/api/v2/visa/map?passport=${originPassport}`,
    { headers: { Authorization: `Bearer ${process.env.TRAVEL_BUDDY_API_KEY}` } }
  );

  const data = await response.json();

  await ctx.runMutation(api.visas.cache, {
    origin: originPassport,
    pathways: data.destinations,
    lastUpdated: Date.now()
  });

  return data.destinations;
}

export async function checkVisaRequirements(origin: string, destination: string) {
  // Endpoint: /v2/visa/check
  const response = await fetch(
    `https://travel-buddy.ai/api/v2/visa/check?passport=${origin}&destination=${destination}`,
    { headers: { Authorization: `Bearer ${process.env.TRAVEL_BUDDY_API_KEY}` } }
  );

  return await response.json();
}
```

### CopilotKit Tool Integration
```typescript
// In CopilotKit configuration
useCopilotAction({
  name: "searchVisaOptions",
  description: "Discover visa pathways for migration destinations based on passport",
  parameters: [
    {
      name: "originPassport",
      type: "string",
      description: "User's passport country (e.g., 'Nigeria', 'India', 'Philippines')",
      required: true
    },
    {
      name: "preferredRegions",
      type: "array",
      description: "Optional array of preferred destination regions",
      required: false
    }
  ],
  handler: async ({ originPassport, preferredRegions }) => {
    const visaOptions = await searchVisaPathways({ originPassport, preferredRegions });

    return {
      text: `
ðŸŒ Visa Discovery for ${originPassport} Passport

EASY OPTIONS (Visa-Free or Visa-on-Arrival):
${visaOptions.visaFree.map(d => `â€¢ ${d.country} - ${d.stayDuration} days`).join('\n')}

E-VISA AVAILABLE:
${visaOptions.eVisa.map(d => `â€¢ ${d.country} - Processing: ${d.processingTime}`).join('\n')}

EMBASSY VISA REQUIRED:
${visaOptions.embassyVisa.map(d => `â€¢ ${d.country} - Difficulty: ${d.difficulty}/10`).join('\n')}

ðŸ’¡ I can help you explore any of these destinations in detail!
      `
    };
  }
});
```

### Weekly Cron Job
```typescript
// convex/integrations/visa.ts
export const refreshActiveCorridorData = internalAction({
  handler: async (ctx) => {
    // Get active corridors (limit to 30 for quota management)
    const corridors = await ctx.runQuery(internal.corridors.getActiveCorridors, { limit: 30 });

    let apiCalls = 0;
    for (const corridor of corridors) {
      try {
        const visaData = await checkVisaRequirements(corridor.origin, corridor.destination);

        await ctx.runMutation(api.visas.cache, {
          origin: corridor.origin,
          destination: corridor.destination,
          ...visaData,
          cachedAt: Date.now(),
          expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
        });

        apiCalls++;
      } catch (error) {
        console.error(`Failed to refresh visa data for ${corridor.origin} â†’ ${corridor.destination}`, error);
      }
    }

    console.log(`Visa data refresh complete: ${apiCalls} API calls made for ${corridors.length} corridors`);
  }
});
```

---

## Dependencies

- **APIs**: Travel Buddy API v2, Perplexity API
- **Environment Variables**: TRAVEL_BUDDY_API_KEY, PERPLEXITY_API_KEY
- **Convex Tables**: visaRequirements, processingTimes, apiQuota
- **Related Stories**: 5.1 (AI Chat), 2.3 (Corridor Management)

---

## API Quota Management

| Tier | Requests/Month | Cost | Usage Plan |
|------|---------------|------|-----------|
| Free | 120 | $0 | 30 corridors Ã— 4 weekly refreshes = 120/month âœ“ |
| Basic | 3,000 | $4.99 | Scale to 750 corridors or daily refreshes |
| Pro | 10,000 | $14.99 | Enterprise scale with hourly refreshes |

**Current Plan**: Free tier with 30 active corridor limit

---

## Testing Strategy

1. **API Integration Tests**:
   - Mock Travel Buddy API responses
   - Test all three endpoints with sample data
   - Verify cache hit/miss logic
   - Test quota exceeded scenarios

2. **Chat Tool Tests**:
   - Test conversational queries: "Where can I go with a Nigerian passport?"
   - Test specific destination queries: "What are the visa requirements for Canada?"
   - Test edge cases: invalid passport names, unsupported countries

3. **Cron Job Tests**:
   - Manually trigger cron job in development
   - Verify API calls stay within quota (30 corridors max)
   - Check cache updates and expiry logic
   - Monitor API usage logs

4. **User Experience Tests**:
   - Test proactive visa suggestions during onboarding
   - Test "Explore Alternatives" tip on corridor dashboard
   - Test visa intelligence in weekly briefings
   - Verify graceful degradation when quota exceeded

---

## User Feedback Integration

After launch, collect feedback on:
- Visa data accuracy (report outdated requirements)
- Processing time estimates (compare to actual user experiences)
- Missing destinations or visa types
- Desired visa pathway features (job search visas, study permits, etc.)

Use feedback to:
1. Improve processing times database
2. Add user-contributed data points
3. Prioritize API quota spending on high-demand corridors
4. Enhance AI chat tool prompts and responses
