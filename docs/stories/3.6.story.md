# Story 3.6: Corridor Statistics Panel

## Status

**Completed**

---

## Story

**As a** user,
**I want** to see key statistics about my corridor,
**so that** I understand the broader context of my migration.

---

## Acceptance Criteria

1. Stats panel shows: visa requirement type, average processing time
2. Cost of living comparison: origin vs destination (rent, food, transport)
3. Currency conversion display (origin ‚Üí destination)
4. Timezone difference displayed
5. Primary language of destination
6. Stats sourced from structured APIs (Story 2.2)
7. Stats refresh on corridor change

---

## Tasks / Subtasks

- [x] **Task 1: Create Expanded Stats Panel Component** (AC: 1, 2, 4, 5)
  - [x] Create `components/corridor/CorridorStatsPanel.tsx`
  - [x] Display visa type and processing time
  - [x] Show cost of living comparison
  - [x] Display timezone difference
  - [x] Show destination language

- [x] **Task 2: Create Cost Comparison Component** (AC: 2)
  - [x] Create `components/corridor/CostComparisonPanel.tsx`
  - [x] Bar chart or comparison cards for costs
  - [x] Categories: rent, groceries, transport, utilities
  - [x] Show percentage difference (cheaper/more expensive)

- [x] **Task 3: Create Currency Conversion Component** (AC: 3)
  - [x] Create `components/corridor/CurrencyConverter.tsx`
  - [x] Display exchange rate (1 origin = X destination)
  - [x] Show currency symbols and names
  - [x] Interactive converter with swap functionality

- [x] **Task 4: Create Timezone Display Component** (AC: 4)
  - [x] Create `components/corridor/TimezoneCompare.tsx`
  - [x] Show both timezones with current time
  - [x] Calculate hour difference
  - [x] Timezone normalization for UTC offsets

- [x] **Task 5: Fetch and Display Stats Data** (AC: 6, 7)
  - [x] Use `getCorridorBaseline` action from Story 2.2
  - [x] Handle loading states
  - [x] Handle missing data gracefully
  - [x] Re-fetch when corridor changes

- [x] **Task 6: Create Stats Loading Skeleton** (AC: 6)
  - [x] Create skeleton for stats panel
  - [x] Animate with pulse effect
  - [x] Match final layout dimensions

- [x] **Task 7: Add Stats Translations** (AC: 1-5)
  - [x] Add stat labels to locale files
  - [x] Add comparison phrases ("X% higher", "X hours ahead")
  - [x] Cost, currency, and timezone translation sections

---

## Dev Notes

### Corridor Stats Panel Component
[Source: architecture.md#components]

```typescript
// components/corridor/CorridorStatsPanel.tsx
"use client";

import { useAction, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { useTranslations } from "next-intl";
import { useState, useEffect } from "react";
import { CostComparison } from "./CostComparison";
import { CurrencyConverter } from "./CurrencyConverter";
import { TimezoneCompare } from "./TimezoneCompare";
import { StatsLoadingSkeleton } from "./StatsLoadingSkeleton";

interface CorridorStatsPanelProps {
  corridorId: Id<"corridors">;
}

interface CorridorBaseline {
  origin: {
    name: string;
    currency: { code: string; symbol: string; name: string };
    languages: string[];
    timezone: string;
  };
  destination: {
    name: string;
    currency: { code: string; symbol: string; name: string };
    languages: string[];
    timezone: string;
  };
  visa: {
    visaRequired: boolean;
    visaType?: string;
    processingTime?: string;
    stayDuration?: string;
  };
  costs: {
    rent: { origin: number; destination: number };
    groceries: { origin: number; destination: number };
    transport: { origin: number; destination: number };
    utilities: { origin: number; destination: number };
  };
  exchange: {
    rate: number;
    lastUpdated: number;
  };
}

export function CorridorStatsPanel({ corridorId }: CorridorStatsPanelProps) {
  const t = useTranslations("stats");
  const corridor = useQuery(api.corridors.getCorridor, { id: corridorId });
  const [baseline, setBaseline] = useState<CorridorBaseline | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  const getBaseline = useAction(api.corridorData.getCorridorBaseline);

  useEffect(() => {
    if (corridor) {
      setIsLoading(true);
      getBaseline({
        origin: corridor.origin,
        destination: corridor.destination,
      })
        .then(setBaseline)
        .catch(console.error)
        .finally(() => setIsLoading(false));
    }
  }, [corridor?.origin, corridor?.destination]);

  if (isLoading || !baseline) {
    return <StatsLoadingSkeleton />;
  }

  return (
    <div className="space-y-6">
      {/* Visa Information */}
      <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
        <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
          {t("visaInfo")}
        </h3>

        <div className="space-y-3">
          <StatRow
            icon="üõÇ"
            label={t("visaRequired")}
            value={baseline.visa.visaRequired ? t("yes") : t("no")}
            highlight={baseline.visa.visaRequired}
          />

          {baseline.visa.visaType && (
            <StatRow
              icon="üìã"
              label={t("visaType")}
              value={baseline.visa.visaType}
            />
          )}

          {baseline.visa.processingTime && (
            <StatRow
              icon="‚è±Ô∏è"
              label={t("processingTime")}
              value={baseline.visa.processingTime}
            />
          )}

          {baseline.visa.stayDuration && (
            <StatRow
              icon="üìÖ"
              label={t("stayDuration")}
              value={baseline.visa.stayDuration}
            />
          )}
        </div>
      </div>

      {/* Cost Comparison */}
      <CostComparison
        costs={baseline.costs}
        originName={baseline.origin.name}
        destinationName={baseline.destination.name}
        originCurrency={baseline.origin.currency}
        destinationCurrency={baseline.destination.currency}
      />

      {/* Currency Conversion */}
      <CurrencyConverter
        originCurrency={baseline.origin.currency}
        destinationCurrency={baseline.destination.currency}
        exchangeRate={baseline.exchange.rate}
        lastUpdated={baseline.exchange.lastUpdated}
      />

      {/* Timezone Comparison */}
      <TimezoneCompare
        originTimezone={baseline.origin.timezone}
        destinationTimezone={baseline.destination.timezone}
        originName={baseline.origin.name}
        destinationName={baseline.destination.name}
      />

      {/* Language */}
      <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
        <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
          {t("language")}
        </h3>

        <StatRow
          icon="üó£Ô∏è"
          label={t("primaryLanguage")}
          value={baseline.destination.languages[0] ?? "‚Äî"}
        />

        {baseline.destination.languages.length > 1 && (
          <p className="text-sm text-gray-500 mt-2">
            {t("otherLanguages")}: {baseline.destination.languages.slice(1).join(", ")}
          </p>
        )}
      </div>
    </div>
  );
}

interface StatRowProps {
  icon: string;
  label: string;
  value: string;
  highlight?: boolean;
}

function StatRow({ icon, label, value, highlight = false }: StatRowProps) {
  return (
    <div className="flex items-center justify-between">
      <span className="text-gray-600 flex items-center gap-2">
        <span>{icon}</span>
        {label}
      </span>
      <span className={`font-bold ${highlight ? "text-red-600" : ""}`}>
        {value}
      </span>
    </div>
  );
}
```

### Cost Comparison Component
```typescript
// components/corridor/CostComparison.tsx
"use client";

import { useTranslations } from "next-intl";

interface CostData {
  origin: number;
  destination: number;
}

interface CostComparisonProps {
  costs: {
    rent: CostData;
    groceries: CostData;
    transport: CostData;
    utilities: CostData;
  };
  originName: string;
  destinationName: string;
  originCurrency: { code: string; symbol: string };
  destinationCurrency: { code: string; symbol: string };
}

export function CostComparison({
  costs,
  originName,
  destinationName,
  originCurrency,
  destinationCurrency,
}: CostComparisonProps) {
  const t = useTranslations("stats.costs");

  const categories = [
    { key: "rent", label: t("rent"), icon: "üè†", data: costs.rent },
    { key: "groceries", label: t("groceries"), icon: "üõí", data: costs.groceries },
    { key: "transport", label: t("transport"), icon: "üöå", data: costs.transport },
    { key: "utilities", label: t("utilities"), icon: "üí°", data: costs.utilities },
  ];

  return (
    <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
      <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
        {t("title")}
      </h3>

      <div className="text-xs text-gray-500 mb-4">
        {originName} ({originCurrency.symbol}) vs {destinationName} ({destinationCurrency.symbol})
      </div>

      <div className="space-y-4">
        {categories.map(({ key, label, icon, data }) => {
          const diff = ((data.destination - data.origin) / data.origin) * 100;
          const isHigher = diff > 0;

          return (
            <div key={key} className="space-y-1">
              <div className="flex items-center justify-between text-sm">
                <span className="flex items-center gap-2">
                  <span>{icon}</span>
                  {label}
                </span>
                <span className={isHigher ? "text-red-600 font-bold" : "text-green-600 font-bold"}>
                  {isHigher ? "+" : ""}{diff.toFixed(0)}%
                </span>
              </div>

              {/* Comparison Bar */}
              <div className="flex gap-1 h-4">
                <div
                  className="bg-blue-500 border border-black"
                  style={{ width: `${(data.origin / Math.max(data.origin, data.destination)) * 100}%` }}
                  title={`${originName}: ${originCurrency.symbol}${data.origin}`}
                />
                <div
                  className={`${isHigher ? "bg-red-400" : "bg-green-400"} border border-black`}
                  style={{ width: `${(data.destination / Math.max(data.origin, data.destination)) * 100}%` }}
                  title={`${destinationName}: ${destinationCurrency.symbol}${data.destination}`}
                />
              </div>

              <div className="flex justify-between text-xs text-gray-500">
                <span>{originCurrency.symbol}{data.origin}</span>
                <span>{destinationCurrency.symbol}{data.destination}</span>
              </div>
            </div>
          );
        })}
      </div>

      <p className="text-xs text-gray-400 mt-4">
        {t("disclaimer")}
      </p>
    </div>
  );
}
```

### Currency Converter Component
```typescript
// components/corridor/CurrencyConverter.tsx
"use client";

import { useState } from "react";
import { useTranslations } from "next-intl";
import { ArrowRightLeft } from "lucide-react";

interface CurrencyConverterProps {
  originCurrency: { code: string; symbol: string; name: string };
  destinationCurrency: { code: string; symbol: string; name: string };
  exchangeRate: number;
  lastUpdated: number;
}

export function CurrencyConverter({
  originCurrency,
  destinationCurrency,
  exchangeRate,
  lastUpdated,
}: CurrencyConverterProps) {
  const t = useTranslations("stats.currency");
  const [amount, setAmount] = useState(100);
  const [isReversed, setIsReversed] = useState(false);

  const converted = isReversed
    ? amount / exchangeRate
    : amount * exchangeRate;

  const fromCurrency = isReversed ? destinationCurrency : originCurrency;
  const toCurrency = isReversed ? originCurrency : destinationCurrency;
  const displayRate = isReversed ? 1 / exchangeRate : exchangeRate;

  return (
    <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
      <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
        {t("title")}
      </h3>

      {/* Exchange Rate Display */}
      <div className="text-center mb-4 p-3 bg-gray-50 border-2 border-black">
        <span className="text-2xl font-bold">
          1 {fromCurrency.code} = {displayRate.toFixed(2)} {toCurrency.code}
        </span>
      </div>

      {/* Converter */}
      <div className="flex items-center gap-2 mb-4">
        <div className="flex-1">
          <label className="text-xs text-gray-500">{fromCurrency.name}</label>
          <div className="relative">
            <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500">
              {fromCurrency.symbol}
            </span>
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(Number(e.target.value))}
              className="w-full border-2 border-black p-2 pl-8 font-bold"
            />
          </div>
        </div>

        <button
          onClick={() => setIsReversed(!isReversed)}
          className="p-2 border-2 border-black hover:bg-gray-100"
        >
          <ArrowRightLeft size={20} />
        </button>

        <div className="flex-1">
          <label className="text-xs text-gray-500">{toCurrency.name}</label>
          <div className="relative">
            <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500">
              {toCurrency.symbol}
            </span>
            <div className="w-full border-2 border-black p-2 pl-8 font-bold bg-gray-50">
              {converted.toFixed(2)}
            </div>
          </div>
        </div>
      </div>

      <p className="text-xs text-gray-400">
        {t("lastUpdated")}: {new Date(lastUpdated).toLocaleDateString()}
      </p>
    </div>
  );
}
```

### Timezone Compare Component
```typescript
// components/corridor/TimezoneCompare.tsx
"use client";

import { useState, useEffect } from "react";
import { useTranslations } from "next-intl";

interface TimezoneCompareProps {
  originTimezone: string;
  destinationTimezone: string;
  originName: string;
  destinationName: string;
}

export function TimezoneCompare({
  originTimezone,
  destinationTimezone,
  originName,
  destinationName,
}: TimezoneCompareProps) {
  const t = useTranslations("stats.timezone");
  const [times, setTimes] = useState({ origin: "", destination: "" });

  useEffect(() => {
    const updateTimes = () => {
      const now = new Date();

      const originTime = now.toLocaleTimeString("en-US", {
        timeZone: originTimezone,
        hour: "2-digit",
        minute: "2-digit",
      });

      const destinationTime = now.toLocaleTimeString("en-US", {
        timeZone: destinationTimezone,
        hour: "2-digit",
        minute: "2-digit",
      });

      setTimes({ origin: originTime, destination: destinationTime });
    };

    updateTimes();
    const interval = setInterval(updateTimes, 60000); // Update every minute

    return () => clearInterval(interval);
  }, [originTimezone, destinationTimezone]);

  // Calculate hour difference
  const getHourDifference = () => {
    const now = new Date();
    const originOffset = new Date(now.toLocaleString("en-US", { timeZone: originTimezone }));
    const destOffset = new Date(now.toLocaleString("en-US", { timeZone: destinationTimezone }));
    const diffHours = Math.round((destOffset.getTime() - originOffset.getTime()) / 3600000);
    return diffHours;
  };

  const hourDiff = getHourDifference();
  const diffText = hourDiff > 0
    ? t("hoursAhead", { hours: hourDiff })
    : hourDiff < 0
    ? t("hoursBehind", { hours: Math.abs(hourDiff) })
    : t("sameTime");

  return (
    <div className="border-4 border-black bg-white p-4 shadow-[4px_4px_0_0_#000]">
      <h3 className="text-lg font-bold mb-4 border-b-2 border-black pb-2">
        {t("title")}
      </h3>

      <div className="flex justify-between items-center">
        {/* Origin Time */}
        <div className="text-center">
          <p className="text-xs text-gray-500">{originName}</p>
          <p className="text-2xl font-bold font-mono">{times.origin}</p>
          <p className="text-xs text-gray-400">{originTimezone}</p>
        </div>

        {/* Difference */}
        <div className="text-center px-4">
          <div className="bg-yellow-100 border-2 border-yellow-500 px-3 py-1">
            <span className="font-bold text-yellow-800">{diffText}</span>
          </div>
        </div>

        {/* Destination Time */}
        <div className="text-center">
          <p className="text-xs text-gray-500">{destinationName}</p>
          <p className="text-2xl font-bold font-mono">{times.destination}</p>
          <p className="text-xs text-gray-400">{destinationTimezone}</p>
        </div>
      </div>
    </div>
  );
}
```

### Stats Loading Skeleton
```typescript
// components/corridor/StatsLoadingSkeleton.tsx
export function StatsLoadingSkeleton() {
  return (
    <div className="space-y-6 animate-pulse">
      {/* Visa Info Skeleton */}
      <div className="border-4 border-gray-200 bg-gray-100 p-4 h-48" />

      {/* Cost Comparison Skeleton */}
      <div className="border-4 border-gray-200 bg-gray-100 p-4 h-64" />

      {/* Currency Skeleton */}
      <div className="border-4 border-gray-200 bg-gray-100 p-4 h-40" />

      {/* Timezone Skeleton */}
      <div className="border-4 border-gray-200 bg-gray-100 p-4 h-32" />
    </div>
  );
}
```

### Translation Keys
```json
// messages/en.json - Add stats section
{
  "stats": {
    "visaInfo": "Visa Information",
    "visaRequired": "Visa Required",
    "visaType": "Visa Type",
    "processingTime": "Processing Time",
    "stayDuration": "Stay Duration",
    "yes": "Yes",
    "no": "No",
    "language": "Language",
    "primaryLanguage": "Primary Language",
    "otherLanguages": "Also spoken",
    "costs": {
      "title": "Cost of Living Comparison",
      "rent": "Rent (1BR apartment)",
      "groceries": "Groceries (monthly)",
      "transport": "Transport (monthly)",
      "utilities": "Utilities (monthly)",
      "disclaimer": "Costs are approximate and may vary by city"
    },
    "currency": {
      "title": "Currency Conversion",
      "lastUpdated": "Rate as of"
    },
    "timezone": {
      "title": "Time Difference",
      "hoursAhead": "{hours}h ahead",
      "hoursBehind": "{hours}h behind",
      "sameTime": "Same time"
    }
  }
}
```

### File Structure
```
components/
‚îî‚îÄ‚îÄ corridor/
    ‚îú‚îÄ‚îÄ CorridorStatsPanel.tsx     # Main stats panel
    ‚îú‚îÄ‚îÄ CostComparison.tsx         # Cost comparison bars
    ‚îú‚îÄ‚îÄ CurrencyConverter.tsx      # Currency converter
    ‚îú‚îÄ‚îÄ TimezoneCompare.tsx        # Timezone display
    ‚îî‚îÄ‚îÄ StatsLoadingSkeleton.tsx   # Loading skeleton
```

### Dependencies from Previous Stories
- Story 2.2: getCorridorBaseline action, structured API data
- Story 3.1: QuickStats component (simplified version)

---

## Testing

### Test Scenarios

1. **Visa Information**
   - [ ] Visa required status shown
   - [ ] Visa type displayed
   - [ ] Processing time shown (if available)

2. **Cost Comparison**
   - [ ] All 4 categories displayed
   - [ ] Percentage difference calculated correctly
   - [ ] Bar chart shows relative costs
   - [ ] Colors indicate higher/lower

3. **Currency Conversion**
   - [ ] Exchange rate displayed
   - [ ] Converter calculates correctly
   - [ ] Swap button works
   - [ ] Last updated date shown

4. **Timezone**
   - [ ] Both times displayed
   - [ ] Hour difference calculated
   - [ ] Times update every minute
   - [ ] Correct timezone names

5. **Loading State**
   - [ ] Skeleton shows while loading
   - [ ] Transitions to content
   - [ ] Handles API errors

6. **Corridor Change**
   - [ ] Stats refresh on corridor switch
   - [ ] Loading state appears
   - [ ] New data displayed

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

**Completed:** 2025-12-22

### Files Created
- `components/corridor/CorridorStatsPanel.tsx` - Main orchestration component
- `components/corridor/CostComparisonPanel.tsx` - Cost of living comparison with index bars
- `components/corridor/CurrencyConverter.tsx` - Interactive currency converter with swap
- `components/corridor/TimezoneCompare.tsx` - Live timezone comparison
- `components/corridor/StatsLoadingSkeleton.tsx` - Loading skeleton

### Files Modified
- `messages/en.json` - Added stats translation section with costs, currency, timezone subsections

### Implementation Notes
- Used `getCorridorBaseline` action from Story 2.2 for data fetching
- Cost comparison uses NYC = 100 baseline index system
- Currency converter includes static fallback exchange rates
- Timezone component normalizes UTC offsets to IANA timezone names
- All components follow neobrutalist design system
- Loading skeleton matches final layout dimensions

### Build Status
- TypeScript: ‚úÖ Passed
- Next.js build: ‚úÖ Passed

---

## QA Results
*To be filled by QA Agent*
