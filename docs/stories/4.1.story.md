# Story 4.1: Q&A Chat Interface with CopilotKit

## Status

**Draft**

---

## Story

**As a** user,
**I want** a chat interface to ask questions about my migration,
**so that** I can get specific answers beyond the standard protocol.

---

## Acceptance Criteria

1. CopilotKit integrated with Mastra backend (`@copilotkit/react-core`, `@copilotkit/react-ui`, `@ag-ui/mastra`)
2. CopilotChat component configured with custom labels and initial messaging
3. Runtime context passes user corridor, stage, and language to agent
4. Streaming responses render incrementally for better UX
5. Conversation history persisted to Convex per user
6. Bidirectional state sync enables real-time corridor context updates
7. RetroUI theming applied to CopilotKit components

---

## Tasks / Subtasks

- [ ] **Task 1: Install CopilotKit Dependencies** (AC: 1)
  - [ ] Install `@copilotkit/react-core`
  - [ ] Install `@copilotkit/react-ui`
  - [ ] Install `@ag-ui/mastra`
  - [ ] Verify peer dependencies resolved

- [ ] **Task 2: Create CopilotKit Provider** (AC: 1, 3, 6)
  - [ ] Create `components/providers/CopilotKitProvider.tsx`
  - [ ] Configure runtime URL pointing to API route
  - [ ] Pass corridor, stage, language as properties
  - [ ] Wrap dashboard layout with provider

- [ ] **Task 3: Create Chat Window Component** (AC: 2, 4, 7)
  - [ ] Create `components/chat/ChatWindow.tsx`
  - [ ] Configure CopilotChat with custom labels
  - [ ] Add initial welcome message
  - [ ] Apply RetroUI styling overrides

- [ ] **Task 4: Implement State Sync** (AC: 6)
  - [ ] Use `useCopilotReadable` for corridor data
  - [ ] Sync user profile to agent context
  - [ ] Sync protocol completion status
  - [ ] Update context on data changes

- [ ] **Task 5: Create Chat History Persistence** (AC: 5)
  - [ ] Add `chatMessages` table to Convex schema
  - [ ] Create `saveMessage` mutation
  - [ ] Create `getMessages` query
  - [ ] Load history on chat mount

- [ ] **Task 6: Create Chat API Route** (AC: 1, 4)
  - [ ] Create `app/api/copilotkit/route.ts`
  - [ ] Configure Mastra integration
  - [ ] Enable streaming responses
  - [ ] Pass user context from request

- [ ] **Task 7: Style Chat with RetroUI** (AC: 7)
  - [ ] Override CopilotKit CSS variables
  - [ ] Apply border and shadow styles
  - [ ] Match input styling to theme
  - [ ] Style message bubbles

- [ ] **Task 8: Add Chat to Dashboard** (AC: 1-7)
  - [ ] Add chat route `app/[locale]/(dashboard)/chat/page.tsx`
  - [ ] Add chat toggle/panel to dashboard
  - [ ] Handle responsive layout

---

## Dev Notes

### CopilotKit Provider
[Source: architecture.md#copilotkit-integration]

```typescript
// components/providers/CopilotKitProvider.tsx
"use client";

import { CopilotKit } from "@copilotkit/react-core";
import { useUser } from "@clerk/nextjs";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

interface CopilotKitProviderProps {
  children: React.ReactNode;
}

export function CopilotKitProvider({ children }: CopilotKitProviderProps) {
  const { user } = useUser();
  const profile = useQuery(api.users.getProfile);
  const activeCorridor = useQuery(api.corridors.getActiveCorridor);

  return (
    <CopilotKit
      runtimeUrl="/api/copilotkit"
      properties={{
        userId: profile?._id,
        corridor: activeCorridor
          ? {
              origin: activeCorridor.origin,
              destination: activeCorridor.destination,
              id: activeCorridor._id,
            }
          : null,
        stage: activeCorridor?.stage,
        language: profile?.language ?? "en",
      }}
    >
      {children}
    </CopilotKit>
  );
}
```

### Chat Window Component
```typescript
// components/chat/ChatWindow.tsx
"use client";

import { useCopilotChat, useCopilotReadable } from "@copilotkit/react-core";
import { CopilotChat } from "@copilotkit/react-ui";
import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";
import { useTranslations } from "next-intl";
import { useEffect } from "react";
import "@copilotkit/react-ui/styles.css";

interface ChatWindowProps {
  corridorId: Id<"corridors">;
}

export function ChatWindow({ corridorId }: ChatWindowProps) {
  const t = useTranslations("chat");
  const corridor = useQuery(api.corridors.getCorridor, { id: corridorId });
  const protocols = useQuery(api.protocols.getProtocols, { corridorId });
  const progress = useQuery(api.progress.getProgress, { corridorId });

  // Sync state to CopilotKit for context-aware responses
  useCopilotReadable({
    description: "Current migration corridor",
    value: corridor,
  });

  useCopilotReadable({
    description: "User's protocol checklist and completion status",
    value: { protocols, progress },
  });

  return (
    <div className="h-full flex flex-col border-4 border-black shadow-[4px_4px_0_0_#000]">
      <CopilotChat
        labels={{
          title: t("title"),
          initial: t("welcome"),
          placeholder: t("placeholder"),
        }}
        icons={{
          sendIcon: <SendIcon />,
        }}
        className="flex-1"
      />
    </div>
  );
}

function SendIcon() {
  return (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
    </svg>
  );
}
```

### Chat History Schema
```typescript
// convex/schema.ts - Add chatMessages table
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // ... existing tables ...

  chatMessages: defineTable({
    userId: v.id("users"),
    corridorId: v.optional(v.id("corridors")),
    role: v.union(v.literal("user"), v.literal("assistant")),
    content: v.string(),
    metadata: v.optional(v.object({
      sources: v.optional(v.array(v.string())),
      model: v.optional(v.string()),
      tokens: v.optional(v.number()),
    })),
    createdAt: v.number(),
  })
    .index("by_user", ["userId"])
    .index("by_user_corridor", ["userId", "corridorId"]),
});
```

### Chat Mutations
```typescript
// convex/chat.ts
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const saveMessage = mutation({
  args: {
    role: v.union(v.literal("user"), v.literal("assistant")),
    content: v.string(),
    corridorId: v.optional(v.id("corridors")),
    metadata: v.optional(v.object({
      sources: v.optional(v.array(v.string())),
      model: v.optional(v.string()),
      tokens: v.optional(v.number()),
    })),
  },
  handler: async (ctx, { role, content, corridorId, metadata }) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .first();

    if (!user) throw new Error("User not found");

    return ctx.db.insert("chatMessages", {
      userId: user._id,
      corridorId,
      role,
      content,
      metadata,
      createdAt: Date.now(),
    });
  },
});

export const getMessages = query({
  args: {
    corridorId: v.optional(v.id("corridors")),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, { corridorId, limit = 50 }) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return [];

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .first();

    if (!user) return [];

    const query = corridorId
      ? ctx.db
          .query("chatMessages")
          .withIndex("by_user_corridor", (q) =>
            q.eq("userId", user._id).eq("corridorId", corridorId)
          )
      : ctx.db
          .query("chatMessages")
          .withIndex("by_user", (q) => q.eq("userId", user._id));

    const messages = await query.order("desc").take(limit);
    return messages.reverse(); // Return in chronological order
  },
});

export const clearHistory = mutation({
  args: {
    corridorId: v.optional(v.id("corridors")),
  },
  handler: async (ctx, { corridorId }) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .first();

    if (!user) throw new Error("User not found");

    const messages = corridorId
      ? await ctx.db
          .query("chatMessages")
          .withIndex("by_user_corridor", (q) =>
            q.eq("userId", user._id).eq("corridorId", corridorId)
          )
          .collect()
      : await ctx.db
          .query("chatMessages")
          .withIndex("by_user", (q) => q.eq("userId", user._id))
          .collect();

    for (const msg of messages) {
      await ctx.db.delete(msg._id);
    }

    return { deleted: messages.length };
  },
});
```

### CopilotKit API Route
```typescript
// app/api/copilotkit/route.ts
import {
  CopilotRuntime,
  copilotRuntimeNextJSAppRouterEndpoint,
} from "@copilotkit/runtime";
import { Mastra } from "@mastra/core";
import { protocolAdvisor } from "@/agents/protocolAdvisor";

// Initialize Mastra
const mastra = new Mastra({
  agents: {
    protocolAdvisor,
  },
});

// Create runtime with Mastra integration
const runtime = new CopilotRuntime({
  remoteEndpoints: [
    {
      url: process.env.MASTRA_ENDPOINT_URL!,
    },
  ],
});

export const POST = async (req: Request) => {
  const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
    runtime,
    endpoint: "/api/copilotkit",
  });

  return handleRequest(req);
};
```

### RetroUI Chat Styles
```css
/* app/globals.css - CopilotKit theme overrides */
.copilot-chat-window {
  --copilot-kit-primary-color: #000000;
  --copilot-kit-background-color: #ffffff;
  --copilot-kit-border-radius: 0;
}

.copilot-chat-window .copilot-kit-message {
  border: 2px solid #000;
  border-radius: 0;
  box-shadow: 2px 2px 0 0 #000;
}

.copilot-chat-window .copilot-kit-user-message {
  background-color: #fef3c7;
}

.copilot-chat-window .copilot-kit-assistant-message {
  background-color: #f3f4f6;
}

.copilot-chat-window .copilot-kit-input {
  border: 4px solid #000;
  border-radius: 0;
}

.copilot-chat-window .copilot-kit-send-button {
  background-color: #000;
  color: #fff;
  border-radius: 0;
  font-weight: bold;
}

.copilot-chat-window .copilot-kit-send-button:hover {
  background-color: #333;
}
```

### Chat Page
```typescript
// app/[locale]/(dashboard)/chat/page.tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { ChatWindow } from "@/components/chat/ChatWindow";
import { useTranslations } from "next-intl";

export default function ChatPage() {
  const t = useTranslations("chat");
  const corridor = useQuery(api.corridors.getActiveCorridor);

  if (!corridor) {
    return (
      <div className="border-4 border-black bg-gray-50 p-8 text-center">
        <p>{t("noCorridorSelected")}</p>
      </div>
    );
  }

  return (
    <div className="h-[calc(100vh-200px)]">
      <ChatWindow corridorId={corridor._id} />
    </div>
  );
}
```

### Translation Keys
```json
// messages/en.json - Add chat section
{
  "chat": {
    "title": "Ask TRIBE",
    "welcome": "Hi! I'm your migration assistant. Ask me anything about your journey from {{origin}} to {{destination}}.",
    "placeholder": "Ask about visas, costs, housing...",
    "noCorridorSelected": "Please select a corridor first",
    "clearHistory": "Clear chat history",
    "sources": "Sources"
  }
}
```

### File Structure
```
components/
├── providers/
│   └── CopilotKitProvider.tsx
└── chat/
    ├── ChatWindow.tsx
    ├── MessageList.tsx
    └── ChatInput.tsx

convex/
└── chat.ts               # Chat message persistence

app/
├── api/
│   └── copilotkit/
│       └── route.ts
└── [locale]/
    └── (dashboard)/
        └── chat/
            └── page.tsx
```

### Dependencies from Previous Stories
- Story 1.2: Clerk authentication
- Story 1.4: Dashboard layout
- Story 3.1: Corridor context

---

## Testing

### Test Scenarios

1. **Chat Interface**
   - [ ] Chat window renders with welcome message
   - [ ] Input field accepts text
   - [ ] Send button submits message

2. **Streaming Responses**
   - [ ] Text appears incrementally
   - [ ] Loading indicator during generation
   - [ ] No jarring jumps

3. **Context Awareness**
   - [ ] Agent knows user's corridor
   - [ ] Agent references user's stage
   - [ ] Responses in user's language

4. **Message Persistence**
   - [ ] Messages saved to Convex
   - [ ] History loads on page refresh
   - [ ] Clear history works

5. **RetroUI Styling**
   - [ ] Black borders on messages
   - [ ] Correct colors for user/assistant
   - [ ] Input matches theme

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*
