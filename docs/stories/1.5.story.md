# Story 1.5: User Profile & Onboarding Data Model

## Status

**Draft**

---

## Story

**As a** user,
**I want** to complete onboarding and have my preferences saved,
**so that** the app personalizes content to my specific migration journey.

---

## Acceptance Criteria

1. Convex schema includes users table with: clerkId, language, originCountry, destinationCountry, stage, visaType, createdAt, updatedAt
2. Onboarding flow collects: language (first), origin country, destination country, stage (Planning/Pre-departure/Arrived/Settled), visa type (optional)
3. Onboarding data saved to Convex user profile on completion
4. Returning users skip onboarding and go directly to dashboard
5. Profile settings page allows editing all onboarding fields
6. Corridor derived from origin + destination countries
7. Stage selection includes localized descriptions of each stage

---

## Tasks / Subtasks

- [ ] **Task 1: Extend Convex Users Schema** (AC: 1)
  - [ ] Update `convex/schema.ts` users table:
    ```typescript
    users: defineTable({
      clerkId: v.string(),
      email: v.string(),
      name: v.string(),
      language: v.union(v.literal("en"), v.literal("yo"), v.literal("hi"), v.literal("pt"), v.literal("tl")),
      originCountry: v.optional(v.string()),      // ISO 3166-1 alpha-2
      destinationCountry: v.optional(v.string()), // ISO 3166-1 alpha-2
      stage: v.optional(v.union(
        v.literal("dreaming"),
        v.literal("planning"),
        v.literal("preparing"),
        v.literal("relocating"),
        v.literal("settling")
      )),
      visaType: v.optional(v.string()),
      onboardingComplete: v.boolean(),
      createdAt: v.number(),
      updatedAt: v.number(),
    })
    ```
  - [ ] Run `npx convex dev` to apply schema changes

- [ ] **Task 2: Create Onboarding Mutations** (AC: 3)
  - [ ] Add `completeOnboarding` mutation to `convex/users.ts`
  - [ ] Add `updateProfile` mutation for settings page
  - [ ] Add `getProfile` query to fetch current user
  - [ ] Validate country codes against known list

- [ ] **Task 3: Create Onboarding Wizard Component** (AC: 2)
  - [ ] Create `components/onboarding/OnboardingWizard.tsx`
  - [ ] Multi-step form with progress indicator
  - [ ] Steps: Language → Origin → Destination → Stage → Visa Type (optional)
  - [ ] "Back" and "Next" navigation between steps
  - [ ] "Complete" button on final step

- [ ] **Task 4: Create Country Selector Component** (AC: 2)
  - [ ] Create `components/onboarding/CountrySelector.tsx`
  - [ ] Searchable dropdown with all countries
  - [ ] Show country flag next to name
  - [ ] Use REST Countries API or static list for country data
  - [ ] Style with RetroUI select/dropdown

- [ ] **Task 5: Create Stage Selector Component** (AC: 2, 7)
  - [ ] Create `components/onboarding/StageSelector.tsx`
  - [ ] Display 5 migration stages as cards/radio buttons
  - [ ] Each stage shows localized title and description
  - [ ] Visual indication of selected stage
  - [ ] Stages: Dreaming, Planning, Preparing, Relocating, Settling

- [ ] **Task 6: Create Onboarding Page** (AC: 2, 4)
  - [ ] Create `app/[locale]/onboarding/page.tsx`
  - [ ] Check if user already completed onboarding
  - [ ] If complete: redirect to dashboard
  - [ ] If incomplete: show OnboardingWizard

- [ ] **Task 7: Implement Onboarding Completion Flow** (AC: 3, 4)
  - [ ] On wizard completion: call `completeOnboarding` mutation
  - [ ] Set `onboardingComplete: true`
  - [ ] Redirect to `/[locale]/dashboard`
  - [ ] Create initial corridor based on origin + destination

- [ ] **Task 8: Create Profile Settings Page** (AC: 5)
  - [ ] Create `app/[locale]/settings/page.tsx`
  - [ ] Display current profile values (origin, destination, stage, visa)
  - [ ] Edit mode for each field
  - [ ] Save button calls `updateProfile` mutation
  - [ ] Language already editable via LanguageSwitcher

- [ ] **Task 9: Add Onboarding Redirect Logic** (AC: 4)
  - [ ] In dashboard layout, check `onboardingComplete`
  - [ ] If false: redirect to `/[locale]/onboarding`
  - [ ] If true: render dashboard normally
  - [ ] Create `hooks/useRequireOnboarding.ts` for reuse

- [ ] **Task 10: Add Onboarding Translations** (AC: 7)
  - [ ] Add onboarding keys to all 5 locale files
  - [ ] Stage descriptions in all languages
  - [ ] Form labels and placeholders

---

## Dev Notes

### Extended Users Schema
[Source: architecture.md#database-schema]

```typescript
// convex/schema.ts
users: defineTable({
  clerkId: v.string(),
  email: v.string(),
  name: v.string(),
  language: v.union(
    v.literal("en"),
    v.literal("yo"),
    v.literal("hi"),
    v.literal("pt"),
    v.literal("tl")
  ),
  originCountry: v.optional(v.string()),
  destinationCountry: v.optional(v.string()),
  stage: v.optional(v.union(
    v.literal("dreaming"),
    v.literal("planning"),
    v.literal("preparing"),
    v.literal("relocating"),
    v.literal("settling")
  )),
  visaType: v.optional(v.string()),
  onboardingComplete: v.boolean(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_clerk_id", ["clerkId"])
  .index("by_email", ["email"]),
```

### User Mutations
[Source: architecture.md#api-specification]

```typescript
// convex/users.ts
export const getProfile = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return null;

    return await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();
  },
});

export const completeOnboarding = mutation({
  args: {
    originCountry: v.string(),
    destinationCountry: v.string(),
    stage: v.union(
      v.literal("dreaming"),
      v.literal("planning"),
      v.literal("preparing"),
      v.literal("relocating"),
      v.literal("settling")
    ),
    visaType: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthenticated");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    await ctx.db.patch(user._id, {
      ...args,
      onboardingComplete: true,
      updatedAt: Date.now(),
    });

    return user._id;
  },
});

export const updateProfile = mutation({
  args: {
    originCountry: v.optional(v.string()),
    destinationCountry: v.optional(v.string()),
    stage: v.optional(v.union(
      v.literal("dreaming"),
      v.literal("planning"),
      v.literal("preparing"),
      v.literal("relocating"),
      v.literal("settling")
    )),
    visaType: v.optional(v.string()),
    language: v.optional(v.union(
      v.literal("en"),
      v.literal("yo"),
      v.literal("hi"),
      v.literal("pt"),
      v.literal("tl")
    )),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthenticated");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerk_id", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    await ctx.db.patch(user._id, {
      ...args,
      updatedAt: Date.now(),
    });
  },
});
```

### Migration Stages
[Source: PRD#2.1-FR1]

```typescript
// lib/constants/stages.ts
export const migrationStages = [
  {
    id: "dreaming",
    labelKey: "onboarding.stages.dreaming.title",
    descriptionKey: "onboarding.stages.dreaming.description",
  },
  {
    id: "planning",
    labelKey: "onboarding.stages.planning.title",
    descriptionKey: "onboarding.stages.planning.description",
  },
  {
    id: "preparing",
    labelKey: "onboarding.stages.preparing.title",
    descriptionKey: "onboarding.stages.preparing.description",
  },
  {
    id: "relocating",
    labelKey: "onboarding.stages.relocating.title",
    descriptionKey: "onboarding.stages.relocating.description",
  },
  {
    id: "settling",
    labelKey: "onboarding.stages.settling.title",
    descriptionKey: "onboarding.stages.settling.description",
  },
] as const;
```

### Onboarding Wizard Pattern
[Source: architecture.md#components]

```typescript
// components/onboarding/OnboardingWizard.tsx
"use client";

import { useState } from "react";
import { useMutation } from "convex/react";
import { useRouter } from "next/navigation";
import { useLocale, useTranslations } from "next-intl";
import { api } from "@/convex/_generated/api";
import { CountrySelector } from "./CountrySelector";
import { StageSelector } from "./StageSelector";

type Step = "origin" | "destination" | "stage" | "visa";

export function OnboardingWizard() {
  const [step, setStep] = useState<Step>("origin");
  const [formData, setFormData] = useState({
    originCountry: "",
    destinationCountry: "",
    stage: "" as any,
    visaType: "",
  });

  const completeOnboarding = useMutation(api.users.completeOnboarding);
  const router = useRouter();
  const locale = useLocale();
  const t = useTranslations("onboarding");

  const handleComplete = async () => {
    await completeOnboarding({
      originCountry: formData.originCountry,
      destinationCountry: formData.destinationCountry,
      stage: formData.stage,
      visaType: formData.visaType || undefined,
    });
    router.push(`/${locale}/dashboard`);
  };

  // Step rendering logic...
  return (
    <div className="max-w-lg mx-auto">
      {/* Progress indicator */}
      {/* Step content */}
      {/* Navigation buttons */}
    </div>
  );
}
```

### Onboarding Redirect Hook
[Source: architecture.md#frontend-architecture]

```typescript
// hooks/useRequireOnboarding.ts
"use client";

import { useQuery } from "convex/react";
import { useRouter } from "next/navigation";
import { useLocale } from "next-intl";
import { useEffect } from "react";
import { api } from "@/convex/_generated/api";

export function useRequireOnboarding() {
  const profile = useQuery(api.users.getProfile);
  const router = useRouter();
  const locale = useLocale();

  useEffect(() => {
    if (profile === undefined) return; // Loading
    if (profile === null) return; // Not authenticated (handled elsewhere)
    if (!profile.onboardingComplete) {
      router.push(`/${locale}/onboarding`);
    }
  }, [profile, router, locale]);

  return { profile, isLoading: profile === undefined };
}
```

### Translation Keys for Onboarding
```json
// messages/en.json (add to existing)
{
  "onboarding": {
    "title": "Welcome to TRIBE",
    "subtitle": "Let's set up your migration journey",
    "steps": {
      "origin": "Where are you from?",
      "destination": "Where are you going?",
      "stage": "What stage are you at?",
      "visa": "What visa type? (optional)"
    },
    "stages": {
      "dreaming": {
        "title": "Dreaming",
        "description": "Exploring possibilities, researching destinations"
      },
      "planning": {
        "title": "Planning",
        "description": "Actively preparing documents, saving money"
      },
      "preparing": {
        "title": "Preparing",
        "description": "Visa approved, booking flights, packing"
      },
      "relocating": {
        "title": "Relocating",
        "description": "In transit or just arrived"
      },
      "settling": {
        "title": "Settling",
        "description": "Establishing life in new country"
      }
    },
    "buttons": {
      "next": "Next",
      "back": "Back",
      "skip": "Skip",
      "complete": "Complete Setup"
    }
  }
}
```

### File Structure
```
components/
└── onboarding/
    ├── OnboardingWizard.tsx
    ├── CountrySelector.tsx
    ├── StageSelector.tsx
    └── ProgressIndicator.tsx

hooks/
└── useRequireOnboarding.ts

lib/
└── constants/
    ├── stages.ts
    └── countries.ts           # Static country list or API integration

app/
└── [locale]/
    ├── onboarding/
    │   └── page.tsx           # Onboarding page
    ├── settings/
    │   └── page.tsx           # Profile settings
    └── (dashboard)/
        └── layout.tsx         # Add onboarding check
```

### Dependencies from Previous Stories
- Story 1.1: Convex schema, project setup
- Story 1.2: Clerk authentication, users table
- Story 1.3: Internationalization, translations
- Story 1.4: Layout components, navigation

---

## Testing

### Test Scenarios

1. **New User Onboarding**
   - [ ] New user signs up
   - [ ] Redirected to `/en/onboarding`
   - [ ] Complete all steps
   - [ ] Redirected to `/en/dashboard`
   - [ ] Check Convex: user has all fields populated

2. **Returning User**
   - [ ] User with `onboardingComplete: true` signs in
   - [ ] Goes directly to dashboard (no onboarding)

3. **Onboarding Flow**
   - [ ] Step 1: Select origin country
   - [ ] Step 2: Select destination country
   - [ ] Step 3: Select migration stage
   - [ ] Step 4: (Optional) Enter visa type
   - [ ] Progress indicator updates each step
   - [ ] Back button works correctly

4. **Profile Settings**
   - [ ] Navigate to settings page
   - [ ] Current values displayed
   - [ ] Edit origin country, save
   - [ ] Check Convex: value updated

5. **Localization**
   - [ ] Switch to Yoruba
   - [ ] Stage descriptions in Yoruba
   - [ ] Form labels in Yoruba

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-21 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*
