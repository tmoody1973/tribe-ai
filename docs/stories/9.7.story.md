# Story 9.7: Savings Goals - Goal Creation & Management

## Status

**Complete**

---

## Story

**As a** migrant saving for specific migration expenses,
**I want** to create and track savings goals with milestones,
**so that** I stay motivated and on track to meet my financial targets.

---

## Acceptance Criteria

1. Create savings goal with name, target amount, target date, and description
2. Link goal to specific budget and corridor
3. Set up to 5 milestones per goal (25%, 50%, 75%, 90%, 100%)
4. Track current saved amount with manual updates
5. Calculate progress percentage automatically
6. Display visual progress bar with milestone markers
7. Show days remaining until target date
8. Status management: active, completed, paused
9. Mark goal as completed when target reached
10. Celebrate milestone achievements with visual feedback

---

## Tasks / Subtasks

- [ ] **Task 1: Create Savings Goal Modal** (AC: 1, 2, 3)
  - [ ] Create `components/finances/SavingsGoalModal.tsx`
  - [ ] Form fields:
    - Goal name (text input, max 100 chars)
    - Description (textarea, optional, max 500 chars)
    - Target amount (number input, min 0, in destination currency)
    - Target date (date picker, optional)
    - Enable milestones checkbox
  - [ ] If milestones enabled, show milestone setup:
    - Default milestones: 25%, 50%, 75%, 100%
    - Custom milestone amounts option
    - Milestone labels (e.g., "First Quarter", "Halfway There")
  - [ ] Submit creates goal with status "active"
  - [ ] Validation: name required, target amount > 0

- [ ] **Task 2: Build Goal Card Component** (AC: 6, 7, 9, 10)
  - [ ] Create `components/finances/SavingsGoalCard.tsx`
  - [ ] Display goal name and description
  - [ ] Show current amount / target amount
  - [ ] Progress bar with percentage label
  - [ ] Milestone markers on progress bar
  - [ ] Days remaining badge (colored based on urgency)
  - [ ] Status badge (active, completed, paused)
  - [ ] Quick action buttons: Add Savings, Edit, Pause/Resume
  - [ ] Celebration animation when milestone achieved
  - [ ] Confetti effect when goal completed

- [ ] **Task 3: Implement Savings Update Flow** (AC: 4)
  - [ ] Create "Add Savings" modal
  - [ ] Input amount to add (number, min 0.01)
  - [ ] Optional note field (what was saved)
  - [ ] Update currentAmount in database
  - [ ] Recalculate progress percentage
  - [ ] Check if milestone or goal completed
  - [ ] Trigger celebration if milestone reached
  - [ ] Log savings update in activity history

- [ ] **Task 4: Create Convex Mutations** (AC: 4, 5, 8, 9)
  - [ ] Add to `convex/financial.ts`:
    ```typescript
    export const createSavingsGoal = mutation(...)
    export const updateGoalProgress = mutation(...)
    export const pauseGoal = mutation(...)
    export const resumeGoal = mutation(...)
    export const completeGoal = mutation(...)
    ```
  - [ ] `createSavingsGoal`: Insert into savingsGoals table
  - [ ] `updateGoalProgress`: Add to currentAmount, check milestones
  - [ ] `pauseGoal`: Set status to "paused"
  - [ ] `resumeGoal`: Set status back to "active"
  - [ ] `completeGoal`: Set status to "completed", set completedAt

- [ ] **Task 5: Build Savings Goals Dashboard Section** (AC: 6)
  - [ ] Add to finances page after budget overview
  - [ ] Display all active goals in grid layout (2-3 columns)
  - [ ] "Create New Goal" button
  - [ ] Filter tabs: All, Active, Completed, Paused
  - [ ] Sort options: Progress, Target Date, Amount
  - [ ] Empty state when no goals exist
  - [ ] Mobile-responsive layout (single column)

- [ ] **Task 6: Implement Milestone Logic** (AC: 3, 10)
  - [ ] Calculate which milestones are achieved
  - [ ] Update milestone.achieved and milestone.achievedAt
  - [ ] Trigger celebration when new milestone reached
  - [ ] Show toast notification: "ğŸ‰ Milestone reached: 50% saved!"
  - [ ] Highlight achieved milestones on progress bar
  - [ ] Store milestone achievement in activity log

---

## Technical Implementation Notes

### Savings Goal Data Model
```typescript
// Already in schema.ts
savingsGoals: defineTable({
  userId: v.id("users"),
  corridorId: v.id("corridors"),
  budgetId: v.id("financialBudgets"),
  name: v.string(),
  description: v.optional(v.string()),
  targetAmount: v.number(),
  currentAmount: v.number(),
  currency: v.string(),
  targetDate: v.optional(v.number()),
  milestones: v.optional(
    v.array(
      v.object({
        amount: v.number(),
        label: v.string(),
        achieved: v.boolean(),
        achievedAt: v.optional(v.number()),
      })
    )
  ),
  status: v.union(
    v.literal("active"),
    v.literal("completed"),
    v.literal("paused")
  ),
  completedAt: v.optional(v.number()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
```

### Default Milestones
```typescript
function createDefaultMilestones(targetAmount: number) {
  return [
    {
      amount: targetAmount * 0.25,
      label: "First Quarter",
      achieved: false,
    },
    {
      amount: targetAmount * 0.50,
      label: "Halfway There!",
      achieved: false,
    },
    {
      amount: targetAmount * 0.75,
      label: "Almost Done",
      achieved: false,
    },
    {
      amount: targetAmount * 1.0,
      label: "Goal Achieved! ğŸ‰",
      achieved: false,
    },
  ];
}
```

### Progress Calculation
```typescript
function calculateProgress(currentAmount: number, targetAmount: number) {
  const percentage = Math.min((currentAmount / targetAmount) * 100, 100);
  const achieved = currentAmount >= targetAmount;
  const daysRemaining = calculateDaysRemaining(targetDate);

  return {
    percentage: Math.round(percentage),
    achieved,
    daysRemaining,
    onTrack: isOnTrack(currentAmount, targetAmount, daysRemaining),
  };
}

function isOnTrack(current: number, target: number, daysLeft: number) {
  if (!daysLeft || daysLeft <= 0) return current >= target;

  const totalDays = Math.abs(Date.now() - targetDate) / (1000 * 60 * 60 * 24);
  const daysElapsed = totalDays - daysLeft;
  const expectedProgress = (daysElapsed / totalDays) * target;

  return current >= expectedProgress;
}
```

### Update Goal Progress Mutation
```typescript
export const updateGoalProgress = mutation({
  args: {
    goalId: v.id("savingsGoals"),
    amountToAdd: v.number(),
    note: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const goal = await ctx.db.get(args.goalId);
    if (!goal) throw new Error("Goal not found");

    const newAmount = goal.currentAmount + args.amountToAdd;
    const isCompleted = newAmount >= goal.targetAmount;

    // Check for newly achieved milestones
    const updatedMilestones = goal.milestones?.map(milestone => {
      if (!milestone.achieved && newAmount >= milestone.amount) {
        return {
          ...milestone,
          achieved: true,
          achievedAt: Date.now(),
        };
      }
      return milestone;
    });

    await ctx.db.patch(args.goalId, {
      currentAmount: newAmount,
      milestones: updatedMilestones,
      status: isCompleted ? "completed" : goal.status,
      completedAt: isCompleted ? Date.now() : undefined,
      updatedAt: Date.now(),
    });

    // Return newly achieved milestones for celebration
    return {
      newMilestones: updatedMilestones?.filter(
        (m, i) => m.achieved && !goal.milestones?.[i].achieved
      ),
      goalCompleted: isCompleted,
    };
  },
});
```

---

## Dependencies

- **Convex Tables**: savingsGoals (already exists in schema)
- **Related Stories**: 9.1 (Budget Creation), 9.8 (Progress Tracking), 9.9 (Notifications)

---

## UI/UX Design

### Goal Card Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ Emergency Fund              [â€¢â€¢â€¢]   â”‚
â”‚ Save for 3 months of living expenses   â”‚
â”‚                                         â”‚
â”‚ $2,500 / $5,000 CAD    (50%)          â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘               â”‚
â”‚ â–¼25%  â–¼50%  75%  100%                 â”‚
â”‚                                         â”‚
â”‚ â° 45 days remaining    [Active]       â”‚
â”‚ [+ Add Savings]  [Edit]  [Pause]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Progress Bar with Milestones
```css
.progress-bar {
  position: relative;
  height: 24px;
  background: #e5e7eb;
  border: 2px solid #000;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #2563eb);
  transition: width 0.5s ease;
}

.milestone-marker {
  position: absolute;
  top: -4px;
  width: 2px;
  height: 32px;
  background: #000;
}

.milestone-achieved {
  background: #10b981;
}
```

---

## Testing Strategy

1. **Goal Creation**:
   - Create goal with all fields â†’ Success
   - Create goal with only required fields â†’ Success
   - Create goal without name â†’ Error
   - Create goal with target amount = 0 â†’ Error

2. **Progress Updates**:
   - Add savings below milestone â†’ Progress updates
   - Add savings reaching milestone â†’ Celebration triggers
   - Add savings completing goal â†’ Status changes to completed
   - Add savings beyond target â†’ Capped at 100%

3. **Milestone Logic**:
   - Create goal with milestones â†’ 4 default milestones created
   - Reach 25% â†’ First milestone achieved
   - Reach 50% skipping 25% â†’ Both milestones achieved
   - Complete goal â†’ All milestones achieved

4. **Status Management**:
   - Pause active goal â†’ Status changes to paused
   - Resume paused goal â†’ Status changes to active
   - Cannot add savings to paused goal â†’ Error
   - Complete goal â†’ Status changes to completed

---

## Celebration Animations

### Milestone Reached
```typescript
// Toast notification
toast.success("ğŸ‰ Milestone reached: Halfway There!", {
  duration: 5000,
  icon: "ğŸ¯",
});

// Confetti animation (using canvas-confetti)
confetti({
  particleCount: 50,
  spread: 60,
  origin: { y: 0.6 },
});
```

### Goal Completed
```typescript
// Full-screen celebration
confetti({
  particleCount: 200,
  spread: 100,
  origin: { y: 0.5 },
  colors: ['#3b82f6', '#10b981', '#f59e0b'],
});

// Success modal
showModal({
  title: "ğŸ‰ Goal Achieved!",
  message: "Congratulations! You've saved $5,000 for Emergency Fund!",
  confetti: true,
});
```

---

## Accessibility

- Keyboard navigation for all goal actions
- Screen reader announcements for progress updates
- Color-blind friendly status indicators (not just color-coded)
- High contrast mode support for progress bars
- Aria labels for milestone markers

---

## Performance Considerations

- Debounce savings amount input (300ms)
- Limit to 10 active goals per user
- Cache progress calculations
- Optimize milestone achievement checks
- Lazy load goal cards (pagination after 10 goals)
