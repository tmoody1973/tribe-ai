# Story 10.2: CopilotRuntime ADK Integration

## Status

**Completed**

---

## Story

**As a** developer,
**I want** CopilotRuntime configured to use ADKAgent instead of GoogleGenerativeAIAdapter,
**so that** the frontend connects to the reliable ADK backend.

---

## Acceptance Criteria

1. Install `@ag-ui/adk` package in Next.js app
2. Update `/api/copilotkit/route.ts` to use `ExperimentalEmptyAdapter`
3. Configure `CopilotRuntime` with `agents: { tribe_agent: new ADKAgent({ url: ADK_AGENT_URL }) }`
4. Remove legacy `GoogleGenerativeAIAdapter` and `Gemini3Adapter` code
5. Environment variable `ADK_AGENT_URL` for agent endpoint (localhost:8000/agui for dev, production URL for prod)
6. CopilotProvider updated to specify `agent="tribe_agent"`
7. Chat messages stream correctly without ZodError
8. Error handling for agent connection failures with user-friendly message

---

## Tasks / Subtasks

- [x] **Task 1: Install ADK Package** (AC: 1)
  - [x] Run `npm install @ag-ui/client` in apps/web (Note: @ag-ui/adk doesn't exist; HttpAgent from @ag-ui/client is the correct pattern for remote AG-UI agents)
  - [x] Verify package added to package.json
  - [x] Check for peer dependency conflicts
  - [x] Update package-lock.json

- [x] **Task 2: Update CopilotKit Route** (AC: 2, 3, 5)
  - [x] Open `apps/web/app/api/copilotkit/route.ts`
  - [x] Import `ExperimentalEmptyAdapter` from @copilotkit/runtime
  - [x] Import `HttpAgent` from @ag-ui/client (used instead of ADKAgent)
  - [x] Replace `GoogleGenerativeAIAdapter` with `ExperimentalEmptyAdapter`
  - [x] Create HttpAgent instance with URL from environment
  - [x] Configure CopilotRuntime with agents object
  - [x] Add ADK_AGENT_URL to .env.local and .env.example

- [x] **Task 3: Remove Legacy Adapters** (AC: 4)
  - [x] Delete `apps/web/lib/adapters/gemini3-adapter.ts`
  - [x] Remove GoogleGenerativeAIAdapter import
  - [x] Remove housing/visa/live search action definitions (moved to ADK agent)
  - [x] Clean up unused imports (fs, path, ConvexHttpClient for actions)
  - [x] Keep only essential route handler code

- [x] **Task 4: Update CopilotProvider** (AC: 6)
  - [x] Find CopilotProvider usage in layout or page components
  - [x] Add `agent="tribe_agent"` prop to CopilotKit component
  - [x] Verify provider wraps chat components correctly
  - [x] Build passes without errors

- [ ] **Task 5: Verify Streaming** (AC: 7) - Requires ADK agent running
  - [ ] Send test message through chat
  - [ ] Verify response streams character by character
  - [ ] Check browser console for ZodError (should be none)
  - [ ] Test multiple consecutive messages
  - [ ] Test long responses (>500 tokens)

- [x] **Task 6: Add Error Handling** (AC: 8)
  - [x] Wrap request handling in try-catch
  - [x] Create user-friendly error messages for agent unreachable
  - [x] Include hint about ADK agent URL in error response
  - [x] Log errors to console for debugging

---

## Technical Implementation Notes

### Actual Implementation (Updated Route Handler)
```typescript
// apps/web/app/api/copilotkit/route.ts
// NOTE: @ag-ui/adk package doesn't exist. The correct pattern for remote
// AG-UI agents (including ADK) is HttpAgent from @ag-ui/client

import {
  CopilotRuntime,
  copilotRuntimeNextJSAppRouterEndpoint,
  ExperimentalEmptyAdapter,
} from "@copilotkit/runtime";
import { HttpAgent } from "@ag-ui/client";

// ADK Agent URL - defaults to local development server
const ADK_AGENT_URL = process.env.ADK_AGENT_URL || "http://localhost:8000/agui";

// Create HttpAgent to connect to ADK backend via AG-UI protocol
const tribeAgent = new HttpAgent({
  url: ADK_AGENT_URL,
});

// CopilotRuntime with ADK agent
const runtime = new CopilotRuntime({
  agents: {
    tribe_agent: tribeAgent,
  },
});

// Empty adapter since LLM is handled by ADK agent
const serviceAdapter = new ExperimentalEmptyAdapter();

export const POST = async (req: Request) => {
  try {
    console.log("CopilotKit POST request received");

    const { handleRequest } = copilotRuntimeNextJSAppRouterEndpoint({
      runtime,
      serviceAdapter,
      endpoint: "/api/copilotkit",
    });

    const response = await handleRequest(req);
    console.log("CopilotKit response status:", response.status);
    return response;
  } catch (error) {
    console.error("CopilotKit POST error:", error);

    const errorMessage = error instanceof Error ? error.message : String(error);
    const errorStack = error instanceof Error ? error.stack : undefined;

    return new Response(
      JSON.stringify({
        error: errorMessage,
        stack: process.env.NODE_ENV === "development" ? errorStack : undefined,
        hint: "Check that the ADK agent server is running at " + ADK_AGENT_URL,
      }),
      {
        status: 500,
        headers: { "Content-Type": "application/json" },
      }
    );
  }
};
```

### CopilotProvider Update
```typescript
// apps/web/app/(dashboard)/layout.tsx or providers
import { CopilotKit } from "@copilotkit/react-core";
import { CopilotSidebar } from "@copilotkit/react-ui";

export function ChatProvider({ children }: { children: React.ReactNode }) {
  return (
    <CopilotKit
      runtimeUrl="/api/copilotkit"
      agent="tribe_agent"
    >
      {children}
    </CopilotKit>
  );
}
```

### Environment Variables
```bash
# .env.local (development)
ADK_AGENT_URL=http://localhost:8000/agui

# .env.production
ADK_AGENT_URL=https://tribe-agent-xxxxx.run.app/agui
```

### Files to Delete
```
apps/web/lib/adapters/gemini3-adapter.ts  # Custom Gemini adapter (deprecated)
```

### Files to Modify
```
apps/web/app/api/copilotkit/route.ts      # Main changes
apps/web/package.json                      # Add @ag-ui/adk
apps/web/.env.local                        # Add ADK_AGENT_URL
```

---

## Dependencies

- **Upstream**: Story 10.1 (ADK Agent Backend Setup)
- **Downstream**: Stories 10.6, 10.7 (need working runtime)
- **Packages**: @ag-ui/adk, @copilotkit/runtime

---

## Testing Strategy

### Test Cases

1. **Package Installation**:
   - @ag-ui/adk installed successfully
   - No peer dependency conflicts
   - Build passes with new package

2. **Route Handler**:
   - POST /api/copilotkit returns 200 for valid request
   - Error response for agent unreachable (503)
   - Timeout handled gracefully

3. **Chat Streaming**:
   - Messages stream in real-time
   - No ZodError in console
   - Response completes correctly

4. **Error Scenarios**:
   - Agent down: Shows friendly error
   - Network timeout: Shows retry option
   - Invalid response: Graceful degradation

5. **Integration**:
   - Chat UI connects to new runtime
   - Multiple users can chat simultaneously
   - No memory leaks

---

## Migration Notes

### Before (Legacy)
```typescript
import { GoogleGenerativeAIAdapter } from "@copilotkit/runtime";

const serviceAdapter = new GoogleGenerativeAIAdapter({
  model: "gemini-1.5-flash",
});

const runtime = new CopilotRuntime({
  actions: [
    { name: "searchHousingResources", ... },
    { name: "searchLiveData", ... },
    { name: "searchVisaOptions", ... },
  ],
});
```

### After (ADK via HttpAgent)
```typescript
import { ExperimentalEmptyAdapter } from "@copilotkit/runtime";
import { HttpAgent } from "@ag-ui/client";

const serviceAdapter = new ExperimentalEmptyAdapter();
const tribeAgent = new HttpAgent({ url: process.env.ADK_AGENT_URL || "http://localhost:8000/agui" });

const runtime = new CopilotRuntime({
  agents: {
    tribe_agent: tribeAgent,
  },
});
```

Key differences:
1. LLM processing moved from Next.js to Python ADK agent
2. Actions defined in ADK agent, not CopilotRuntime
3. ExperimentalEmptyAdapter signals "no local LLM"
4. Agent selected by name in CopilotKit provider
