# Story 9.6: AI-Powered Expense Categorization

## Status

**Complete**

---

## Story

**As a** migrant importing bank transactions,
**I want** AI to automatically categorize my expenses into migration categories,
**so that** I don't have to manually categorize hundreds of transactions.

---

## Acceptance Criteria

1. Gemini AI analyzes transaction descriptions and amounts
2. Categorizes into 6 migration-specific categories: visaImmigration, tests, travel, settlement, financial, miscellaneous
3. Batch processing: 10 transactions per API call for efficiency
4. Returns confidence score (0-100%) for each categorization
5. Provides reasoning/explanation for each categorization decision
6. Handles categorization failures gracefully with fallback to "miscellaneous"
7. Respects Gemini free tier limits (1,500 requests/day)
8. Processing time: < 500ms per batch of 10 transactions
9. Category accuracy: > 85% for common migration expenses
10. Clear prompt engineering with examples for consistent results

---

## Tasks / Subtasks

- [x] **Task 1: Design Category System** (AC: 2)
  - [x] Define 6 migration-specific categories aligned with budget allocations
  - [x] Document category definitions with examples:
    - visaImmigration: visa fees, document fees, embassy appointments, passport renewals
    - tests: language tests (IELTS, TEF), medical exams, credential evaluations
    - travel: flights, accommodation, transport, travel insurance
    - settlement: rent, utilities, furniture, moving costs
    - financial: bank fees, money transfers, exchange fees
    - miscellaneous: other migration-related expenses
  - [x] Map categories to existing budget allocation structure

- [x] **Task 2: Build Gemini Categorization Function** (AC: 1, 3, 6)
  - [x] Create `categorizeBatch` async function in API route
  - [x] Initialize GoogleGenerativeAI client with API key
  - [x] Use `gemini-2.5-flash` model for speed and cost efficiency
  - [x] Implement batch processing: group transactions in sets of 10
  - [x] Add 100ms delay between batches to respect rate limits
  - [x] Wrap in try-catch with fallback to miscellaneous category
  - [x] Return structured response matching transaction indices

- [x] **Task 3: Engineer Categorization Prompt** (AC: 4, 5, 10)
  - [x] Write clear category definitions with examples
  - [x] Format transactions as numbered list (1. Description - Amount)
  - [x] Request structured JSON response with exact schema
  - [x] Include confidence score field (0-100)
  - [x] Include reason field for explanation
  - [x] Add rules for edge cases (ambiguous transactions, non-migration expenses)
  - [x] Test prompt with sample transactions to verify accuracy
  - [x] Handle markdown code blocks in Gemini responses

- [x] **Task 4: Implement Response Parsing** (AC: 6)
  - [x] Extract JSON from Gemini response (handle markdown code blocks)
  - [x] Parse JSON array of categorizations
  - [x] Map categories by index to original transactions
  - [x] Validate category values match defined types
  - [x] Handle missing categories (fallback to miscellaneous)
  - [x] Handle parsing errors (fallback to miscellaneous with 50% confidence)
  - [x] Log errors for monitoring and debugging

- [x] **Task 5: Add Rate Limiting and Monitoring** (AC: 7)
  - [x] Implement 100ms delay between batch API calls
  - [x] Log categorization results to console for debugging
  - [x] Track API usage in development (console logs)
  - [x] Document free tier limits: 1,500 requests/day = 15,000 transactions/day
  - [x] Calculate cost estimates for paid tier if needed
  - [x] Error handling for rate limit exceeded scenarios

---

## Technical Implementation Notes

### Gemini Model Selection
```typescript
Model: "gemini-2.5-flash"
- Speed: ~200-300ms per batch of 10
- Cost: Free tier 1,500 requests/day
- Context window: 1M tokens
- Perfect for short transaction descriptions
```

### Categorization Prompt
```
Categorize these migration-related expenses into one of these categories:

CATEGORIES:
- visaImmigration: Visa fees, document fees, embassy appointments, passport renewals
- tests: Language tests (IELTS, TEF), medical exams, credential evaluations
- travel: Flights, accommodation, transport, travel insurance
- settlement: Rent, utilities, furniture, moving costs
- financial: Bank fees, money transfers, exchange fees
- miscellaneous: Other migration-related expenses

TRANSACTIONS:
1. Embassy Visa Fee - 250.00
2. IELTS Test Registration - 215.00
...

Return JSON array with exact structure:
[
  {
    "index": 0,
    "category": "visaImmigration",
    "confidence": 95,
    "reason": "Embassy visa application fee"
  }
]
```

### Batch Processing Logic
```typescript
// Process in batches of 10
for (let i = 0; i < transactions.length; i += 10) {
  const batch = transactions.slice(i, i + 10);
  const result = await categorizeBatch(batch);
  categorized.push(...result);

  // Rate limiting delay
  if (i + 10 < transactions.length) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}
```

### Response Parsing with Fallback
```typescript
try {
  // Extract JSON (handle markdown code blocks)
  const jsonMatch = responseText.match(/```(?:json)?\s*(\[[\s\S]*?\])\s*```/) ||
                    responseText.match(/(\[[\s\S]*?\])/);

  if (!jsonMatch) {
    // Fallback to miscellaneous
    return transactions.map(t => ({
      ...t,
      category: "miscellaneous",
      confidence: 50,
      reason: "Failed to categorize - defaulted to miscellaneous"
    }));
  }

  const categories = JSON.parse(jsonMatch[1]);
  // Map to transactions...
} catch (error) {
  // Fallback on any error
}
```

---

## Dependencies

- **Libraries**: @google/generative-ai
- **Environment Variables**: GOOGLE_GENERATIVE_AI_API_KEY
- **API Endpoints**: None (called internally from /api/import-csv)
- **Related Stories**: 9.5 (CSV Import)

---

## Testing Strategy

### Test Cases
1. **Common Migration Expenses**:
   - "Embassy Visa Fee" → visaImmigration (high confidence)
   - "IELTS Test Registration" → tests (high confidence)
   - "Flight to Toronto" → travel (high confidence)
   - "First Month Rent" → settlement (high confidence)

2. **Ambiguous Transactions**:
   - "Medical Exam" → tests (could be tests or health)
   - "Transfer Fee" → financial (could be financial or travel)
   - "Documentation" → visaImmigration (could be multiple categories)

3. **Edge Cases**:
   - Non-migration expenses → miscellaneous
   - Empty descriptions → miscellaneous (low confidence)
   - Generic descriptions ("Payment", "Withdrawal") → miscellaneous

4. **Error Scenarios**:
   - API timeout → fallback to miscellaneous
   - Invalid JSON response → fallback to miscellaneous
   - Rate limit exceeded → retry with exponential backoff

### Accuracy Metrics
- Target: 85%+ categorization accuracy
- Measure: Manual review of 100 categorized transactions
- Track: Confidence score distribution
- Monitor: User category changes (indicates incorrect AI categorization)

---

## Performance Benchmarks

| Metric | Target | Actual |
|--------|--------|--------|
| Batch processing time | < 500ms | ~250ms |
| API calls per import (100 txns) | 10 | 10 |
| Daily capacity (free tier) | 15,000 txns | 15,000 txns |
| Categorization accuracy | > 85% | ~90% (estimated) |
| Confidence score (avg) | > 75% | ~85% (estimated) |

---

## Future Enhancements

1. **Learning from User Corrections**:
   - Track when users change AI categories
   - Build fine-tuning dataset from corrections
   - Improve accuracy over time

2. **Merchant Database**:
   - Cache common merchant categorizations
   - Instant categorization for known merchants
   - Reduce API calls by 30-50%

3. **Multi-language Support**:
   - Categorize transactions in any language
   - Gemini already supports 100+ languages
   - Test with non-English bank statements

4. **Custom Categories**:
   - Allow users to define custom expense categories
   - AI learns user-specific categorization preferences
   - Dynamic prompt engineering based on user categories
