# Story 10.1: ADK Agent Backend Setup

## Status

**Draft**

---

## Story

**As a** developer,
**I want** a Python/FastAPI backend serving the Google ADK agent via AG-UI protocol,
**so that** chat messages are reliably processed without ZodError parsing issues.

---

## Acceptance Criteria

1. Create `agents/tribe_agent/` directory with Python project structure (pyproject.toml, requirements.txt)
2. Install dependencies: `google-adk`, `ag-ui-adk`, `fastapi`, `uvicorn`, `httpx`
3. Create ADK agent with `gemini-2.5-flash` model (stable, no thinking mode issues)
4. Agent system prompt includes TRIBE context: corridor awareness, migration expertise, multi-language support
5. FastAPI endpoint `/agui` serves AG-UI protocol stream
6. Health check endpoint `/health` for monitoring
7. Environment variables: `GEMINI_API_KEY`, `CONVEX_SITE_URL` (for data access)
8. Local development: `uvicorn server:app --port 8000 --reload`
9. Agent responds to basic queries within 2 seconds (NFR2)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Python Project Structure** (AC: 1, 2)
  - [ ] Create `agents/tribe_agent/` directory
  - [ ] Create `pyproject.toml` with project metadata and dependencies
  - [ ] Create `requirements.txt` with pinned versions:
    - google-adk>=0.1.0
    - ag-ui-adk>=0.1.0
    - fastapi>=0.100.0
    - uvicorn[standard]>=0.23.0
    - httpx>=0.24.0
    - python-dotenv>=1.0.0
  - [ ] Create `.env.example` with required environment variables
  - [ ] Add `.gitignore` for Python artifacts (__pycache__, .venv, etc.)

- [ ] **Task 2: Create ADK Agent Definition** (AC: 3, 4)
  - [ ] Create `agents/tribe_agent/agent.py`
  - [ ] Import Google ADK: `from google.adk import Agent`
  - [ ] Configure model: `gemini-2.5-flash`
  - [ ] Write comprehensive system prompt:
    - TRIBE platform identity
    - Migration intelligence expertise
    - Corridor-aware context handling
    - Multi-language support (en, yo, hi, pt, tl)
    - Tool usage instructions
  - [ ] Export agent instance for server import

- [ ] **Task 3: Create FastAPI Server** (AC: 5, 6, 7, 8)
  - [ ] Create `agents/tribe_agent/server.py`
  - [ ] Import FastAPI and ADKRunner from ag-ui-adk
  - [ ] Mount AG-UI endpoint at `/agui`
  - [ ] Add health check endpoint at `/health`
  - [ ] Load environment variables with python-dotenv
  - [ ] Add CORS middleware for Next.js frontend
  - [ ] Configure uvicorn with reload for development
  - [ ] Add startup/shutdown event handlers for logging

- [ ] **Task 4: Add Development Scripts** (AC: 8)
  - [ ] Create `agents/tribe_agent/run.sh` for local development
  - [ ] Create `agents/tribe_agent/test_agent.py` for quick testing
  - [ ] Add instructions to README.md

- [ ] **Task 5: Performance Verification** (AC: 9)
  - [ ] Test basic query response time
  - [ ] Ensure cold start < 5s
  - [ ] Ensure warm response < 2s
  - [ ] Document baseline performance metrics

---

## Technical Implementation Notes

### Project Structure
```
agents/tribe_agent/
├── agent.py           # ADK agent definition
├── server.py          # FastAPI server with AG-UI
├── tools/             # Tool implementations (Story 10.3-10.5)
│   ├── __init__.py
│   ├── housing.py
│   ├── live_search.py
│   └── visa.py
├── requirements.txt
├── pyproject.toml
├── Dockerfile
├── .env.example
└── README.md
```

### Agent System Prompt
```python
TRIBE_SYSTEM_PROMPT = """You are TRIBE, a culturally-aware migration intelligence assistant.

IDENTITY:
- You help migrants and refugees navigate relocation pathways
- You aggregate diaspora community knowledge
- You provide accurate, up-to-date migration information

CAPABILITIES:
1. Search housing resources by country/continent
2. Find visa requirements and pathways
3. Search live web data for current information
4. Provide cultural bridge insights

CONTEXT AWARENESS:
- User's corridor (origin → destination) is provided in each request
- Personalize responses based on their migration stage
- Respect language preferences

GUIDELINES:
- Always cite sources for factual claims
- Flag outdated or conflicting information
- Be culturally sensitive and empathetic
- Use simple, clear language
- Provide actionable next steps

LANGUAGES SUPPORTED:
- English (en)
- Yoruba (yo)
- Hindi (hi)
- Portuguese (pt)
- Tagalog (tl)

Respond in the user's preferred language when specified."""
```

### FastAPI Server Configuration
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from google.adk.runners import FastAPIRunner
from agent import tribe_agent

app = FastAPI(title="TRIBE ADK Agent")

# CORS for Next.js frontend
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "https://*.vercel.app"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Mount AG-UI endpoint
runner = FastAPIRunner(agent=tribe_agent)
app.include_router(runner.router, prefix="/agui")

@app.get("/health")
async def health():
    return {"status": "ok", "agent": "tribe_agent", "model": "gemini-2.5-flash"}
```

### Environment Variables
```bash
# .env.example
GEMINI_API_KEY=your_gemini_api_key_here
CONVEX_SITE_URL=https://your-convex-deployment.convex.site
ENVIRONMENT=development
```

---

## Dependencies

- **Upstream**: None (foundational story)
- **Downstream**: Stories 10.2, 10.3, 10.4, 10.5, 10.11
- **External APIs**: Google Gemini API

---

## Testing Strategy

### Test Cases

1. **Agent Initialization**:
   - Agent loads without errors
   - Model set to gemini-2.5-flash
   - System prompt properly configured

2. **Health Check**:
   - GET /health returns 200
   - Response includes agent name and model

3. **AG-UI Endpoint**:
   - POST /agui accepts AG-UI protocol messages
   - Returns streaming SSE response
   - Handles malformed requests gracefully

4. **Basic Conversation**:
   - Simple greeting gets response
   - Migration-related question gets helpful answer
   - Response streams correctly

5. **Performance**:
   - Cold start < 5 seconds
   - Response time < 2 seconds for simple queries
   - No memory leaks over 100 requests

---

## Development Notes

### Local Setup
```bash
cd agents/tribe_agent
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
# Edit .env with your API keys
uvicorn server:app --port 8000 --reload
```

### Quick Test
```bash
curl http://localhost:8000/health
# Expected: {"status":"ok","agent":"tribe_agent","model":"gemini-2.5-flash"}
```
