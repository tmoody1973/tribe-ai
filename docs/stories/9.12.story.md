# Story 9.12: Enhanced Audio Briefings - Multi-language Support

## Status

**Complete**

---

## Story

**As a** migrant more comfortable in my native language,
**I want** audio briefings generated in my preferred language with native accents,
**so that** I can fully understand and engage with my migration information.

---

## Acceptance Criteria

1. Support 220+ languages via Google Cloud Text-to-Speech
2. Language selection in user preferences with search/filter
3. Auto-detect recommended language from user's origin country
4. Multiple voice options per language (male, female, neutral)
5. Region-specific accents (e.g., Canadian French vs. European French)
6. Script translation using Claude with context preservation
7. Cultural adaptation of idioms and expressions
8. Language-specific formatting (dates, currency, measurements)
9. Preview sample briefing before confirming language choice
10. Switch language anytime without losing previous briefings

---

## Tasks / Subtasks

- [ ] **Task 1: Build Language Selection UI** (AC: 2, 3)
  - [ ] Create language selection component in settings
  - [ ] Fetch available languages from Google TTS API
  - [ ] Organize languages by: Popular (top 10), Regional, All (A-Z)
  - [ ] Search/filter functionality
  - [ ] Display language with native name and English name:
    - "FranÃ§ais (French)"
    - "EspaÃ±ol (Spanish)"
    - "à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)"
    - "YorÃ¹bÃ¡ (Yoruba)"
  - [ ] Auto-recommend based on origin country
  - [ ] Show number of available voices per language

- [ ] **Task 2: Implement Voice Selection** (AC: 4, 5)
  - [ ] Query available voices for selected language
  - [ ] Display voice options:
    - Name (e.g., "en-US-Neural2-A")
    - Gender (Male, Female, Neutral)
    - Accent/Region (US, UK, Canada, Australia, India, etc.)
    - Sample audio player
  - [ ] "Play Sample" button for each voice
  - [ ] Remember user's preferred voice per language
  - [ ] Fallback to default voice if preference unavailable

- [ ] **Task 3: Add Script Translation** (AC: 6, 7)
  - [ ] Create `translateBriefingScript` function
  - [ ] Use Claude for translation (better context awareness than Google Translate)
  - [ ] System prompt for translation:
    ```
    Translate this migration briefing to {targetLanguage}.
    Preserve:
    - Personal tone and motivation
    - Technical terms (visa types, immigration processes)
    - Specific data points (dates, amounts, percentages)

    Adapt:
    - Idioms and expressions to target culture
    - Greeting style to cultural norms
    - Motivational language to resonate with culture
    ```
  - [ ] Maintain section structure after translation
  - [ ] Preserve placeholders: {name}, {date}, {amount}
  - [ ] Fallback to Google Translate if Claude unavailable

- [ ] **Task 4: Implement Cultural Adaptation** (AC: 7, 8)
  - [ ] Create `adaptCulturalContext` function
  - [ ] Adapt greetings:
    - English: "Good morning!"
    - French: "Bonjour!"
    - Hindi: "à¤¨à¤®à¤¸à¥à¤¤à¥‡ (Namaste)!"
    - Yoruba: "áº¸ kÃ¡Ã rá»Ì€!"
  - [ ] Format dates by locale:
    - US: 1/15/2025
    - EU: 15/01/2025
    - ISO: 2025-01-15
  - [ ] Format currency by locale:
    - US: $1,234.56
    - EU: 1.234,56 â‚¬
    - India: â‚¹1,234.56
  - [ ] Adapt measurements:
    - Metric: kilometers, celsius
    - Imperial: miles, fahrenheit
  - [ ] Adapt idioms:
    - "Break a leg" â†’ Equivalent cultural expression

- [ ] **Task 5: Create Language Preview Feature** (AC: 9)
  - [ ] Generate sample briefing in selected language
  - [ ] Use template script with placeholder data
  - [ ] Synthesize ~30 second preview audio
  - [ ] Display transcript with sample
  - [ ] "Try this voice" button in settings
  - [ ] Allow user to compare multiple languages/voices

- [ ] **Task 6: Implement Language Switching** (AC: 10)
  - [ ] Store language preference in user table
  - [ ] Apply new language to future briefings only
  - [ ] Keep historical briefings in original language
  - [ ] Show language indicator on briefing cards
  - [ ] Allow re-generation of old briefing in new language (future enhancement)
  - [ ] Transition message: "Future briefings will be in {language}"

- [ ] **Task 7: Add Language-Specific Optimizations**
  - [ ] Adjust speech rate by language:
    - Slower for tonal languages (Chinese, Vietnamese)
    - Normal for Romance languages
    - Slightly faster for Germanic languages
  - [ ] Adjust audio encoding for language characteristics
  - [ ] Use SSML tags for better pronunciation of names and places
  - [ ] Test and tune voice quality per language

---

## Technical Implementation Notes

### Language Data Structure
```typescript
interface Language {
  code: string;           // "en-US", "fr-CA", "hi-IN"
  name: string;           // "English"
  nativeName: string;     // "English" (same for English)
  region: string;         // "United States", "Canada", "India"
  voices: Voice[];
  defaultVoice: string;
}

interface Voice {
  name: string;                    // "en-US-Neural2-A"
  languageCode: string;            // "en-US"
  gender: "MALE" | "FEMALE" | "NEUTRAL";
  naturalSampleRateHertz: number;
  region?: string;                 // "US", "UK", "Australia"
}

// Store in user preferences
userPreferences: {
  language: "en-US",
  voice: "en-US-Neural2-A",
  speechRate: 1.0,
}
```

### Google TTS Language Query
```typescript
async function getAvailableLanguages() {
  const [result] = await ttsClient.listVoices();

  const languageMap = new Map<string, Language>();

  result.voices?.forEach(voice => {
    const langCode = voice.languageCodes?.[0] || "";
    const [lang, region] = langCode.split("-");

    if (!languageMap.has(langCode)) {
      languageMap.set(langCode, {
        code: langCode,
        name: getLanguageName(lang),
        nativeName: getLanguageNativeName(lang),
        region: getRegionName(region),
        voices: [],
        defaultVoice: voice.name || "",
      });
    }

    languageMap.get(langCode)!.voices.push({
      name: voice.name || "",
      languageCode: langCode,
      gender: voice.ssmlGender || "NEUTRAL",
      naturalSampleRateHertz: voice.naturalSampleRateHertz || 24000,
      region: region,
    });
  });

  return Array.from(languageMap.values());
}

// Popular languages to highlight
const POPULAR_LANGUAGES = [
  "en-US",  // English (US)
  "en-GB",  // English (UK)
  "fr-FR",  // French
  "fr-CA",  // French (Canadian)
  "es-ES",  // Spanish (Spain)
  "es-MX",  // Spanish (Mexico)
  "hi-IN",  // Hindi
  "pt-BR",  // Portuguese (Brazil)
  "yo-NG",  // Yoruba (Nigeria)
  "fil-PH", // Filipino (Philippines)
];
```

### Script Translation with Claude
```typescript
async function translateBriefingScript(
  script: string,
  targetLanguage: string,
  context: {
    userName: string;
    origin: string;
    destination: string;
  }
) {
  const prompt = `Translate this migration briefing from English to ${targetLanguage}.

CONTEXT:
- Speaker: Migration assistant helping ${context.userName}
- Migration: ${context.origin} â†’ ${context.destination}
- Tone: Friendly, motivational, supportive

TRANSLATION GUIDELINES:
1. Preserve personal tone and warmth
2. Keep technical terms in original language if commonly used
3. Adapt idioms and expressions to target culture
4. Maintain section structure (denoted by headings)
5. Format dates, currency, measurements per locale
6. Adapt greetings to cultural norms
7. Keep placeholder variables: {name}, {date}, {amount}

ORIGINAL SCRIPT:
${script}

TRANSLATED SCRIPT:`;

  const response = await anthropic.messages.create({
    model: "claude-3-5-sonnet-20241022",
    max_tokens: 2000,
    messages: [{ role: "user", content: prompt }],
  });

  return response.content[0].text;
}
```

### Cultural Adaptation Engine
```typescript
const culturalAdaptations: Record<string, CulturalRules> = {
  "en-US": {
    greeting: "Good morning",
    dateFormat: "MM/DD/YYYY",
    currencyFormat: "$1,234.56",
    measurements: "imperial",
    idioms: {
      "keep going": "hang in there",
      "great job": "way to go",
    },
  },
  "fr-CA": {
    greeting: "Bonjour",
    dateFormat: "DD/MM/YYYY",
    currencyFormat: "1 234,56 $",
    measurements: "metric",
    idioms: {
      "keep going": "continue comme Ã§a",
      "great job": "excellent travail",
    },
  },
  "hi-IN": {
    greeting: "à¤¨à¤®à¤¸à¥à¤¤à¥‡ (Namaste)",
    dateFormat: "DD/MM/YYYY",
    currencyFormat: "â‚¹1,234.56",
    measurements: "metric",
    idioms: {
      "keep going": "à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚ (jaari rakhen)",
      "great job": "à¤¬à¤¹à¥à¤¤ à¤¬à¤¢à¤¼à¤¿à¤¯à¤¾ (bahut badhiya)",
    },
  },
  "yo-NG": {
    greeting: "áº¸ kÃ¡Ã rá»Ì€",
    dateFormat: "DD/MM/YYYY",
    currencyFormat: "â‚¦1,234.56",
    measurements: "metric",
    idioms: {
      "keep going": "táº¹Ì€sÃ­wÃ¡jÃº",
      "great job": "o á¹£e daadaa",
    },
  },
};

function adaptCulturalContext(script: string, languageCode: string): string {
  const rules = culturalAdaptations[languageCode];
  if (!rules) return script;

  let adapted = script;

  // Replace idioms
  Object.keys(rules.idioms).forEach(english => {
    const translated = rules.idioms[english];
    adapted = adapted.replace(new RegExp(english, "gi"), translated);
  });

  // Format dates
  adapted = adapted.replace(/\d{1,2}\/\d{1,2}\/\d{4}/g, date => {
    return formatDate(date, rules.dateFormat);
  });

  // Format currency
  adapted = adapted.replace(/\$[\d,]+\.\d{2}/g, amount => {
    return formatCurrency(amount, rules.currencyFormat);
  });

  return adapted;
}
```

### TTS with Language-Specific Settings
```typescript
async function synthesizeSpeechMultilingual(
  text: string,
  languageCode: string,
  voiceName: string
) {
  // Language-specific speech rate adjustments
  const speechRates: Record<string, number> = {
    "zh-CN": 0.9,  // Slower for Mandarin (tonal)
    "ja-JP": 0.9,  // Slower for Japanese
    "vi-VN": 0.9,  // Slower for Vietnamese (tonal)
    "en-US": 1.0,  // Normal for English
    "es-ES": 1.1,  // Slightly faster for Spanish
  };

  const speechRate = speechRates[languageCode] || 1.0;

  const [response] = await ttsClient.synthesizeSpeech({
    input: { text },
    voice: {
      languageCode,
      name: voiceName,
    },
    audioConfig: {
      audioEncoding: "MP3",
      speakingRate: speechRate,
      pitch: 0.0,
      effectsProfileId: ["small-bluetooth-speaker-class-device"],
    },
  });

  return response.audioContent;
}
```

---

## Dependencies

- **APIs**: Google Cloud Text-to-Speech, Claude (translation)
- **Libraries**: @google-cloud/text-to-speech, @anthropic-ai/sdk
- **Convex Tables**: users (add language preferences)
- **Related Stories**: 9.10 (Daily Briefings), 9.11 (Weekly Briefings)

---

## UI Components

### Language Selection Interface
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Language & Voice Preferences             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Briefing Language                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ” Search languages...                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ Popular Languages:                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ English (US)â”‚ â”‚ FranÃ§ais(CA)â”‚           â”‚
â”‚ â”‚ 8 voices    â”‚ â”‚ 6 voices    â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                             â”‚
â”‚ Selected: English (United States)           â”‚
â”‚                                             â”‚
â”‚ Voice Options:                              â”‚
â”‚ â—‹ en-US-Neural2-A (Female, US) [â–¶ Sample] â”‚
â”‚ â—‹ en-US-Neural2-C (Male, US)   [â–¶ Sample] â”‚
â”‚ â— en-US-Neural2-D (Male, US)   [â–¶ Sample] â”‚
â”‚                                             â”‚
â”‚ [Generate Preview Briefing]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Supported Languages (Popular Examples)

### Top 10 Most Requested
1. **English**: en-US, en-GB, en-CA, en-AU, en-IN
2. **French**: fr-FR, fr-CA
3. **Spanish**: es-ES, es-MX, es-US
4. **Portuguese**: pt-BR, pt-PT
5. **Hindi**: hi-IN
6. **Mandarin**: zh-CN, zh-TW
7. **Arabic**: ar-XA (Standard), ar-EG
8. **Filipino**: fil-PH
9. **Yoruba**: yo-NG
10. **Igbo**: ig-NG (if available)

### Migration Corridor Languages
- **Africa**: Yoruba, Igbo, Hausa, Swahili, Amharic
- **Asia**: Hindi, Mandarin, Tagalog, Bengali, Vietnamese
- **Latin America**: Spanish, Portuguese
- **Europe**: French, German, Italian, Polish, Romanian
- **Middle East**: Arabic, Farsi, Turkish, Hebrew

---

## Testing Strategy

1. **Language Coverage**:
   - Test top 10 languages â†’ All working
   - Test region-specific accents â†’ Correct pronunciation
   - Test right-to-left languages (Arabic, Hebrew) â†’ Proper rendering
   - Test tonal languages (Mandarin, Vietnamese) â†’ Accurate tones

2. **Translation Quality**:
   - Technical terms preserved correctly
   - Cultural idioms adapted appropriately
   - Personal tone maintained
   - Data placeholders preserved

3. **Audio Quality**:
   - Natural speech rhythm per language
   - Proper name pronunciation (SSML tags)
   - Appropriate speech rate
   - Clear audio across languages

4. **User Experience**:
   - Language search/filter works smoothly
   - Voice samples play correctly
   - Preview briefing generated successfully
   - Language switch doesn't break app

---

## Accessibility

- Transcript always available alongside audio
- Visual language indicator on briefing cards
- Keyboard navigation for language selection
- Screen reader compatible language names (both native and English)

---

## Cost Optimization

- Cache translated scripts for common content
- Reuse voice samples across users
- Batch TTS requests where possible
- Monitor API usage per language
- Use cheaper models for preview generation

**Cost per briefing (non-English)**:
- Translation (Claude): $0.002
- TTS (Google): Free tier
- Total: ~$0.002/briefing
