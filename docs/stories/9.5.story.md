# Story 9.5: CSV Import Component

## Status

**Complete**

---

## Story

**As a** migrant tracking my finances,
**I want** to import my bank statement via CSV upload,
**so that** I can quickly add all my migration expenses without manual entry.

---

## Acceptance Criteria

1. CSV/Excel file upload component in finances page with drag-and-drop support
2. File validation: max 5MB, CSV/Excel formats only, max 100 transactions
3. Automatic column detection for date, description, and amount fields
4. Support for common bank statement formats (various date formats, currency symbols, negative amounts)
5. Parse CSV using Papa Parse library with error handling
6. Display preview of detected transactions before import
7. API route `/api/import-csv` handles file processing and returns categorized transactions
8. Integration with Gemini AI for automatic categorization
9. Deduplication logic prevents duplicate expenses (same date + amount within 24 hours)
10. Success/error feedback with import summary (imported, duplicates, errors)

---

## Tasks / Subtasks

- [x] **Task 1: Create CSV Import API Route** (AC: 7, 8)
  - [x] Create `/app/api/import-csv/route.ts` with POST handler
  - [x] Install Papa Parse: `npm install papaparse @types/papaparse`
  - [x] Implement file validation (size, type, required fields)
  - [x] Parse CSV with Papa Parse and auto-detect columns
  - [x] Extract transactions from parsed data (date, description, amount)
  - [x] Handle various amount formats (negative, parentheses, currency symbols, commas)
  - [x] Limit to 100 transactions per upload
  - [x] Return parsed transactions as JSON response

- [x] **Task 2: Integrate Gemini AI Categorization** (AC: 8)
  - [x] Import GoogleGenerativeAI from `@google/generative-ai`
  - [x] Create `categorizeBatch` function for 10 transactions at a time
  - [x] Build prompt with category definitions and transaction batch
  - [x] Call Gemini API with `gemini-2.5-flash` model
  - [x] Parse JSON response and map categories to transactions
  - [x] Handle errors with fallback to "miscellaneous" category
  - [x] Add confidence scores and reasoning to each categorization
  - [x] Process multiple batches with 100ms delay between calls

- [x] **Task 3: Create Bulk Import Convex Mutation** (AC: 9)
  - [x] Add `bulkImportExpenses` mutation to `convex/financial.ts`
  - [x] Accept array of categorized transactions with metadata
  - [x] Implement duplicate detection logic (same amount + date within 24h)
  - [x] Parse date strings to timestamps with error handling
  - [x] Calculate amountInDestination using exchange rate
  - [x] Insert expenses with AI categorization notes
  - [x] Return import summary with counts (imported, duplicates, errors)
  - [x] Include errorDetails array for failed transactions

- [x] **Task 4: Build CSV Import Modal Component** (AC: 1, 2, 6, 10)
  - [x] Create `components/finances/CSVImportModal.tsx`
  - [x] Implement 4-step wizard: upload → review → importing → complete
  - [x] File upload area with drag-and-drop (using native input)
  - [x] Display selected file name and size
  - [x] Show validation errors prominently
  - [x] Review step: scrollable transaction list with checkboxes
  - [x] Display AI category tags with confidence scores
  - [x] "Select All" / "Deselect All" functionality
  - [x] Show loading spinner during import
  - [x] Success screen with import statistics (imported, duplicates, errors)
  - [x] Display error details if any transactions failed
  - [x] Neo-brutalism styling consistent with TRIBE design

- [x] **Task 5: Integrate Modal into Finances Page** (AC: 1)
  - [x] Import CSVImportModal component
  - [x] Import Upload icon from lucide-react
  - [x] Add `showCSVImport` state
  - [x] Add "Import CSV" button next to "Add Expense"
  - [x] Render CSVImportModal conditionally when showCSVImport is true
  - [x] Pass corridor, budget, currency, and exchangeRate props
  - [x] Handle modal close to refresh expenses list

---

## Technical Implementation Notes

### API Route Handler
```typescript
// File: app/api/import-csv/route.ts
- Uses Papa Parse for CSV parsing with auto-header detection
- Detects common column names (case-insensitive)
- Handles various amount formats: "$1,234.56", "(123.45)", "€1.234,56"
- Gemini batching: 10 transactions per API call
- Rate limiting: 100ms delay between batches
- Returns categorized transactions with confidence scores
```

### Convex Mutation
```typescript
// File: convex/financial.ts - bulkImportExpenses
- Duplicate detection: same amount + date within 24-hour window
- Stores AI confidence and reasoning in notes field
- Atomic operation: processes all transactions in single mutation
- Returns detailed import summary for UI feedback
```

### Component Architecture
```typescript
// File: components/finances/CSVImportModal.tsx
- Multi-step wizard state machine
- Transaction selection with Set data structure
- Optimistic UI with loading states
- Error boundaries for each step
- Responsive design (mobile-first)
```

---

## Dependencies

- **Libraries**: papaparse, @google/generative-ai
- **Convex Functions**: financial.bulkImportExpenses
- **API Routes**: /api/import-csv
- **Related Stories**: 9.6 (AI Categorization), 9.1 (Budget Creation)

---

## Testing Notes

- Test CSV formats: standard bank exports, custom formats
- Test edge cases: missing columns, invalid dates, zero amounts
- Test deduplication: same transaction uploaded twice
- Test error handling: invalid file, API failures, parse errors
- Test UI states: loading, success, errors
- Test mobile responsiveness and drag-and-drop

---

## Performance Considerations

- File size limit: 5MB prevents memory issues
- Transaction limit: 100 per upload prevents timeout
- Batch processing: 10 transactions per Gemini call stays within rate limits
- Gemini free tier: 1,500 requests/day = 15,000 transactions/day capacity
- Client-side validation before API call reduces backend load
